<!DOCTYPE html><html><head>
      <title>Report</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="thông-tin-dự-án">Thông tin dự án </h1>
<h2 id="thông-tin-chung">Thông Tin Chung </h2>
<table>
<thead>
<tr>
<th>Thông tin</th>
<th>Nội dung</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Trường</strong></td>
<td>Đại học Khoa học Tự nhiên - ĐHQG TP.HCM</td>
</tr>
<tr>
<td><strong>Khoa</strong></td>
<td>Toán - Tin học</td>
</tr>
<tr>
<td><strong>Môn học</strong></td>
<td>Python cho Khoa học dữ liệu</td>
</tr>
<tr>
<td><strong>Đề tài</strong></td>
<td>House price prediction in Ho Chi Minh City</td>
</tr>
<tr>
<td><strong>Đường dẫn</strong></td>
<td><a href="https://github.com/tandao0909/python-for-ds-project">python-for-ds-project</a></td>
</tr>
</tbody>
</table>
<h2 id="danh-sách-thành-viên">Danh Sách Thành Viên </h2>
<table>
<thead>
<tr>
<th><strong>MSSV</strong></th>
<th><strong>Tên</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>22110063</td>
<td>Hồ Quốc Nhân Hòa</td>
</tr>
<tr>
<td>22110195</td>
<td>Đào Xuân Tân</td>
</tr>
<tr>
<td>22110202</td>
<td>Lý Quang Thắng</td>
</tr>
<tr>
<td>22110245</td>
<td>Lê Phú Trường</td>
</tr>
<tr>
<td>22110263</td>
<td>Trần Lê Hữu Vinh</td>
</tr>
</tbody>
</table>
<h2 id="mục-tiêu-dự-án">Mục tiêu dự án </h2>
<p>Dự án <strong>"House Price Prediction in Ho Chi Minh City"</strong> nhằm đạt được các mục tiêu chính sau:</p>
<ol>
<li>
<p><strong>Dự đoán giá bất động sản</strong>: Xây dựng mô hình học máy để dự đoán giá bất động sản tại TP. Hồ Chí Minh dựa trên các đặc trưng quan trọng như diện tích, số phòng ngủ, số tầng, vị trí, và các yếu tố liên quan khác. Ngoài ra, mô hình cũng cần đảm bảo độ chính xác cao, giúp người mua và nhà đầu tư có thêm thông tin trong việc định giá.</p>
</li>
<li>
<p><strong>Phân tích và hiểu biết về thị trường bất động sản</strong>: Khám phá và trực quan hóa các yếu tố ảnh hưởng lớn đến giá nhà, bao gồm khu vực, tiện ích, và tình trạng pháp lý. Đưa ra các nhận định về xu hướng giá cả tại TP. Hồ Chí Minh, từ đó cung cấp góc nhìn tổng quan cho các bên liên quan.</p>
</li>
<li>
<p><strong>Xử lý dữ liệu bất động sản thực tế</strong>: Thu thập, xử lý, và chuẩn hóa dữ liệu bất động sản từ các nguồn trực tuyến. Khắc phục vấn đề dữ liệu thiếu và bất thường thông qua các phương pháp xử lý tiên tiến, giúp cải thiện chất lượng dữ liệu và hiệu suất mô hình.</p>
</li>
<li>
<p><strong>Phát triển hệ thống hỗ trợ quyết định</strong>: Xây dựng công cụ dựa trên mô hình học máy, giúp người dùng dễ dàng kiểm tra và dự đoán giá bất động sản trong thời gian thực. Cung cấp giải pháp hữu ích cho cả người mua, người bán, và các nhà đầu tư trong lĩnh vực bất động sản.</p>
</li>
<li>
<p><strong>Nâng cao kỹ năng và kiến thức học thuật</strong>: Áp dụng các kiến thức và kỹ năng học được từ môn học Python cho Khoa học dữ liệu vào một dự án thực tế. Tiếp tục học hỏi và phát triển bản thân qua việc thực hiện các công việc phức tạp và đòi hỏi sự sáng tạo.</p>
</li>
</ol>
<h2 id="khuyến-nghị-về-việc-xem-bài-báo-cáo">Khuyến nghị về việc xem bài báo cáo </h2>
<p>Để có trải nghiệm tốt nhất khi đọc báo cáo, thầy/ các bạn nên xem ở báo cáo được lưu dưới dạng file HTML. Các bước thực hiện như sau:</p>
<ol>
<li>Mở Terminal hoặc Command Prompt và chạy lệnh sau để clone repository về máy:</li>
</ol>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> clone https://github.com/tandao0909/python-for-ds-project.git
</code></pre><ol start="2">
<li>Mở file <code>Report.html</code> trong trình duyệt web để xem báo cáo.</li>
</ol>
<hr>
<h1 id="table-of-contents">Table of contents </h1>
<ul>
<li><a href="#th%C3%B4ng-tin-d%E1%BB%B1-%C3%A1n">Thông tin dự án</a>
<ul>
<li><a href="#th%C3%B4ng-tin-chung">Thông Tin Chung</a></li>
<li><a href="#danh-s%C3%A1ch-th%C3%A0nh-vi%C3%AAn">Danh Sách Thành Viên</a></li>
<li><a href="#m%E1%BB%A5c-ti%C3%AAu-d%E1%BB%B1-%C3%A1n">Mục tiêu dự án</a></li>
<li><a href="#khuy%E1%BA%BFn-ngh%E1%BB%8B-v%E1%BB%81-vi%E1%BB%87c-xem-b%C3%A0i-b%C3%A1o-c%C3%A1o">Khuyến nghị về việc xem bài báo cáo</a></li>
</ul>
</li>
<li><a href="#table-of-contents">Table of contents</a></li>
<li><a href="#i-data-crawling-and-preprocessing">I. Data Crawling and Preprocessing</a>
<ul>
<li><a href="#thu-th%E1%BA%ADp-d%E1%BB%AF-li%E1%BB%87u">Thu thập dữ liệu</a>
<ul>
<li><a href="#m%E1%BB%A5c-ti%C3%AAu">Mục tiêu</a></li>
<li><a href="#quy-tr%C3%ACnh-thu-th%E1%BA%ADp-d%E1%BB%AF-li%E1%BB%87u">Quy trình thu thập dữ liệu</a></li>
</ul>
</li>
<li><a href="#chuy%E1%BB%83n-%C4%91%E1%BB%95i-d%E1%BB%AF-li%E1%BB%87u">Chuyển đổi dữ liệu</a>
<ul>
<li><a href="#m%E1%BB%A5c-ti%C3%AAu-1">Mục tiêu</a></li>
<li><a href="#x%E1%BB%AD-l%C3%BD-%C4%91%E1%BB%8Bnh-d%E1%BA%A1ng-c%E1%BB%A7a-data-frame">Xử lý định dạng của Data Frame</a></li>
<li><a href="#tr%C3%ADch-xu%E1%BA%A5t-d%E1%BB%AF-li%E1%BB%87u-t%E1%BB%AB-c%E1%BB%99t-description-v%C3%A0-title">Trích xuất dữ liệu từ cột <code>Description</code> và <code>Title</code></a>
<ul>
<li><a href="#t%E1%BB%95ng-quan-%C3%BD-t%C6%B0%E1%BB%9Fng">Tổng quan, ý tưởng</a></li>
<li><a href="#x%E1%BB%AD-l%C3%BD-c%C3%A1c-d%E1%BB%AF-li%E1%BB%87u-s%E1%BB%91">Xử lý các dữ liệu số</a></li>
<li><a href="#t%E1%BA%A1o-ra-c%C3%A1c-c%E1%BB%99t-d%E1%BB%AF-li%E1%BB%87u-m%E1%BB%9Bi-h%E1%BB%AFu-%C3%ADch-cho-b%C3%A0i-to%C3%A1n">Tạo ra các cột dữ liệu mới hữu ích cho bài toán</a></li>
</ul>
</li>
<li><a href="#tr%C3%ADch-xu%E1%BA%A5t-%C4%91%E1%BA%B7t-tr%C6%B0ng-v%E1%BB%81-%C4%91%E1%BB%8Ba-ch%E1%BB%89">Trích xuất đặt trưng về địa chỉ</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ii-eda-and-feature-engineering">II. EDA and Feature Engineering</a>
<ul>
<li><a href="#1-khai-b%C3%A1o-th%C6%B0-vi%E1%BB%87n-v%C3%A0-thi%E1%BA%BFt-l%E1%BA%ADp">1. Khai báo thư viện và thiết lập</a></li>
<li><a href="#2-kh%C3%A1m-ph%C3%A1-d%E1%BB%AF-li%E1%BB%87u">2. Khám phá dữ liệu</a>
<ul>
<li><a href="#21-t%E1%BB%95ng-quan-v%E1%BB%81-d%E1%BB%AF-li%E1%BB%87u">2.1. Tổng quan về dữ liệu</a>
<ul>
<li><a href="#211-nh%E1%BA%ADn-x%C3%A9t-v%E1%BB%81-d%E1%BB%AF-li%E1%BB%87u-ban-%C4%91%E1%BA%A7u">2.1.1. Nhận xét về dữ liệu ban đầu</a></li>
<li><a href="#212-t%C3%B3m-t%E1%BA%AFt-kh%E1%BA%A3-n%C4%83ng-s%E1%BB%AD-d%E1%BB%A5ng-d%E1%BB%AF-li%E1%BB%87u">2.1.2. Tóm tắt khả năng sử dụng dữ liệu</a></li>
</ul>
</li>
<li><a href="#22-ph%C3%A2n-t%C3%ADch-ph%C3%A2n-ph%E1%BB%91i-c%C3%A1c-bi%E1%BA%BFn-%C4%91%E1%BB%8Bnh-l%C6%B0%E1%BB%A3ng">2.2. Phân tích phân phối các biến định lượng</a></li>
<li><a href="#23-t%C3%ACnh-tr%E1%BA%A1ng-d%E1%BB%AF-li%E1%BB%87u-thi%E1%BA%BFu">2.3. Tình trạng dữ liệu thiếu</a></li>
<li><a href="#24-ph%C3%A2n-t%C3%ADch-theo-th%E1%BB%9Di-gian">2.4. Phân tích theo thời gian</a></li>
<li><a href="#25-c%C3%A1c-ph%C3%A1t-hi%E1%BB%87n-ch%C3%ADnh">2.5. Các phát hiện chính</a></li>
</ul>
</li>
<li><a href="#3-x%E1%BB%AD-l%C3%BD-v%C3%A0-l%C3%A0m-s%E1%BA%A1ch-d%E1%BB%AF-li%E1%BB%87u-v%E1%BB%9Bi-dataprocessingpy">3. Xử lý và làm sạch dữ liệu với <code>DataProcessing.py</code></a>
<ul>
<li><a href="#31-khai-b%C3%A1o-th%C6%B0-vi%E1%BB%87n">3.1. Khai báo thư viện</a></li>
<li><a href="#32-datacleaner-class">3.2. <code>DataCleaner</code> class</a>
<ul>
<li><a href="#321-ch%E1%BB%A9c-n%C4%83ng-ch%C3%ADnh-c%E1%BB%A7a-datacleaner">3.2.1. Chức năng chính của <code>DataCleaner</code></a></li>
<li><a href="#322-c%C3%A1c-ph%C6%B0%C6%A1ng-th%E1%BB%A9c-ch%C3%ADnh-c%E1%BB%A7a-datacleaner">3.2.2. Các phương thức chính của <code>DataCleaner</code></a></li>
</ul>
</li>
<li><a href="#33-c%C3%A1c-h%C3%A0m-kh%C3%A1c">3.3. Các hàm khác</a></li>
<li><a href="#34-ch%E1%BA%A1y-ch%C6%B0%C6%A1ng-tr%C3%ACnh">3.4. Chạy chương trình</a></li>
</ul>
</li>
<li><a href="#4-x%E1%BB%AD-l%C3%BD-tr%E1%BB%B1c-quan-h%C3%B3a-d%E1%BB%AF-li%E1%BB%87u-v%C3%A0-feature-engineering-v%E1%BB%9Bi-visualizepy">4. Xử lý, trực quan hóa dữ liệu và Feature Engineering với <code>Visualize.py</code></a>
<ul>
<li><a href="#41-khai-b%C3%A1o-th%C6%B0-vi%E1%BB%87n">4.1. Khai báo thư viện</a></li>
<li><a href="#42-l%E1%BB%8Dc-t%E1%BB%8Da-%C4%91%E1%BB%99-theo-l%C3%A3nh-th%E1%BB%95-vi%E1%BB%87t-nam-v%E1%BB%9Bi-h%C3%A0m-check_coordinates_in_vietnam">4.2. Lọc tọa độ theo lãnh thổ Việt Nam với hàm <code>check_coordinates_in_vietnam</code></a>
<ul>
<li><a href="#421-tham-s%E1%BB%91-%C4%91%E1%BA%A7u-v%C3%A0o">4.2.1. Tham số đầu vào</a></li>
<li><a href="#422-c%C3%A1c-b%C6%B0%E1%BB%9Bc-x%E1%BB%AD-l%C3%BD-ch%C3%ADnh-trong-h%C3%A0m">4.2.2. Các bước xử lý chính trong hàm</a></li>
</ul>
</li>
<li><a href="#43-t%E1%BA%A1o-b%E1%BA%A3n-%C4%91%E1%BB%93-ph%C3%A2n-ph%E1%BB%91i-gi%C3%A1-b%E1%BA%A5t-%C4%91%E1%BB%99ng-s%E1%BA%A3n-v%E1%BB%9Bi-h%C3%A0m-visualize_real_estate_price">4.3. Tạo bản đồ phân phối giá bất động sản với hàm <code>visualize_real_estate_price</code></a>
<ul>
<li><a href="#431-realestatevisualizerprice-class">4.3.1. <code>RealEstateVisualizerPrice</code> class</a></li>
<li><a href="#432-h%C3%A0m-visualize_real_estate_price">4.3.2. Hàm <code>visualize_real_estate_price</code></a></li>
</ul>
</li>
<li><a href="#44-t%E1%BA%A1o-b%E1%BA%A3n-%C4%91%E1%BB%93-ph%C3%A2n-c%E1%BB%A5m-v%C3%A0-feature-engineering-v%E1%BB%9Bi-h%C3%A0m-visualize_real_estate_clusters">4.4. Tạo bản đồ phân cụm và Feature Engineering với hàm <code>visualize_real_estate_clusters</code></a>
<ul>
<li><a href="#441-realestatevisualizerclusters-class">4.4.1. <code>RealEstateVisualizerClusters</code> class</a></li>
<li><a href="#442-h%C3%A0m-visualize_real_estate_clusters">4.4.2. Hàm <code>visualize_real_estate_clusters</code></a></li>
</ul>
</li>
<li><a href="#45-t%E1%BA%A1o-b%E1%BA%A3n-%C4%91%E1%BB%93-heatmap-d%E1%BB%B1a-tr%C3%AAn-gi%C3%A1-b%E1%BA%A5t-%C4%91%E1%BB%99ng-s%E1%BA%A3n-v%E1%BB%9Bi-h%C3%A0m-visualize_real_estate_price_heatmap">4.5. Tạo bản đồ Heatmap dựa trên giá bất động sản với hàm <code>visualize_real_estate_price_heatmap</code></a>
<ul>
<li><a href="#451-realestatevisualizerheatmap-class">4.5.1. <code>RealEstateVisualizerHeatmap</code> class</a></li>
<li><a href="#452-h%C3%A0m-visualize_real_estate_price_heatmap">4.5.2. Hàm <code>visualize_real_estate_price_heatmap</code></a></li>
</ul>
</li>
<li><a href="#46-ch%E1%BA%A1y-ch%C6%B0%C6%A1ng-tr%C3%ACnh">4.6. Chạy chương trình</a></li>
</ul>
</li>
<li><a href="#5-feature-selection-v%E1%BB%9Bi-featureselectionpy">5. Feature Selection với <code>FeatureSelection.py</code></a>
<ul>
<li><a href="#51-khai-b%C3%A1o-th%C6%B0-vi%E1%BB%87n">5.1. Khai báo thư viện</a></li>
<li><a href="#52-featureselector-class">5.2. <code>FeatureSelector</code> class</a></li>
<li><a href="#53-ph%C6%B0%C6%A1ng-ph%C3%A1p-variance-threshold">5.3. Phương pháp Variance Threshold</a></li>
<li><a href="#54-ph%C6%B0%C6%A1ng-ph%C3%A1p-select-k-best">5.4. Phương pháp Select K Best</a></li>
<li><a href="#55-ph%C6%B0%C6%A1ng-ph%C3%A1p-gridsearchcv">5.5. Phương pháp GridSearchCV</a></li>
<li><a href="#56-ph%C6%B0%C6%A1ng-ph%C3%A1p-randomizedsearchcv">5.6. Phương pháp RandomizedSearchCV</a></li>
<li><a href="#57-ch%E1%BA%A1y-ch%C6%B0%C6%A1ng-tr%C3%ACnh">5.7. Chạy chương trình</a>
<ul>
<li><a href="#571-variance-threshold">5.7.1. Variance Threshold</a></li>
<li><a href="#572-select-k-best">5.7.2. Select K Best</a></li>
<li><a href="#573-gridsearchcv">5.7.3. GridSearchCV</a></li>
<li><a href="#574-randomizedsearchcv">5.7.4. RandomizedSearchCV</a></li>
</ul>
</li>
<li><a href="#58-k%E1%BA%BFt-qu%E1%BA%A3-ch%E1%BB%8Dn-l%E1%BB%8Dc-%C4%91%E1%BA%B7c-tr%C6%B0ng">5.8. Kết quả chọn lọc đặc trưng</a></li>
</ul>
</li>
<li><a href="#6-t%C3%A1ch-t%E1%BA%ADp-d%E1%BB%AF-li%E1%BB%87u">6. Tách tập dữ liệu</a></li>
<li><a href="#7-x%C3%A2y-d%E1%BB%B1ng-pipeline-v%E1%BB%9Bi-housingpipelinepy">7. Xây dựng pipeline với <code>HousingPipeline.py</code></a></li>
</ul>
</li>
<li><a href="#iii-model-training">III. Model Training</a></li>
<li><a href="#iv-model-evalution">IV. Model Evalution</a>
<ul>
<li><a href="#gi%E1%BA%A3i-th%C3%ADch-c%C3%A1c-metric">Giải thích các metric</a></li>
<li><a href="#k%E1%BA%BFt-qu%E1%BA%A3">Kết quả</a></li>
</ul>
</li>
<li><a href="#v-conclusion">V. Conclusion</a></li>
</ul>
<hr>
<h1 id="i-data-crawling-and-preprocessing">I. Data Crawling and Preprocessing </h1>
<h2 id="thu-thập-dữ-liệu">Thu thập dữ liệu </h2>
<h3 id="mục-tiêu">Mục tiêu </h3>
<p>Thu thập dữ liệu cần thiết phục vụ cho bài toán từ trang web <a href="https://batdongsan.vn">https://batdongsan.vn</a>. Tuy nhiên bài toán đặt ra chỉ thu thập dữ liệu các bài đăng bất động sản trong khu vực thành phố Hồ Chí Minh nên nhóm thực hiện thay đổi đường dẫn để thu thập dư liệu thành <a href="https://batdongsan.vn/filter?options=on&amp;gia_tri_tinh_chon=1&amp;priceMin=0&amp;priceMax=400&amp;areaMin=0&amp;areaMax=500&amp;">https://batdongsan.vn/filter?options=on&amp;gia_tri_tinh_chon=1&amp;priceMin=0&amp;priceMax=400&amp;areaMin=0&amp;areaMax=500&amp;</a> - chỉ bao gồm các bất động sản:</p>
<ul>
<li>Thuộc khu vực thành phố Hồ Chí Minh</li>
<li>Mức giá từ 0 triệu đến 40 tỷ</li>
<li>Diện tích từ 0 đến 500m2</li>
</ul>
<p>Kết quả của quá trình thu thập dữ liệu sẽ là một file csv trong đó chứa thông tin của các bất động sản bao gồm:</p>
<ul>
<li>Date: Ngày đăng tin</li>
<li>Type: Loại tin</li>
<li>ID: Mã bài đăng</li>
<li>Title: Tiêu đề bài đăng</li>
<li>Location1: Địa chỉ 1 - Quận, Thành Phố</li>
<li>Location2: Địa chỉ 2 - tên đường, phường... (nằm trong chi tiết bài đăng)</li>
<li>Description: Mô tả về bất động sản</li>
<li>Area: Diện tích</li>
<li>Bedrooms: Số phòng ngủ</li>
<li>Legal: Pháp lý</li>
<li>WC: Số phòng vệ sinh</li>
<li>House orientation: Hướng nhà</li>
<li>Furniture: Tình trạng nội thất</li>
<li>Price: Mức giá (Biến mục tiêu)</li>
</ul>
<p>Yêu cầu của đầu ra:</p>
<ul>
<li>Chứa đầy đủ những thông tin cần thiết.</li>
<li>Dữ liệu được làm sạch phần nào, dễ đọc, và chính xác.</li>
<li>Tốc độ thu thập dữ liệu phải nhanh, ít tốn tài nguyên.</li>
</ul>
<h3 id="quy-trình-thu-thập-dữ-liệu">Quy trình thu thập dữ liệu </h3>
<p>Truy cập vào đường dẫn được cung cấp <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">→</span></span></span></span> Lấy ra đường dẫn dẫn đến chi tiết của các bài post, đồng thời là Location 1 (thông tin về quận của bất động sản, trong chi tiết bài post sẽ không có) <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">→</span></span></span></span> Duyệt qua các đường dẫn đã thu thập được, trích xuất thông tin chi tiết từ các bài đăng <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">→</span></span></span></span> Tổng hợp, chuẩn hóa và xuất ra file csv.</p>
<p>Quy trình trích xuất thông tin sử dụng một số công cụ quen thuộc trong việc crawl data như: <code>requests</code>, <code>BeautifulSoup</code>, <code>regex</code>.</p>
<p>Tuy nhiên việc thu thập từng trang như vậy chưa thực sự tối ưu về mặt thời gian, nên nhóm quyết định chạy script trên 10 luồng cùng một lúc bằng thư viện <code>ThreadPoolExecutor</code>.</p>
<p><strong>Cách script hoạt động:</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">get_data</span><span class="token punctuation">(</span>start_page<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Crawl data from the website starting from the given page.

    Args:
        start_page (int): The starting page number.

    Returns:
        DataFrame: A DataFrame containing the crawled data from a specific page.
    """</span>
    <span class="token comment"># Define the structure of the DataFrame</span>
    <span class="token comment"># Location 1 is taken from the main page post interface, Location 2 is taken from the detailed post</span>
    report <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">,</span> <span class="token string">'Type'</span><span class="token punctuation">,</span> <span class="token string">'ID'</span><span class="token punctuation">,</span> <span class="token string">'Title'</span><span class="token punctuation">,</span> <span class="token string">'Location1'</span><span class="token punctuation">,</span> <span class="token string">'Location2'</span><span class="token punctuation">,</span> <span class="token string">'Description'</span><span class="token punctuation">,</span> <span class="token string">'Area'</span><span class="token punctuation">,</span> <span class="token string">'Bedrooms'</span><span class="token punctuation">,</span> <span class="token string">'Legal'</span><span class="token punctuation">,</span> <span class="token string">'WC'</span><span class="token punctuation">,</span> <span class="token string">'House orientation'</span><span class="token punctuation">,</span> <span class="token string">'Furniture'</span><span class="token punctuation">,</span> <span class="token string">'Price'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># Perform data crawling from start_page to start_page + n_iter</span>
    <span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>start_page<span class="token punctuation">,</span> start_page <span class="token operator">+</span> n_iter<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"------Start crawl page </span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">------"</span></span><span class="token punctuation">)</span>
        <span class="token comment"># Get basic information of 25 posts on the interface of page i</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>url<span class="token punctuation">}</span></span><span class="token string">page=</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
            soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>
            <span class="token comment"># Select the elements containing the links to the posts</span>
            elements <span class="token operator">=</span> soup<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'#danhmuc &gt; div:nth-of-type(2) &gt; div:nth-of-type(1) &gt; div:nth-of-type(2) &gt; a'</span><span class="token punctuation">)</span>
            <span class="token comment"># Extract and clean the location1 information from the selected elements (location 1 includes district and city names)</span>
            location1 <span class="token operator">=</span> <span class="token punctuation">[</span>item<span class="token punctuation">.</span>text<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> item <span class="token keyword keyword-in">in</span> soup<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'.card-content .description'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            location1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>item<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> item <span class="token keyword keyword-in">in</span> location1<span class="token punctuation">]</span>
        <span class="token keyword keyword-except">except</span> requests<span class="token punctuation">.</span>RequestException <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error fetching page </span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-continue">continue</span>
        <span class="token comment"># Extract the links of the posts from elements</span>
        links <span class="token operator">=</span> <span class="token punctuation">[</span>element<span class="token punctuation">[</span><span class="token string">'href'</span><span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> element <span class="token keyword keyword-in">in</span> elements<span class="token punctuation">]</span>
        n <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>links<span class="token punctuation">)</span>
        data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># Crawl data from each post</span>
        <span class="token keyword keyword-for">for</span> j <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                post_response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>links<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
                post_response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
                post_soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>post_response<span class="token punctuation">.</span>text<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>
                <span class="token comment"># Extract the title</span>
                title <span class="token operator">=</span> post_soup<span class="token punctuation">.</span>select_one<span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
                <span class="token comment"># Extract the location 2 (street name, ward)</span>
                location2 <span class="token operator">=</span> post_soup<span class="token punctuation">.</span>select_one<span class="token punctuation">(</span><span class="token string">'.footer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                <span class="token comment"># Extract the description of the post</span>
                description <span class="token operator">=</span> post_soup<span class="token punctuation">.</span>select_one<span class="token punctuation">(</span><span class="token string">'#more1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># Extract the params (Area, Bedroom, Legal, WC, House orientation, Furniture, Price) of the post</span>
                params <span class="token operator">=</span> get_params<span class="token punctuation">(</span>post_soup<span class="token punctuation">.</span>select_one<span class="token punctuation">(</span><span class="token string">'.box-characteristics'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
                <span class="token comment"># Extract the post information (Date, Type, ID)</span>
                post_info <span class="token operator">=</span> <span class="token punctuation">[</span>item<span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> item <span class="token keyword keyword-in">in</span> post_soup<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'.row.mat-42 .box-text .col .value'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                <span class="token comment"># Concatenate all extracted information into a single list</span>
                tmp <span class="token operator">=</span> post_info <span class="token operator">+</span> <span class="token punctuation">[</span>title<span class="token punctuation">,</span> location1<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> location2<span class="token punctuation">,</span> description<span class="token punctuation">]</span> <span class="token operator">+</span> params
                <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\tCrawled post </span><span class="token interpolation"><span class="token punctuation">{</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>n<span class="token punctuation">}</span></span><span class="token string"> on page </span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-except">except</span> requests<span class="token punctuation">.</span>RequestException <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error fetching post </span><span class="token interpolation"><span class="token punctuation">{</span>links<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                <span class="token keyword keyword-continue">continue</span>
            <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error extracting data from post </span><span class="token interpolation"><span class="token punctuation">{</span>links<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                <span class="token keyword keyword-continue">continue</span>
            <span class="token comment"># Append the extracted information to the data list</span>
            data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
        <span class="token comment"># If data is not empty, convert it to a DataFrame and save it to a CSV file</span>
        <span class="token keyword keyword-if">if</span> data<span class="token punctuation">:</span>
            <span class="token comment"># Convert list data of a page to a DataFrame and save it to a CSV file</span>
            matrix_data <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">[</span>item <span class="token keyword keyword-for">for</span> item <span class="token keyword keyword-in">in</span> data<span class="token punctuation">]</span><span class="token punctuation">)</span>
            data_page <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>matrix_data<span class="token punctuation">,</span> columns<span class="token operator">=</span>report<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>
            data_page<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'data/page</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">.csv'</span></span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">"\t"</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            <span class="token comment"># Concatenate the data of the page to the report</span>
            report <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>report<span class="token punctuation">,</span> data_page<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            report<span class="token punctuation">.</span>set_index<span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"------Page</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string"> - Done!------\n\n"</span></span><span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> report
</code></pre><p>Về cơ bản đoạn script bên trên sẽ được sử dụng để thu thấp dữ liệu của <code>n_iter</code> trang, với trang bắt đầu crawl là <code>start_page</code>.</p>
<p>Giao diện của một trang sẽ như sau:</p>
<p><img src="images/page_screen.png" alt="alt text"></p>
<p>Trong một trang như vậy, script sẽ trích xuất hai đối tượng:</p>
<ul>
<li><code>elements</code> các box của post <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">→</span></span></span></span> từ đây ta có thể lấy được đường dẫn đến các bài đăng.</li>
<li><code>location1</code> - địa chỉ chung của bài bất động sản (quận, thành phố), thông tin này chỉ được cung cấp ở giao diện page, không xuất hiện trong giao diện chi tiết bài đăng.</li>
</ul>
<p>Sau khi đó được link của những bài post xuất hiện trong trang, ta sẽ tiến hành trích xuất dữ liệu như: <code>Date, Type, ID, Title, Location2, Description, Area, Bedrooms, Legal, WC, House orientation, Furniture, Price</code> các bài đăng chi tiết:</p>
<p><img src="images/screen_post.png" alt="alt text"></p>
<p>Riêng với dữ liệu được lưu trong trong element <code>box-characteristics</code> (html) thì sau khi đưa về dạng text, nhóm thiết kế thêm một bộ lọc để trích xuất các thông tin cần thiết về thông số của căn nhà trong đoạn text này (element này ở các bài post khác nhau có thể khác nhau, có bài có Hướng nhà, Hướng ban công, có bài thậm chí còn không có Số phòng ngủ, WC). Việc trích xuất các thông tin từ đoạn text do hàm <code>get_params</code> đảm nhận.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">get_params</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Extract parameters from the given text using regular expressions.

    Args:
        text (str): The text to extract parameters from.

    Returns:
        list: A list of extracted parameters (Area, Bedroom, Legal, WC, House orientation, Furniture, Price).
    """</span>
    <span class="token comment"># Regular expressions pattern for extracting parameters</span>
    reg_pattern <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"Area"</span><span class="token punctuation">:</span> <span class="token string">"Diện tích\s+(\d+)"</span><span class="token punctuation">,</span>
        <span class="token string">"Bedroom"</span><span class="token punctuation">:</span> <span class="token string">"Số phòng ngủ\s+(\d+)"</span><span class="token punctuation">,</span>
        <span class="token string">"Legal"</span><span class="token punctuation">:</span> <span class="token string">"Pháp lý\s+([^\n]+)"</span><span class="token punctuation">,</span>
        <span class="token string">'WC'</span><span class="token punctuation">:</span> <span class="token string">"Số toilet\s+(\d+)"</span><span class="token punctuation">,</span>
        <span class="token string">'House orientation'</span><span class="token punctuation">:</span> <span class="token string">"Hướng nhà\n+\s+(.+)"</span><span class="token punctuation">,</span>
        <span class="token string">"Furniture"</span><span class="token punctuation">:</span> <span class="token string">"Nội thất\n+\s+(.+)"</span><span class="token punctuation">,</span>
        <span class="token string">"Price"</span><span class="token punctuation">:</span> <span class="token string">"Mức giá\n+\s+(.+)"</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># Perform the search for information according to the given pattern, if not found, return np.nan</span>
    params <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-for">for</span> name <span class="token keyword keyword-in">in</span> reg_pattern<span class="token punctuation">:</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            params<span class="token punctuation">.</span>append<span class="token punctuation">(</span>re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r"{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>reg_pattern<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-except">except</span><span class="token punctuation">:</span>
            params<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> params
</code></pre><p><code>get_params</code> nhận vào một đoạn text sau đó sử dụng <code>regex</code> để trích xuất thông tin cần thiết: <code>Area, Bedroom, Legal, WC, House orientation, Furniture, Price</code>. Nếu thông tin nào bị khuyết thì điền bằng <code>nan</code>.</p>
<p>Sau khi đã hoàn tất tất cả các qui trình trên thì script sẽ chuyển data thu thập được trong một trang thành DataFrame, lưu lại dưới dạng <code>page*.csv</code>. Sau đó gộp vào DataFrame <code>report</code> - chứa dữ liệu cuối cùng cho quá trình cào.</p>
<p>Tuy nhiên như đã đề cập ở trên, việc cào từng trang như vậy vẫn chưa thực sự tối ưu về mặt thời gian. Nên ta sử dụng đa luồng để giải quyết vấn đề này</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Create a ThreadPoolExecutor with 10 threads to crawl data faster</span>
    <span class="token keyword keyword-with">with</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> executor<span class="token punctuation">:</span>
        <span class="token comment"># Submit tasks to the executor</span>
        futures <span class="token operator">=</span> <span class="token punctuation">[</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>get_data<span class="token punctuation">,</span> start_page<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> start_page <span class="token keyword keyword-in">in</span> num_pages<span class="token punctuation">]</span>
        <span class="token comment"># Collect results from the futures</span>
        list_report <span class="token operator">=</span> <span class="token punctuation">[</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> future <span class="token keyword keyword-in">in</span> futures<span class="token punctuation">]</span>

</code></pre><p>Đoạn code trên tạo một <code>ThreadPoolExecutor</code> với 10 luồng. Sau đó, gửi các tác vụ thu thập dữ liệu <code>get_data</code> cho từng trang bắt đầu trong <code>num_pages</code> đến nhóm luồng này. Mỗi tác vụ được gửi dưới dạng một future. Cuối cùng, nó thu thập kết quả từ các future này và lưu trữ chúng trong danh sách list_report.</p>
<p>Nhóm tiền hành crawl data trên 500 trang trên 10 luồng thì <code>num_pages</code> (list lưu <code>start_page</code> cho từng luồng) và <code>num_iter</code> (quy định số trang mà mỗi luồng sẽ cào) sẽ được set như sau:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># List of starting pages for each thread</span>
num_pages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">51</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">151</span><span class="token punctuation">,</span><span class="token number">201</span><span class="token punctuation">,</span><span class="token number">251</span><span class="token punctuation">,</span><span class="token number">301</span><span class="token punctuation">,</span><span class="token number">351</span><span class="token punctuation">,</span><span class="token number">401</span><span class="token punctuation">,</span><span class="token number">451</span><span class="token punctuation">]</span>
<span class="token comment"># Number of iterations (pages) to crawl per thread</span>
n_iter <span class="token operator">=</span> <span class="token number">50</span>
</code></pre><p>Sau đó script thực hiện concat tất cả DataFrame trong <code>list__report</code> và lưu lại dưới dạng file csv</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>    <span class="token comment"># Concatenate all results into a single DataFrame</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>list_report<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># Save the final DataFrame to a CSV file</span>
    df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'raw_data.csv'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
</code></pre><h2 id="chuyển-đổi-dữ-liệu">Chuyển đổi dữ liệu </h2>
<h3 id="mục-tiêu-1">Mục tiêu </h3>
<p>Sau khi mà cào dữ liệu từ web xong, chúng tôi tiến hành chuyển hóa dữ liệu thô thế này:</p>
<table>
<thead>
<tr>
<th>Unnamed: 0</th>
<th>Date</th>
<th>Type</th>
<th>ID</th>
<th>Title</th>
<th>Location1</th>
<th>Location2</th>
<th>Description</th>
<th>Area</th>
<th>Bedrooms</th>
<th>Legal</th>
<th>WC</th>
<th>House orientation</th>
<th>Furniture</th>
<th>Price</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>22/07/2024</td>
<td>Tin Thường</td>
<td>115827</td>
<td>Bán nhà 2.6 tỷ Lý Thường Kiệt Q10, NHÀ ĐẸP 3 Tầng</td>
<td>Quận 10, Hồ Chí Minh</td>
<td>Đường Lý Thường Kiệt, 14</td>
<td>+ Kết cấu: Nhà 3 tầng, 3WC, có thể ở ngay.</td>
<td>16</td>
<td>4.0</td>
<td>Sổ đỏ/ Sổ hồng</td>
<td>3.0</td>
<td>NaN</td>
<td>NaN</td>
<td>2 tỷ 600 triệu</td>
</tr>
<tr>
<td>3</td>
<td>22/07/2024</td>
<td>Tin Thường</td>
<td>115833</td>
<td>Nhà Quận 6 Chỉ 3 Tỷ - DTSD &gt;150m² - 5 TẦNG BTC</td>
<td>Quận 6, Hồ Chí Minh</td>
<td>Phường 14, Quận 6, Hồ Chí Minh</td>
<td>Nhà Quận 6 Chỉ 3 Tỷ - DTSD &gt;150m² - 5 TẦNG BTC</td>
<td>32</td>
<td>4.0</td>
<td>Sổ đỏ/ Sổ hồng</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>3 tỷ</td>
</tr>
<tr>
<td>4</td>
<td>22/07/2024</td>
<td>Tin Thường</td>
<td>115834</td>
<td>Bán nhà HẺM XE HƠI TRÁNH TÂN HOÁ, chỉ 4.6 TỶ,</td>
<td>Quận 6, Hồ Chí Minh</td>
<td>Đường Tân Hóa, 10</td>
<td>Bán nhà HẺM XE HƠI TRÁNH TÂN HOÁ, chỉ 4.6 TỶ,</td>
<td>38</td>
<td>NaN</td>
<td>Sổ đỏ/ Sổ hồng</td>
<td>4.0</td>
<td>NaN</td>
<td>NaN</td>
<td>4 tỷ 600 triệu</td>
</tr>
</tbody>
</table>
<p>Thành một dữ liệu sạch, sử dụng tốt như thế này:</p>
<table>
<thead>
<tr>
<th>id</th>
<th>price</th>
<th>area</th>
<th>bedrooms</th>
<th>wc</th>
<th>n_floors</th>
<th>car_place</th>
<th>house_orientation</th>
<th>furniture</th>
<th>facade</th>
<th>legal</th>
<th>street</th>
<th>district</th>
<th>type</th>
<th>date</th>
</tr>
</thead>
<tbody>
<tr>
<td>115827</td>
<td>2.6</td>
<td>16</td>
<td>4.0</td>
<td>3.0</td>
<td>3.0</td>
<td>False</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>sổ đỏ/ sổ hồng</td>
<td>lý thường kiệt</td>
<td>quận 10</td>
<td>tin thường</td>
<td>22/07/2024</td>
</tr>
<tr>
<td>115833</td>
<td>3.0</td>
<td>32</td>
<td>4.0</td>
<td>NaN</td>
<td>5.0</td>
<td>True</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>sổ đỏ/ sổ hồng</td>
<td>NaN</td>
<td>quận 6</td>
<td>tin thường</td>
<td>22/07/2024</td>
</tr>
<tr>
<td>115834</td>
<td>4.6</td>
<td>38</td>
<td>3.0</td>
<td>4.0</td>
<td>3.0</td>
<td>True</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>sổ đỏ/ sổ hồng</td>
<td>tân hóa</td>
<td>quận 6</td>
<td>tin thường</td>
<td>22/07/2024</td>
</tr>
</tbody>
</table>
<h3 id="xử-lý-định-dạng-của-data-frame">Xử lý định dạng của Data Frame </h3>
<p>Đầu tiên ta đập vào mắt ta là một cột vô dụng mang tên <code>Unnamed: 0</code>, nó là một cột index dư thừa, nên sẽ được loại bỏ ngay trong bước đầu tiên. Sau đó thì ta tiến hành xử lý chuẩn hóa tên các cột trong Data Frame, đưa các tên về chữ thường và nếu có 2 từ trở lên sẽ được nối với nhau bằng <code>_</code>. Hơn nữa, với mỗi cột ta đều chuẩn hóa dữ liệu không phải số thành chữ thường hết. Tất cả các bước sau được gói gọn trong hàm:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">process_df_format</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Process a DataFrame by converting column names to snake_case and converting 
    all string values in object columns to lowercase.
    """</span>
    <span class="token keyword keyword-if">if</span> <span class="token string">"Unnamed: 0"</span> <span class="token keyword keyword-in">in</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        df <span class="token operator">=</span> df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token string">'Unnamed: 0'</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    df<span class="token punctuation">.</span>columns <span class="token operator">=</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>
    object_columns <span class="token operator">=</span> df<span class="token punctuation">.</span>select_dtypes<span class="token punctuation">(</span>include<span class="token operator">=</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>columns
    df<span class="token punctuation">[</span>object_columns<span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span>object_columns<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword keyword-lambda">lambda</span> col<span class="token punctuation">:</span> col<span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> df
</code></pre><h3 id="trích-xuất-dữ-liệu-từ-cột-description-và-title">Trích xuất dữ liệu từ cột <code>Description</code> và <code>Title</code> </h3>
<h4 id="tổng-quan-ý-tưởng">Tổng quan, ý tưởng </h4>
<p>Đối với bài toán hồi quy dự đoán giá nhà dựa vào các đặc trưng phổ biến như <em>diện tích, số phòng ngủ, số phòng tắm, số tầng,...</em> nhưng trong bộ dữ liệu thô lại thiếu đi quá nhiều do tính chất của trang web. Một vài post sẽ cho người đăng viết mô tả về căn nhà (trong đó có thể gồm các thông tin trên), nhưng người dùng lại không hề nhập tay vào ô <em>số phòng ngủ, số toilet, ...</em>. Từ đó dẫn tới việc thiếu đi dữ liệu trong quá trình cào.</p>
<p>Ta quan sát một số ví dụ:</p>
<table>
<thead>
<tr>
<th>Unnamed: 0</th>
<th>Date</th>
<th>Type</th>
<th>ID</th>
<th>Title</th>
<th>Location1</th>
<th>Location2</th>
<th>Description</th>
<th>Area</th>
<th>Bedrooms</th>
<th>Legal</th>
<th>WC</th>
<th>House orientation</th>
<th>Furniture</th>
<th>Price</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>22/07/2024</td>
<td>Tin Thường</td>
<td>115834</td>
<td>Bán nhà HẺM XE HƠI TRÁNH TÂN HOÁ, chỉ 4.6 TỶ,</td>
<td>Quận 6, Hồ Chí Minh</td>
<td>Đường Tân Hóa, 10</td>
<td>Bán nhà HẺM XE HƠI TRÁNH TÂN HOÁ, chỉ 4.6 TỶ,</td>
<td>38</td>
<td>NaN</td>
<td>Sổ đỏ/ Sổ hồng</td>
<td>4.0</td>
<td>NaN</td>
<td>NaN</td>
<td>4 tỷ 600 triệu</td>
</tr>
</tbody>
</table>
<p>Ta thấy cột <code>Bedrooms</code> là NaN nhưng hãy cùng quan sát phần <code>Description</code> của dữ liệu này:</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Bán nhà HẺM XE HƠI TRÁNH TÂN HOÁ, chỉ 4.6 TỶ, KHU AN NINH, YÊN TĨNH, DÂN TRÍ CAO

- Diện tích : 3.95mx9.5m

-Kết cấu 3 tầng với 3 PN , 3WC.

-Hẻm nhựa 6m xe hơi tránh, thông qua Đặng Nguyên Cẩn

Ms Tuyền 0909.738.688 - Zalo 24/24 - Tư vấn pháp lý - Hỗ trợ miễn phí
</code></pre><p>Ta tìm được thông tin "3 PN" trong phần mô tả này, nên từ đó ta cố gắng trích xuất chúng và giảm thiểu số lượng dữ liệu NaN nhất có thể. Chính vì vậy dữ liệu sau khi xử lý mới có số phòng ngủ là 3:</p>
<table>
<thead>
<tr>
<th>id</th>
<th>price</th>
<th>area</th>
<th>bedrooms</th>
<th>wc</th>
<th>n_floors</th>
<th>car_place</th>
<th>house_orientation</th>
<th>furniture</th>
<th>facade</th>
<th>legal</th>
<th>street</th>
<th>district</th>
<th>type</th>
<th>date</th>
</tr>
</thead>
<tbody>
<tr>
<td>115834</td>
<td>4.6</td>
<td>38</td>
<td>3.0</td>
<td>4.0</td>
<td>3.0</td>
<td>True</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>sổ đỏ/ sổ hồng</td>
<td>tân hóa</td>
<td>quận 6</td>
<td>tin thường</td>
<td>22/07/2024</td>
</tr>
</tbody>
</table>
<p>Trước hết ta cần hiểu được một cách tổng quan về <strong>Regex</strong>:</p>
<p><strong>Regex (Regular Expressions)</strong> là một công cụ mạnh mẽ dùng để tìm kiếm, khớp mẫu (pattern matching), và xử lý chuỗi văn bản. Regex thường được sử dụng trong xử lý dữ liệu, kiểm tra chuỗi, và trích xuất thông tin từ dữ liệu không cấu trúc.</p>
<p>Ở phần sau, ta sẽ áp dụng toàn bộ phương pháp để trích xuất thông tin từ cả <code>Description</code> và <code>Title</code>.</p>
<h4 id="xử-lý-các-dữ-liệu-số">Xử lý các dữ liệu số </h4>
<p>Ta cần xem qua hai hàm phụ trợ chính trong việc trích xuất này là hàm <code>process_number</code> và <code>process_boolean</code> trong đó:</p>
<ul>
<li><code>process_number</code> được sử dụng để tìm kiếm số đầu tiên phù hợp với mẫu regex. Đầu tiên nó kiểm tra nếu chuỗi đầu vào là dữ liệu khuyết nó sẽ trả về khuyết luôn. Sau đó, tìm kiếm mẫu regex trong chuỗi mô tả, nếu có trả về số đầu tiên.<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">process_number</span><span class="token punctuation">(</span>description<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> pattern<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>NA<span class="token punctuation">:</span>
<span class="token triple-quoted-string string">"""
Extract the first number found in the string that matches the given pattern.
"""</span>
<span class="token keyword keyword-if">if</span> pd<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span>description<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> pd<span class="token punctuation">.</span>NA
<span class="token keyword keyword-match">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> description<span class="token punctuation">)</span>
<span class="token keyword keyword-if">if</span> <span class="token keyword keyword-match">match</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r"\d+"</span><span class="token punctuation">,</span> <span class="token keyword keyword-match">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword keyword-return">return</span> pd<span class="token punctuation">.</span>NA
</code></pre></li>
<li><code>process_boolean</code> xác định xem một chuỗi mô tả có chứa mẫu regex cụ thể hay không. Tương tự cũng sẽ có bước kiểm tra dữ liệu khuyết. Sau đó, trả về <code>True</code> nếu có sự tồn tại của mẫu regex trong chuỗi, ngược lại trả về <code>False</code>.<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">process_boolean</span><span class="token punctuation">(</span>description<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> pattern<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
<span class="token triple-quoted-string string">"""
Check if the input string matches the given pattern.
"""</span>
<span class="token keyword keyword-if">if</span> pd<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span>description<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> pd<span class="token punctuation">.</span>NA
<span class="token keyword keyword-return">return</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> description<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></li>
</ul>
<p>Từ đó các hàm xử lý dữ liệu khuyết sẽ có một "workflow" tương tự nhau như sau: <em>thiết kế regex pattern</em> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">→</span></span></span></span> <em>tìm kiếm</em> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">→</span></span></span></span> <em>điền vào dữ liệu khuyết</em>.</p>
<ol>
<li>
<p>Xử lý số phòng ngủ</p>
<p>Hàm chính của chúng ta là <code>process_bedroom</code>, trong đó regex pattern được thiết kế để bắt gặp được các trường hợp phổ biến đã được ta kiểm tra bằng thực nghiệm với bộ dữ liệu thô như sau:</p>
<ul>
<li>2pn</li>
<li>3 phòng ngủ</li>
<li>5 ngủ</li>
<li>...</li>
</ul>
<p>Vì là tiếng Việt phong phú, nên các ví dụ trên còn có thể viết dưới dạng không dấu nên cuối cùng regex pattern mà ta thiết kế cho trường hợp này sẽ là như sau:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>pattern <span class="token operator">=</span> <span class="token string">r"\d+\s?(pn|phòng ngủ|phong ngu|phòng ngu|phong ngủ|phòng ngũ|ngủ)"</span>
</code></pre></li>
<li>
<p>Xử lý số nhà vệ sinh</p>
<p>Tương tự với cách làm việc như trên, hàm chính cho việc này sẽ là <code>process_bathroom</code>, và các trường hợp phổ biến trong dữ liệu thô là:</p>
<ul>
<li>2wc</li>
<li>3 toilet</li>
<li>1 vệ sinh</li>
<li>...</li>
</ul>
<p>Từ đó ta có regex pattern sau cho trường hợp này là:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>pattern <span class="token operator">=</span> <span class="token string">r"\d+\s?(wc|toilet|vs|vệ sinh|ve sinh|nhà vệ sinh|nhà vs)"</span>
</code></pre></li>
<li>
<p>Xử lý số tầng</p>
<p>Số tầng là theo chúng tôi nghĩ là một đặc trưng rất quan trọng trong bài toán hồi quy tiên đoán giá nhà này, và trên web không hề có thuộc tính này. Nhưng may mắn thay, trong phần mô tả các người đăng rất hay mô tả đặc điểm này, nên chúng tôi cũng cố gắng sử dụng Regex để trích xuất được.</p>
<p>Xét ví dụ đã thấy ở trên:</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Bán nhà HẺM XE HƠI TRÁNH TÂN HOÁ, chỉ 4.6 TỶ, KHU AN NINH, YÊN TĨNH, DÂN TRÍ CAO

- Diện tích : 3.95mx9.5m

-Kết cấu 3 tầng với 3 PN , 3WC.

-Hẻm nhựa 6m xe hơi tránh, thông qua Đặng Nguyên Cẩn

Ms Tuyền 0909.738.688 - Zalo 24/24 - Tư vấn pháp lý - Hỗ trợ miễn phí
</code></pre><p>Ta rõ ràng biết được rằng số tầng là 3 và thông qua kiểm tra thực nghiệm, chúng tôi cũng thấy được cách mô tả phổ biến là:</p>
<ul>
<li>2 lầu</li>
<li>3 tầng</li>
<li>4 tấm</li>
<li>...</li>
</ul>
<p>Vì vậy để bao quát được các mẫu đó, chúng tôi đã thiết kế regex pattern cho trường hợp này như sau:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>pattern <span class="token operator">=</span> <span class="token string">r"\d+\s?(lầu|tầng|tấm|tang|lau|tam)"</span>
</code></pre><p>Ngoài ra, chúng tôi thấy được có nhiều phần mô tả không đề cập tới vấn đề số tầng, nhưng lại có một mô tả về căn nhà là "nhà cấp 4", mà đó nghĩa là nhà 1 tầng. Nên chúng tôi thiết kế một mảng các từ có thể là mô tả nhà cấp 4 như sau:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>level4 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"cấp 4"</span><span class="token punctuation">,</span> <span class="token string">"c4"</span><span class="token punctuation">,</span> <span class="token string">"cap 4"</span><span class="token punctuation">,</span> <span class="token string">"cap4"</span><span class="token punctuation">]</span>
</code></pre><p>Bất cứ từ nào nằm trong phần mô tả thì sẽ trả về số tầng là 1 ngay.</p>
</li>
<li>
<p>Xử lý mức giá</p>
<p>Ta xem qua hàm <code>process_price</code> được thiết kế để xử lý và chuẩn hóa dữ liệu giá bất động sản từ chuỗi mô tả dạng tự do sang dạng số thực.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">process_price</span><span class="token punctuation">(</span>price<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Convert a price string to a float value based on the format "x tỷ y triệu" or similar.
    """</span>
    <span class="token keyword keyword-if">if</span> pd<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword keyword-or">or</span> <span class="token string">"tháng"</span> <span class="token keyword keyword-in">in</span> price<span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> pd<span class="token punctuation">.</span>NA
    numbers <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r"\d+"</span><span class="token punctuation">,</span> price<span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token string">"tỷ"</span> <span class="token keyword keyword-in">in</span> price<span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span>numbers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-elif">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span>numbers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">float</span><span class="token punctuation">(</span>numbers<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span>
    <span class="token keyword keyword-elif">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        number <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>numbers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> number <span class="token operator">&lt;=</span> <span class="token number">500</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> pd<span class="token punctuation">.</span>NA
        <span class="token keyword keyword-return">return</span> number <span class="token operator">/</span> <span class="token number">1000</span>
    <span class="token keyword keyword-return">return</span> pd<span class="token punctuation">.</span>NA
</code></pre><p>Hàm này chủ yếu tập trung vào việc trích xuất giá trị từ các định dạng giá phổ biến như:</p>
<ul>
<li>"2 tỷ 500 triệu"</li>
<li>"3 tỷ"</li>
<li>"400 triệu"</li>
<li>...</li>
</ul>
<p><strong>Cách hoạt động:</strong> Đầu tiên, kiểm tra các giá trị NaN hay các giá trị rác không phải mô tả về mức giá. Tiếp theo, sử dụng regex <code>re.findall(r"\d+", price)</code> để trích xuất tất cả các số trong chuỗi. Hàm kiểm tra các từ khóa quan trọng như "tỷ" và "triệu" để xử lý giá theo hai trường hợp chính:</p>
<ul>
<li>
<p><strong>Trường hợp 1:</strong> Giá trị chứa từ "tỷ"</p>
<p>a) Cấu trúc phổ biến:</p>
<ul>
<li>x tỷ: Chỉ có số nguyên tỷ (vd: "3 tỷ").</li>
<li>x tỷ y triệu: Bao gồm cả tỷ và triệu (vd: "2 tỷ 500 triệu").</li>
</ul>
<p>b) Xử lý:</p>
<ul>
<li>Nếu chỉ có x tỷ, giá trị được chuyển đổi trực tiếp thành float từ số nguyên tỷ.</li>
<li>Nếu có cả x tỷ và y triệu, giá trị được tính bằng công thức:</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token builtin">float</span><span class="token punctuation">(</span>numbers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">float</span><span class="token punctuation">(</span>numbers<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span>
</code></pre><pre class="language-text">  (1 triệu = 0.001 tỷ).
</pre>
</li>
<li>
<p><strong>Trường hợp 2:</strong> Giá trị không chứa "tỷ" nhưng có "triệu"</p>
<p>a) Cấu trúc phổ biến:</p>
<ul>
<li>x triệu: Chỉ có giá trị triệu (vd: "400 triệu").</li>
</ul>
<p>b) Xử lý:</p>
<ul>
<li>Số được chia cho 1000 để chuyển đổi từ triệu sang tỷ:<pre data-role="codeBlock" data-info="python" class="language-python python"><code>number <span class="token operator">/</span> <span class="token number">1000</span>
</code></pre></li>
<li>Nếu giá trị triệu quá nhỏ (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≤</mo></mrow><annotation encoding="application/x-tex">\leq</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mrel">≤</span></span></span></span> 500), giả định đây không phải là giá bán hợp lệ và trả về <code>pd.NA</code>.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="tạo-ra-các-cột-dữ-liệu-mới-hữu-ích-cho-bài-toán">Tạo ra các cột dữ liệu mới hữu ích cho bài toán </h4>
<p>Ngoài việc chuẩn hóa giá cả và thông tin cơ bản như số phòng ngủ, phòng vệ sinh, và số tầng, các hàm dưới đây được thiết kế để trích xuất thông tin chi tiết hơn về các đặc điểm liên quan đến vị trí, tiện ích, và tính năng của bất động sản. Điều này giúp cải thiện khả năng phân tích và đánh giá giá trị tài sản.</p>
<p>Trong phần này, chúng tôi vẫn cố gắng khai thác tối đa thông tin từ cột <code>Description</code> và <code>Title</code> để lấy ra được những đặc trưng mà chúng tôi thấy hữu ích trong bài toán hồi quy tiến đoán này. Quy trình làm việc vẫn là cố gắng thiết kế các regex pattern mà có thể thể hiện được "sự tồn tại" của biến sắp được tạo ra trong <code>Description</code> hay <code>Title</code>.</p>
<ol>
<li>
<p>Xử lý không gian đỗ xe hơi:</p>
<p>Hàm <code>process_car_place</code> được thiết kế để kiểm tra xem bất động sản có không gian dành cho đỗ xe hoặc gara hay không, một yếu tố quan trọng trong việc đánh giá sự tiện nghi.</p>
<p><strong>Cách hoạt động:</strong></p>
<ul>
<li>Sử dụng regex để nhận diện các từ khóa liên quan đến đỗ xe trong chuỗi mô tả, bao gồm:</li>
<li>"gara", "đỗ ô tô", "xe hơi", "hầm xe", "sân đỗ", "hẻm xe hơi", "hẻm xe tải", "oto", v.v.</li>
<li>Trả về <code>True</code> nếu tìm thấy từ khóa trong mô tả, <code>False</code> nếu không tìm thấy.</li>
</ul>
<p>Sau đây là pattern đầy đủ:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>pattern <span class="token operator">=</span> <span class="token string">r"gara|đỗ ô tô|xe hơi|ô tô tránh|hầm xe|hầm|nhà xe|đỗ|ô tô|ôtô|sân đỗ|hẻm xe hơi|hxh|oto|hẻm xe tải"</span>
</code></pre><p><strong>Ý nghĩa:</strong> Hàm này giúp nhận diện bất động sản phù hợp với người mua có yêu cầu về đỗ xe, đặc biệt ở các khu vực thành phố lớn nơi không gian đỗ xe là một yếu tố ưu tiên.</p>
</li>
<li>
<p>Xử lý thông tin mặt tiền:</p>
<p>Chúng tôi sử dụng hai hàm để có thể trích xuất được thông tin mặt tiền là <code>process_facade_step1</code> và <code>process_facade_step2</code>. Hai hàm này được sử dụng để xác định vị trí của bất động sản liên quan đến mặt tiền, với hai trường hợp cụ thể:</p>
<ul>
<li>
<p>2.1. Hàm <code>process_facade_step1</code></p>
<p>Sử dụng regex để tìm kiếm các cụm từ mô tả trực tiếp mặt tiền như: "mặt tiền", "mặt phố", "mặt đường", "mat tien". Trả về <code>True</code> nếu bất động sản nằm trực tiếp trên mặt tiền đường, ngược lại trả vè <code>False</code></p>
<p>Ví dụ:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>description <span class="token operator">=</span> <span class="token string">"Nhà nằm ở mặt tiền đường lớn, thích hợp kinh doanh."</span>
result <span class="token operator">=</span> process_facade_step1<span class="token punctuation">(</span>description<span class="token punctuation">)</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>  <span class="token comment"># Output: True</span>
</code></pre></li>
<li>
<p>2.2. Hàm <code>process_facade_step2</code></p>
<p>Hàm này sẽ nhận dạng các từ khóa mô tả việc bất động sản có khoảng cách gần mặt tiền như: "cách mặt tiền", "sát mặt tiền", "cách mặt phố", "sát mặt phố". Trả về <code>True</code> nếu bất động sản gần mặt tiền, ngược lại trả về <code>False</code>.</p>
<p>Ví dụ:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>description <span class="token operator">=</span> <span class="token string">"Nhà cách mặt tiền đường 10m, thuận tiện di chuyển."</span>
result <span class="token operator">=</span> process_facade_step2<span class="token punctuation">(</span>description<span class="token punctuation">)</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>  <span class="token comment"># Output: True</span>
</code></pre></li>
</ul>
<p>Sau cùng chúng tôi sẽ lấy giao của <code>process_facade_step1</code> và phủ định của <code>process_facade_step2</code>, từ đó xác định được việc bất động sản có phải tọa lạc ở mặt tiền hay không.</p>
<p><strong>Ý nghĩa:</strong> Những hàm này cho phép phân tích tự động các đặc điểm chi tiết của bất động sản dựa trên mô tả tự do. Khi kết hợp với các hàm xử lý khác (giá cả, số phòng ngủ, phòng vệ sinh), hệ thống có thể:</p>
<ul>
<li>Đưa ra các đánh giá tổng quan và chi tiết hơn về bất động sản.</li>
<li>Tăng khả năng lọc và tìm kiếm bất động sản phù hợp với nhu cầu cụ thể của người dùng (ví dụ: ưu tiên mặt tiền, có gara).</li>
<li>Cải thiện độ chính xác trong định giá và phân tích giá trị tài sản.</li>
</ul>
</li>
</ol>
<h3 id="trích-xuất-đặt-trưng-về-địa-chỉ">Trích xuất đặt trưng về địa chỉ </h3>
<p>Bởi vì dữ liệu ban đầu chỉ có các cột địa chỉ cào được là <code>Location1</code> và <code>Location2</code> với:</p>
<ul>
<li><code>Location1</code> là dữ liệu về quận và thành phố</li>
<li><code>Location2</code> là địa chỉ chi tiết</li>
</ul>
<p>Ví dụ trong hai hình ảnh sau:</p>
<p><img src="images/location1.png" alt="Location1"></p>
<p><img src="images/location2.png" alt="Location2"></p>
<p><code>Location1</code> sẽ là "Bình Thạnh , Hồ Chí minh" và <code>Location2</code> sẽ là "Đường Chu Văn An, 12". Nhưng có rất nhiều điểm dữ liệu mà không thu được <code>Location2</code> có định dạng tốt như thế, ví dụ như:</p>
<table>
<thead>
<tr>
<th>Location1</th>
<th>Location2</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bình Chánh , Hồ Chí Minh</td>
<td>TÂN KIÊN BÌNH CHÁNH</td>
</tr>
<tr>
<td>Quận 6 , Hồ Chí Minh</td>
<td>Phường 14, Quận 6, Hồ Chí Minh</td>
</tr>
<tr>
<td>Bình Chánh , Hồ Chí Minh</td>
<td>123 Phu Dong</td>
</tr>
<tr>
<td>Quận 4 , Hồ Chí Minh</td>
<td>Phố Ẩm Thực Vĩnh Khánh</td>
</tr>
<tr>
<td>Quận 7 , Hồ Chí Minh</td>
<td>41/36/1g chuyên dùng 9, p Phú Mỹ q7</td>
</tr>
<tr>
<td>Quận 10 , Hồ Chí Minh</td>
<td>606 đường 3/2, P14, Q10</td>
</tr>
</tbody>
</table>
<p>Các Location2 có nhiều hàng có cả số nhà, tên đường, phường và quận và format rất khác nhau. Và đa số là không có số nhà, nên chúng tôi sẽ chỉ trích xuất tên đường và quận của một điểm dữ liệu mà thôi.</p>
<p>Về Quận thì <code>Location1</code> là một cột dữ liệu sạch, nên dễ dàng bằng cách lấy các phần ở trước dấu phẩy.</p>
<p>Còn về đường thì chúng tôi cố gắng cào tất cả các đường của từng quận trên địa bàn thành phố Hồ Chí Minh sau đó dùng các vòng lặp, kết hợp với điều kiện rẽ nhánh để đưa về cùng một định dạng.</p>
<p>Và kết quả sau khi áp dụng bộ lọc là: (với "123 Phu Dong" bị loại bỏ)</p>
<table>
<thead>
<tr>
<th>Street</th>
<th>District</th>
</tr>
</thead>
<tbody>
<tr>
<td>tân kiên</td>
<td>bình chánh</td>
</tr>
<tr>
<td>NaN</td>
<td>quận 6</td>
</tr>
<tr>
<td>vĩnh khánh</td>
<td>quận 4</td>
</tr>
<tr>
<td>chuyên dùng</td>
<td>quận 7</td>
</tr>
<tr>
<td>3/2</td>
<td>quận 10</td>
</tr>
</tbody>
</table>
<p>Chi tiết việc cào tất cả tên đường ở <a href="crawl_street_names.py">crawl_street_names.py</a></p>
<hr>
<h1 id="ii-eda-and-feature-engineering">II. EDA and Feature Engineering </h1>
<h2 id="1-khai-báo-thư-viện-và-thiết-lập">1. Khai báo thư viện và thiết lập </h2>
<p>Phần này tập trung vào việc khai báo các thư viện và thiết lập môi trường để thực hiện phân tích dữ liệu. Các thư viện bao gồm cả các công cụ xử lý dữ liệu, trực quan hóa, và các tiện ích chuyên biệt. Các thư viện được sử dụng nhằm mục đích tối ưu hóa quy trình xử lý và phân tích dữ liệu.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-import">import</span> webbrowser
<span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
<span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
<span class="token keyword keyword-import">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword keyword-as">as</span> plt
<span class="token keyword keyword-import">import</span> seaborn <span class="token keyword keyword-as">as</span> sns

<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword keyword-import">import</span> train_test_split<span class="token punctuation">,</span> RandomizedSearchCV<span class="token punctuation">,</span> GridSearchCV<span class="token punctuation">,</span> cross_val_score
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword keyword-import">import</span> RandomForestRegressor
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>feature_selection <span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
    VarianceThreshold<span class="token punctuation">,</span> SelectKBest<span class="token punctuation">,</span> f_regression<span class="token punctuation">,</span> mutual_info_regression
<span class="token punctuation">)</span>

<span class="token comment"># Custom imports from local modules</span>
<span class="token keyword keyword-from">from</span> DataProcessing <span class="token keyword keyword-import">import</span> DataCleaner<span class="token punctuation">,</span> del_col
<span class="token keyword keyword-from">from</span> Visualize <span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
    check_coordinates_in_vietnam<span class="token punctuation">,</span> 
    visualize_real_estate_price<span class="token punctuation">,</span> 
    visualize_real_estate_clusters<span class="token punctuation">,</span>
    visualize_real_estate_price_heatmap
<span class="token punctuation">)</span>
</code></pre><ul>
<li>
<p><strong>Thư viện cơ bản và tổng quát</strong></p>
<ul>
<li><strong><code>webbrowser</code></strong>: Tương tác với trình duyệt web để mở báo cáo hoặc bản đồ.</li>
<li><strong><code>numpy</code></strong>: Thư viện cơ bản cho tính toán số học, đặc biệt xử lý mảng và các phép toán toán học.</li>
<li><strong><code>pandas</code></strong>: Xử lý và phân tích dữ liệu dạng bảng.</li>
</ul>
</li>
<li>
<p><strong>Thư viện trực quan hóa</strong></p>
<ul>
<li><strong><code>matplotlib.pyplot</code></strong>: Công cụ tạo biểu đồ từ mức độ cơ bản.</li>
<li><strong><code>seaborn</code></strong>: Tăng cường <code>matplotlib</code> với giao diện trực quan hơn cho biểu đồ thống kê.</li>
</ul>
</li>
<li>
<p><strong>Thư viện học máy</strong></p>
<ul>
<li>
<p><strong><code>sklearn.model_selection</code></strong>:</p>
<ul>
<li><code>train_test_split</code>: Chia dữ liệu thành tập huấn luyện và kiểm tra.</li>
<li><code>RandomizedSearchCV</code> &amp; <code>GridSearchCV</code>: Tìm kiếm tham số tối ưu bằng cách thử ngẫu nhiên hoặc toàn diện.</li>
<li><code>cross_val_score</code>: Đánh giá hiệu suất mô hình qua cross-validation.</li>
</ul>
</li>
<li>
<p><strong><code>sklearn.ensemble</code></strong>:</p>
<ul>
<li><code>RandomForestRegressor</code>: Mô hình hồi quy dạng tập hợp mạnh mẽ và linh hoạt.</li>
</ul>
</li>
<li>
<p><strong><code>sklearn.feature_selection</code></strong>:</p>
<ul>
<li><code>VarianceThreshold</code>: Loại bỏ các đặc trưng có độ biến thiên thấp.</li>
<li><code>SelectKBest</code>: Chọn K đặc trưng tốt nhất dựa trên kiểm định thống kê như <code>f_regression</code> hoặc <code>mutual_info_regression</code>.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Các mô-đun tuỳ chỉnh</strong>:</p>
<ul>
<li>
<p><strong>Mô-đun <code>DataProcessing</code></strong></p>
<ul>
<li><strong><code>DataCleaner</code></strong>: Công cụ làm sạch và tiền xử lý dữ liệu.</li>
<li><strong><code>del_col</code></strong>: Hàm xóa các cột không cần thiết hoặc không liên quan.</li>
</ul>
</li>
<li>
<p><strong>Mô-đun <code>Visualize</code></strong></p>
<ul>
<li><strong><code>check_coordinates_in_vietnam</code></strong>: Kiểm tra tọa độ có nằm trong lãnh thổ Việt Nam hay không.</li>
<li><strong><code>visualize_real_estate_price</code></strong>: Trực quan hóa giá dựa trên giá cả.</li>
<li><strong><code>visualize_real_estate_clusters</code></strong>: Hiển thị các cụm dựa trên vị trí hoặc giá.</li>
<li><strong><code>visualize_real_estate_price_heatmap</code></strong>: Tạo biểu đồ nhiệt cho giá cả, có thể biểu diễn trên bản đồ.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="2-khám-phá-dữ-liệu">2. Khám phá dữ liệu </h2>
<h3 id="21-tổng-quan-về-dữ-liệu">2.1. Tổng quan về dữ liệu </h3>
<table>
<thead>
<tr>
<th>id</th>
<th>price</th>
<th>area</th>
<th>bedrooms</th>
<th>wc</th>
<th>n_floors</th>
<th>car_place</th>
<th>house_orientation</th>
<th>furniture</th>
<th>facade</th>
<th>legal</th>
<th>street</th>
<th>district</th>
<th>type</th>
<th>date</th>
</tr>
</thead>
<tbody>
<tr>
<td>121356</td>
<td>0.79</td>
<td>57</td>
<td>2.0</td>
<td>2.0</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>cơ bản</td>
<td>False</td>
<td>sổ đỏ/sổ hồng</td>
<td>tân kiên</td>
<td>bình chánh</td>
<td>tin thường</td>
<td>11/10/2024</td>
</tr>
<tr>
<td>121355</td>
<td>0.10</td>
<td>80</td>
<td>19.0</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>nội thất đầy đủ</td>
<td>True</td>
<td>NaN</td>
<td>lê hồng phong</td>
<td>quận 10</td>
<td>tin thường</td>
<td>11/10/2024</td>
</tr>
<tr>
<td>115827</td>
<td>2.60</td>
<td>16</td>
<td>4.0</td>
<td>3.0</td>
<td>3.0</td>
<td>False</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>sổ đỏ/sổ hồng</td>
<td>lý thường kiệt</td>
<td>quận 10</td>
<td>tin thường</td>
<td>22/07/2024</td>
</tr>
<tr>
<td>115833</td>
<td>3.00</td>
<td>32</td>
<td>4.0</td>
<td>NaN</td>
<td>5.0</td>
<td>True</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>sổ đỏ/sổ hồng</td>
<td>NaN</td>
<td>quận 6</td>
<td>tin thường</td>
<td>22/07/2024</td>
</tr>
<tr>
<td>115834</td>
<td>4.60</td>
<td>38</td>
<td>4.0</td>
<td>4.0</td>
<td>3.0</td>
<td>True</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>sổ đỏ/sổ hồng</td>
<td>tân hóa</td>
<td>quận 6</td>
<td>tin thường</td>
<td>22/07/2024</td>
</tr>
</tbody>
</table>
<h4 id="211-nhận-xét-về-dữ-liệu-ban-đầu">2.1.1. Nhận xét về dữ liệu ban đầu </h4>
<p>Bảng dữ liệu bất động sản có 15 cột, bao gồm thông tin liên quan đến giá cả, diện tích, số phòng, số tầng, tình trạng pháp lý, và các đặc trưng khác. Tuy nhiên, dữ liệu hiện tại có một số điểm cần lưu ý:</p>
<ul>
<li>
<p><strong>Dữ liệu bị thiếu (Missing Values):</strong> Các cột <code>n_floors</code>, <code>wc</code>, <code>furniture</code>, <code>legal</code>, <code>house_orientation</code>, và <code>street</code> có giá trị bị thiếu, đặc biệt là <code>house_orientation</code> bị thiếu toàn bộ.</p>
</li>
<li>
<p><strong>Dữ liệu bất thường (Outliers):</strong> Có một số giá trị bất thường hoặc không hợp lý trong dữ liệu. Ví dụ, <code>bedrooms = 19.0</code> là giá trị bất thường, có thể do lỗi hoặc dữ liệu không hợp lệ.</p>
</li>
<li>
<p><strong>Cột không thông tin:</strong> <code>type</code> chỉ chứa một giá trị duy nhất ("tin thường"), không có giá trị phân biệt, có thể loại bỏ khỏi phân tích.</p>
</li>
</ul>
<h4 id="212-tóm-tắt-khả-năng-sử-dụng-dữ-liệu">2.1.2. Tóm tắt khả năng sử dụng dữ liệu </h4>
<ul>
<li><strong>Cột sử dụng được:</strong> <code>price</code>, <code>area</code>, <code>bedrooms</code>, <code>wc</code>, <code>n_floors</code>, <code>district</code>, và <code>car_place</code> là các cột có thể sử dụng để phân tích sau khi làm sạch.</li>
<li><strong>Cột cần xử lý:</strong>
<ul>
<li><code>house_orientation</code> và <code>furniture</code> chứa nhiều giá trị thiếu.</li>
<li><code>street</code> và <code>legal</code> cần điền dữ liệu thiếu.</li>
</ul>
</li>
<li><strong>Cột có thể loại bỏ:</strong>
<ul>
<li><code>type</code> không mang lại thông tin hữu ích.</li>
<li><code>id</code> không cần thiết trong phân tích, chỉ dùng làm định danh.</li>
</ul>
</li>
</ul>
<h3 id="22-phân-tích-phân-phối-các-biến-định-lượng">2.2. Phân tích phân phối các biến định lượng </h3>
<p><img src="./images/histbox.png" alt="Histogram and Boxplot"></p>
<p>Dựa trên các biểu đồ histogram và boxplot:</p>
<ul>
<li>
<p><code>price</code>:</p>
<ul>
<li><strong>Trung bình và phân phối</strong>:
<ul>
<li>Giá trung bình: <strong>6.53 tỷ</strong>.</li>
<li>Biểu đồ histogram cho thấy phần lớn dữ liệu tập trung ở mức giá thấp (0 - 10 tỷ).</li>
<li>Phân phối lệch phải (<em>right-skewed</em>), phổ biến trong dữ liệu giá bất động sản.</li>
</ul>
</li>
<li><strong>Ngoại lai</strong>:
<ul>
<li>Các giá trị rất cao (trên 30 tỷ) có thể là ngoại lệ. Có thể do lỗi nhập liệu hoặc giá đặc biệt cao.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>area</code>:</p>
<ul>
<li><strong>Trung bình và phân phối</strong>:
<ul>
<li>Diện tích trung bình: <strong>76.43 m²</strong>.</li>
<li>Phần lớn các bất động sản có diện tích dưới 100 m².</li>
<li>Phân phối lệch phải do một số ít bất động sản có diện tích rất lớn (trên 400 m²).</li>
</ul>
</li>
<li><strong>Ngoại lai</strong>: Các giá trị vượt quá 400 m² có thể là ngoại lệ (biệt thự hoặc lỗi dữ liệu).</li>
</ul>
</li>
<li>
<p><code>bedrooms</code>:</p>
<ul>
<li><strong>Trung bình và phân phối</strong>:
<ul>
<li>Trung bình: <strong>3.41 phòng ngủ</strong>.</li>
<li>Phần lớn dữ liệu tập trung từ 1 đến 5 phòng ngủ.</li>
</ul>
</li>
<li><strong>Ngoại lai</strong>: Số phòng ngủ trên 20 là ngoại lệ. Hiếm gặp và cần kiểm tra thêm (có thể là nhà tập thể hoặc lỗi dữ liệu).</li>
</ul>
</li>
<li>
<p><code>wc</code>:</p>
<ul>
<li><strong>Trung bình và phân phối</strong>:
<ul>
<li>Phân phối tương tự như <code>bedrooms</code>, với phần lớn dữ liệu dưới 5 phòng vệ sinh.</li>
</ul>
</li>
<li><strong>Ngoại lai</strong>: Giá trị vượt trên 20 phòng vệ sinh có thể không thực tế.</li>
</ul>
</li>
<li>
<p><code>n_floors</code>:</p>
<ul>
<li><strong>Trung bình và phân phối</strong>:
<ul>
<li>Phần lớn dữ liệu có số tầng nhỏ hơn 5.</li>
<li>Histogram cho thấy phần lớn bất động sản là nhà cấp thấp hoặc tòa nhà thấp tầng.</li>
</ul>
</li>
<li><strong>Ngoại lai</strong>: Giá trị cao nhất (900 tầng) rõ ràng không hợp lý và có thể là lỗi nhập liệu.</li>
</ul>
</li>
</ul>
<h3 id="23-tình-trạng-dữ-liệu-thiếu">2.3. Tình trạng dữ liệu thiếu </h3>
<table>
<thead>
<tr>
<th>Column</th>
<th>Missing Values</th>
<th>Percentage Missing</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>0</td>
<td>0%</td>
</tr>
<tr>
<td>price</td>
<td>482</td>
<td>5%</td>
</tr>
<tr>
<td>area</td>
<td>0</td>
<td>0%</td>
</tr>
<tr>
<td>bedrooms</td>
<td>1,890</td>
<td>19%</td>
</tr>
<tr>
<td>wc</td>
<td>2,494</td>
<td>25%</td>
</tr>
<tr>
<td>n_floors</td>
<td>3,222</td>
<td>32%</td>
</tr>
<tr>
<td>car_place</td>
<td>0</td>
<td>0%</td>
</tr>
<tr>
<td>house_orientation</td>
<td>8,609</td>
<td>86%</td>
</tr>
<tr>
<td>furniture</td>
<td>9,846</td>
<td>98%</td>
</tr>
<tr>
<td>legal</td>
<td>8,207</td>
<td>82%</td>
</tr>
<tr>
<td>street</td>
<td>3,970</td>
<td>40%</td>
</tr>
<tr>
<td>district</td>
<td>0</td>
<td>0%</td>
</tr>
<tr>
<td>type</td>
<td>0</td>
<td>0%</td>
</tr>
<tr>
<td>date</td>
<td>0</td>
<td>0%</td>
</tr>
<tr>
<td>facade</td>
<td>0</td>
<td>0%</td>
</tr>
</tbody>
</table>
<p><strong>dtype:</strong> int64</p>
<ul>
<li><strong>Cột có dữ liệu thiếu nhiều nhất:</strong> <code>furniture</code> và <code>house_orientation</code> có hơn 80% dữ liệu bị thiếu. Cần xử lý cẩn thận hoặc loại bỏ nếu không thể khôi phục.</li>
<li><strong>Cột có dữ liệu thiếu ít nhất:</strong> <code>price</code> và <code>area</code> không có dữ liệu thiếu, có thể sử dụng trực tiếp.</li>
</ul>
<h3 id="24-phân-tích-theo-thời-gian">2.4. Phân tích theo thời gian </h3>
<p><img src="./images/averageprice.png" alt="Average Price"></p>
<ul>
<li>
<p>Phân phối số lượng theo năm:</p>
<ul>
<li>Năm <strong>2023</strong> có số lượng listings cao nhất, cho thấy đây là năm sôi động với nhiều giao dịch.</li>
<li>Năm <strong>2024</strong> ghi nhận sự giảm đáng kể trong số lượng listings, có thể do thị trường trầm lắng hoặc thay đổi điều kiện kinh tế.</li>
</ul>
</li>
<li>
<p>Biến động giá trung bình theo mùa:</p>
<ul>
<li><strong>Mùa thu</strong> và <strong>mùa xuân</strong> ghi nhận giá trung bình cao nhất, có thể là thời điểm "cao điểm" khi nhu cầu mua nhà tăng.</li>
<li><strong>Mùa hè</strong> có giá trung bình thấp nhất, có thể là cơ hội tốt để mua nhà hoặc đầu tư.</li>
</ul>
</li>
<li>
<p>Biến động giá trung bình theo tháng:</p>
<ul>
<li>Giá cao nhất vào tháng <strong>3</strong> (mùa xuân), có thể liên quan đến lễ hội hoặc tâm lý đầu năm.</li>
<li>Giá thấp nhất vào tháng <strong>6</strong>, cho thấy đây là thời điểm có ít cạnh tranh hơn từ người mua.</li>
</ul>
</li>
<li>
<p>Phân phối giá theo ngày trong tuần:</p>
<ul>
<li>Giá trung bình khá ổn định giữa các ngày.</li>
<li>Giá cao nhất vào <strong>chủ nhật</strong>, có thể do đây là thời điểm người mua có thời gian để tìm kiếm và đưa ra quyết định.</li>
</ul>
</li>
</ul>
<h3 id="25-các-phát-hiện-chính">2.5. Các phát hiện chính </h3>
<ul>
<li>Giá cả bị ảnh hưởng bởi thời gian đăng, đặc biệt theo mùa và ngày.</li>
<li>Nhiều cột có dữ liệu ngoại lai hoặc phân phối không đồng đều, cần kiểm soát trước khi dùng để xây dựng mô hình.</li>
<li>Dữ liệu thiếu xuất hiện nhiều ở các cột quan trọng.</li>
</ul>
<h2 id="3-xử-lý-và-làm-sạch-dữ-liệu-với-dataprocessingpy">3. Xử lý và làm sạch dữ liệu với <code>DataProcessing.py</code> </h2>
<p>Ở phần này, tôi sẽ sử dụng file <code>DataProcessing.py</code> có chứa <code>DataCleaner</code> class để xử lý và làm sạch dữ liệu.</p>
<p>Trước tiên, tôi sẽ giới thiệu đôi chút về <code>DataCleaner</code> class.</p>
<h3 id="31-khai-báo-thư-viện">3.1. Khai báo thư viện </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
<span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
<span class="token keyword keyword-import">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword keyword-as">as</span> plt
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword keyword-import">import</span> StandardScaler
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword keyword-import">import</span> train_test_split
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword keyword-import">import</span> mean_squared_error
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>neighbors <span class="token keyword keyword-import">import</span> KNeighborsClassifier
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword keyword-import">import</span> LinearRegression
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>tree <span class="token keyword keyword-import">import</span> DecisionTreeRegressor
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword keyword-import">import</span> RandomForestRegressor<span class="token punctuation">,</span> GradientBoostingRegressor
<span class="token keyword keyword-import">import</span> requests
<span class="token keyword keyword-import">import</span> concurrent<span class="token punctuation">.</span>futures
</code></pre><p>Trong đó:</p>
<ul>
<li><code>numpy</code> và <code>pandas</code> là thư viện cơ bản để xử lý dữ liệu.</li>
<li><code>matplotlib.pyplot</code> được sử dụng để vẽ biểu đồ.</li>
<li><code>StandardScaler</code> từ <code>sklearn.preprocessing</code> để chuẩn hóa dữ liệu.</li>
<li><code>train_test_split</code> từ <code>sklearn.model_selection</code> để chia dữ liệu thành tập huấn luyện và tập kiểm tra.</li>
<li><code>mean_squared_error</code> từ <code>sklearn.metrics</code> để đánh giá mô hình.</li>
<li><code>KNeighborsClassifier</code>, <code>LinearRegression</code>, <code>DecisionTreeRegressor</code>, <code>RandomForestRegressor</code>, <code>GradientBoostingRegressor</code> từ <code>sklearn</code> để sử dụng các mô hình học máy.</li>
<li><code>requests</code> để gửi yêu cầu HTTP đến API.</li>
<li><code>concurrent.futures</code> để thực hiện các công việc đa luồng.</li>
</ul>
<h3 id="32-datacleaner-class">3.2. <code>DataCleaner</code> class </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">DataCleaner</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    A class for cleaning and processing datasets, including outlier removal, 
    imputing missing values, address geocoding, and handling feature correlations.
    """</span>

    <span class="token comment"># ... (code here) ...</span>
</code></pre><p><code>DataCleaner</code> là một lớp (class) được thiết kế nhằm hỗ trợ quá trình tiền xử lý và làm sạch dữ liệu. Mục tiêu chính của lớp này là đơn giản hóa và tự động hóa các bước chuẩn hóa dữ liệu cho trường hợp bài toán dự đoán giá nhà của chúng ta. Sau đó, dữ liệu đã được làm sạch sẽ được lưu lại dưới dạng DataFrame để tiếp tục sử dụng cho các bước quan trọng kết đến.</p>
<h4 id="321-chức-năng-chính-của-datacleaner">3.2.1. Chức năng chính của <code>DataCleaner</code> </h4>
<ul>
<li>Xử lý dữ liệu thô, loại bỏ những giá trị ngoại lai (outliers).</li>
<li>Chuẩn hoá lại dữ liệu đầu vào, bao gồm việc chuyển đổi và điền khuyết giá trị thiếu (missing values) thông qua các mô hình học máy.</li>
<li>Chuẩn hoá dạng dữ liệu, ví dụ như chuyển đổi dữ liệu boolean sang dạng số.</li>
<li>Trích xuất thông tin vị trí (latitude, longitude) từ địa chỉ thông qua API geocoding.</li>
<li>Cho phép thực hiện các thao tác biến đổi phân phối dữ liệu, như log transformation, để điều chỉnh độ lệch và giảm tác động của outliers lên mô hình.</li>
</ul>
<h4 id="322-các-phương-thức-chính-của-datacleaner">3.2.2. Các phương thức chính của <code>DataCleaner</code> </h4>
<ul>
<li>
<p><code>__init__(self, api_key: str)</code>: Phương thức khởi tạo <code>__init__</code> trong lớp <code>DataCleaner</code> đảm nhiệm vai trò thiết lập ban đầu cho đối tượng. Khi tạo một đối tượng <code>DataCleaner</code>, chúng ta cần truyền vào <code>api_key</code> - đây là API dùng để tương tác với dịch vụ geocoding của OpenCageData. Thông qua <code>api_key</code>, class có thể tự động gọi API, chuyển đổi địa chỉ thành tọa độ kinh độ (longitude) và vĩ độ (latitude).</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> api_key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Initialize the DataCleaner class.

        Parameters:
        - api_key: str. The API key for the OpenCageData geocoding service.
        """</span>

        self<span class="token punctuation">.</span>api_key <span class="token operator">=</span> api_key
</code></pre></li>
<li>
<p><code>def drop_outliers(self, df: pd.DataFrame, ...)</code>: Phương thức <code>drop_outliers</code> trong lớp <code>DataCleaner</code> tập trung vào các cột numeric giúp loại bỏ những điểm dữ liệu ngoại lai (outliers) dựa trên chỉ số Interquartile Range (IQR). Việc loại bỏ ngoại lai sẽ giúp dữ liệu trở nên "clean" và ổn định hơn, từ đó giảm thiểu ảnh hưởng tiêu cực của các điểm dữ liệu bất thường đến quá trình huấn luyện mô hình dự báo.<br>
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Boxplot_vs_PDF.svg/1200px-Boxplot_vs_PDF.svg.png" alt="IQR"><br>
<em>Hình 1: Minh họa cách tính IQR và xác định ngoại lai trong boxplot</em></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>    <span class="token keyword keyword-def">def</span> <span class="token function">drop_outliers</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> columns<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Remove outliers from the specified columns based on the interquartile range (IQR).

        Parameters:
        - df: pd.DataFrame. The dataset.
        - columns: list of str. The columns from which to remove outliers.

        Returns:
        - pd.DataFrame. The dataset without outliers.
        """</span>
        <span class="token keyword keyword-for">for</span> field_name <span class="token keyword keyword-in">in</span> columns<span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> df<span class="token punctuation">[</span>field_name<span class="token punctuation">]</span><span class="token punctuation">.</span>dtype <span class="token operator">!=</span> <span class="token string">'int64'</span> <span class="token keyword keyword-and">and</span> df<span class="token punctuation">[</span>field_name<span class="token punctuation">]</span><span class="token punctuation">.</span>dtype <span class="token operator">!=</span> <span class="token string">'float64'</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-continue">continue</span>
            Q1 <span class="token operator">=</span> df<span class="token punctuation">[</span>field_name<span class="token punctuation">]</span><span class="token punctuation">.</span>quantile<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">)</span>
            Q3 <span class="token operator">=</span> df<span class="token punctuation">[</span>field_name<span class="token punctuation">]</span><span class="token punctuation">.</span>quantile<span class="token punctuation">(</span><span class="token number">0.75</span><span class="token punctuation">)</span>
            IQR <span class="token operator">=</span> Q3 <span class="token operator">-</span> Q1
            df <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span>field_name<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>Q1 <span class="token operator">-</span> <span class="token number">1.5</span> <span class="token operator">*</span> IQR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span>field_name<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>Q3 <span class="token operator">+</span> <span class="token number">1.5</span> <span class="token operator">*</span> IQR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token keyword keyword-return">return</span> df
</code></pre></li>
<li>
<p><code>process_addresses_into_coordinations(self, df: pd.DataFrame)</code>: Phương thức này thực hiện việc chuyển đổi địa chỉ thành tọa độ địa lý (longitude và latitude) thông qua việc sử dụng OpenCage API. Đây là một bước quan trọng khi làm việc với dữ liệu liên quan đến vị trí địa lý để phân tích không gian và hiển thị dữ liệu trên bản đồ. Quy trình chính của phương thức này như sau:</p>
<ol>
<li>
<p><strong><code>cache</code></strong> là một dictionary dùng để lưu trữ các kết quả geocoding đã xử lý trước đó. Mục đích:</p>
<ul>
<li>Giảm số lần gọi API không cần thiết.</li>
<li>Tăng hiệu suất khi cùng một địa chỉ xuất hiện nhiều lần trong dữ liệu.</li>
</ul>
</li>
<li>
<p><strong>Hàm nội bộ <code>get_coordinates</code>:</strong></p>
<ul>
<li>Đây là một hàm nhỏ bên trong phương thức chính, thực hiện công việc chính:
<ul>
<li>Kiểm tra nếu địa chỉ đã tồn tại trong <code>cache</code>.</li>
<li>Nếu không, gửi yêu cầu API đến OpenCage để lấy tọa độ.</li>
</ul>
</li>
<li>Cách hoạt động:
<ul>
<li>Sử dụng <code>requests.get</code> để gửi yêu cầu đến API của OpenCage.</li>
<li>Kết quả trả về được trích xuất từ JSON, lưu tọa độ (<code>latitude</code>, <code>longitude</code>) vào <code>cache</code> để sử dụng lại (nếu cần).</li>
<li>Nếu xảy ra lỗi, hàm sẽ xử lý ngoại lệ (<code>RequestException</code>) và trả về <code>(None, None)</code>.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Xử lý song song với <code>concurrent.futures.ThreadPoolExecutor</code>:</strong></p>
<ul>
<li><strong><code>ThreadPoolExecutor</code></strong>:
<ul>
<li>Đây là một lớp từ thư viện <code>concurrent.futures</code>, được thiết kế để thực hiện các tác vụ song song bằng cách sử dụng nhiều luồng (threads).</li>
<li>Trong trường hợp này, nó được sử dụng để tăng tốc việc gọi API geocoding, cho phép xử lý nhiều địa chỉ cùng lúc (cụ thể là 5 địa chỉ mỗi lần).</li>
</ul>
</li>
<li><strong>Tại sao dùng <code>ThreadPoolExecutor</code>?</strong>
<ul>
<li>Gọi API thường là một tác vụ I/O-bound, nghĩa là thời gian chờ phản hồi từ máy chủ chiếm phần lớn thời gian xử lý.</li>
<li>Bằng cách chạy các yêu cầu API đồng thời (concurrently), tổng thời gian xử lý sẽ giảm đáng kể so với việc xử lý tuần tự (sử dụng một luồng duy nhất).</li>
</ul>
</li>
<li>Cách hoạt động:
<ul>
<li><code>executor.map</code> thực thi hàm <code>get_coordinates</code> cho từng địa chỉ trong cột <code>address</code>.</li>
<li>Mỗi địa chỉ được gửi đi như một yêu cầu API riêng biệt. Trong trường hợp này, <code>address</code> sẽ có dạng <code>"&lt;street&gt;, &lt;district&gt;, Ho Chi Minh"</code>.</li>
<li>Kết quả trả về là danh sách các tuple <code>(latitude, longitude)</code> tương ứng với từng địa chỉ.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Mục đích của phương thức <code>process_addresses_into_coordinations</code>:</p>
<ul>
<li>Xử lý dữ liệu địa chỉ phục vụ cho việc phân tích không gian và hiển thị trên bản đồ.</li>
<li>Tạo ra các feature mới <code>latitude</code> và <code>longitude</code> trong DataFrame để lưu trữ tọa độ vị trí và phục vụ cho việc xây dựng mô hình dự báo.</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>     <span class="token keyword keyword-def">def</span> <span class="token function">process_addresses_into_coordinations</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
         <span class="token triple-quoted-string string">"""
         Convert addresses into latitude and longitude coordinates using the OpenCage API.

         Parameters:
         - df: pd.DataFrame. The dataset with 'address' column.

         Returns:
         - pd.DataFrame. The dataset with added 'latitude' and 'longitude' columns.
         """</span>
         cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

         <span class="token keyword keyword-def">def</span> <span class="token function">get_coordinates</span><span class="token punctuation">(</span>address<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">:</span>
             <span class="token triple-quoted-string string">"""
             Get the latitude and longitude coordinates of an address.

             Parameters:
             - address: str. The address to geocode.

             Returns:
             - tuple. The latitude and longitude coordinates of the address.
             """</span>
             <span class="token comment"># Check if the address is already in the cache</span>
             <span class="token keyword keyword-if">if</span> address <span class="token keyword keyword-in">in</span> cache<span class="token punctuation">:</span>
                 <span class="token keyword keyword-return">return</span> cache<span class="token punctuation">[</span>address<span class="token punctuation">]</span>
             <span class="token comment"># Make the API call if not in the cache</span>
             url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://api.opencagedata.com/geocode/v1/json?q=</span><span class="token interpolation"><span class="token punctuation">{</span>address<span class="token punctuation">}</span></span><span class="token string">&amp;key=</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>api_key<span class="token punctuation">}</span></span><span class="token string">"</span></span>
             <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                 response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                 response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># Raise an exception for 4xx/5xx status codes</span>
                 data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># Parse the JSON response</span>
                 <span class="token keyword keyword-if">if</span> data<span class="token punctuation">[</span><span class="token string">'results'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                     location <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'results'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'geometry'</span><span class="token punctuation">]</span>
                     cache<span class="token punctuation">[</span>address<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>location<span class="token punctuation">[</span><span class="token string">'lat'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> location<span class="token punctuation">[</span><span class="token string">'lng'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                     <span class="token keyword keyword-return">return</span> location<span class="token punctuation">[</span><span class="token string">'lat'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> location<span class="token punctuation">[</span><span class="token string">'lng'</span><span class="token punctuation">]</span>
                 <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                     cache<span class="token punctuation">[</span>address<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
                     <span class="token keyword keyword-return">return</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>
             <span class="token keyword keyword-except">except</span> requests<span class="token punctuation">.</span>RequestException <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
                 <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error fetching data for </span><span class="token interpolation"><span class="token punctuation">{</span>address<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                 <span class="token keyword keyword-return">return</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>

         <span class="token comment"># Process addresses concurrently</span>
         <span class="token keyword keyword-with">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> executor<span class="token punctuation">:</span>
             results <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword keyword-lambda">lambda</span> x<span class="token punctuation">:</span> get_coordinates<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>x<span class="token punctuation">}</span></span><span class="token string">, Ho Chi Minh"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

         df<span class="token punctuation">[</span><span class="token string">'latitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'longitude'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>results<span class="token punctuation">)</span>
         <span class="token keyword keyword-return">return</span> df
</code></pre></li>
</ol>
</li>
<li>
<p><code>convert_boolean_to_numeric(self, df: pd.DataFrame)</code>: Phương thức này chuyển đổi dữ liệu boolean thành dạng số (0 và 1) để phục vụ cho việc xây dựng mô hình học máy. Trong một số trường hợp, dữ liệu boolean không thể trực tiếp sử dụng trong mô hình học máy, do đó việc chuyển đổi sang dạng số sẽ giúp mô hình hiểu được dữ liệu hơn.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>    <span class="token keyword keyword-def">def</span> <span class="token function">convert_boolean_to_numeric</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Convert boolean columns to numeric (0 and 1).

        Parameters:
        - df: pd.DataFrame. The dataset.

        Returns:
        - pd.DataFrame. The dataset with boolean columns converted to numeric.
        """</span>
        <span class="token keyword keyword-for">for</span> col <span class="token keyword keyword-in">in</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>dtype <span class="token operator">==</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
                df<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> df
</code></pre></li>
<li>
<p><code>handle_missing_values_by_using_models(self, df: pd.DataFrame, ...)</code>: Phương thức này được thiết kế để xử lý giá trị thiếu (<code>missing values</code>) trong dữ liệu bằng cách sử dụng các mô hình học máy (Machine Learning Models). Đây là một cách tiếp cận tiên tiến và hiệu quả so với việc sử dụng các phương pháp đơn giản như điền giá trị trung bình, trung vị, hoặc mode. Quy trình xử lý bao gồm:</p>
<ol>
<li>
<p>Nhập các tham số đầu vào:</p>
<ul>
<li><code>df</code>: DataFrame chứa dữ liệu cần xử lý.</li>
<li><code>input_cols</code>: Danh sách các cột đầu vào, được sử dụng làm đặc trưng (features) để xây dựng mô hình dự đoán.</li>
<li><code>cols_to_impute</code>: Danh sách các cột có giá trị bị thiếu cần được điền khuyết.</li>
</ul>
</li>
<li>
<p><strong>Hàm <code>myWeight</code></strong>: Hàm này được định nghĩa để cung cấp trọng số tùy chỉnh cho mô hình KNN (<code>KNeighborsClassifier</code>). Trọng số này giảm dần theo khoảng cách giữa các điểm dữ liệu:<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub><mo>=</mo><mi>exp</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mrow><mo>−</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi mathvariant="bold">x</mi><mo>−</mo><msub><mi mathvariant="bold">x</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><msubsup><mi mathvariant="normal">∣</mi><mn>2</mn><mn>2</mn></msubsup></mrow><msup><mi>σ</mi><mn>2</mn></msup></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">w_i = \exp \left( \frac{-||\mathbf{x} - \mathbf{x}_i||_2^2}{\sigma^2} \right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4411em;vertical-align:-0.95em;"></span><span class="mop">exp</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">∣∣</span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4519em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2481em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span><br>
<strong>Ý nghĩa của trọng số</strong>:</p>
<ul>
<li>Dựa trên công thức <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo>=</mo><msup><mi>e</mi><mrow><mo>−</mo><mfrac><msup><mtext>distances</mtext><mn>2</mn></msup><msup><mi>σ</mi><mn>2</mn></msup></mfrac></mrow></msup></mrow><annotation encoding="application/x-tex">w = e^{-\frac{\text{distances}^2}{\sigma^2}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2464em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.2464em;"><span style="top:-3.4534em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1329em;"><span style="top:-2.5062em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9384em;"><span style="top:-2.9384em;margin-right:0.1em;"><span class="pstrut" style="height:2.6444em;"></span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">distances</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0484em;"><span style="top:-3.0484em;margin-right:0.1em;"><span class="pstrut" style="height:2.6444em;"></span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4938em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span></span></span></span>, khoảng cách càng xa thì trọng số càng nhỏ.</li>
<li>Giá trị <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>σ</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> kiểm soát tốc độ giảm của trọng số. Trong trường hợp này, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>σ</mi><mn>2</mn></msup><mo>=</mo><mn>0.4</mn></mrow><annotation encoding="application/x-tex">\sigma^2 = 0.4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.4</span></span></span></span>.</li>
<li>Đảm bảo không có trọng số bằng 0 bằng cách thay thế giá trị nhỏ nhất bằng <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>5</mn></mrow></msup></mrow><annotation encoding="application/x-tex">10^{-5}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span>.</li>
</ul>
<p>Tham khảo thêm tại <a href="https://machinelearningcoban.com/2017/01/08/knn/">https://machinelearningcoban.com/2017/01/08/knn/</a>.</p>
</li>
<li>
<p><strong>Các mô hình được sử dụng</strong>: Các mô hình Machine Learning khác nhau được chuẩn bị trong dictionary <code>models</code>:</p>
<ul>
<li><strong>KNeighborsClassifier (KNN)</strong>: Sử dụng thuật toán tìm <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> lân cận với trọng số tùy chỉnh.</li>
<li><strong>LinearRegression</strong>: Hồi quy tuyến tính.</li>
<li><strong>DecisionTreeRegressor</strong>: Cây quyết định (Decision Tree) cho bài toán hồi quy.</li>
<li><strong>RandomForestRegressor</strong>: Rừng ngẫu nhiên với nhiều cây quyết định.</li>
<li><strong>GradientBoostingRegressor</strong>: Gradient Boosting, một thuật toán mạnh mẽ cho các bài toán hồi quy và là một cải thiện của thuật toán Random Forest.</li>
</ul>
</li>
<li>
<p><strong>Quy trình xử lý cho mỗi cột trong <code>cols_to_impute</code>:</strong></p>
<ol>
<li>
<p><strong>Tách dữ liệu</strong>:</p>
<ul>
<li><code>df_known</code>: Các dòng không có giá trị thiếu trong cột đang xử lý.</li>
<li><code>df_unknown</code>: Các dòng có giá trị thiếu trong cột đang xử lý. Nếu <code>df_unknown</code> rỗng (không có giá trị thiếu), bỏ qua cột này.</li>
</ul>
</li>
<li>
<p><strong>Xây dựng tập dữ liệu</strong>:</p>
<ul>
<li><code>X_known</code> và <code>y_known</code>: Tập dữ liệu đầu vào và nhãn từ các dòng không bị thiếu.</li>
<li>Sử dụng <code>train_test_split</code> để chia <code>X_known</code> và <code>y_known</code> thành tập huấn luyện và kiểm tra.</li>
</ul>
</li>
<li>
<p><strong>Chuẩn hóa dữ liệu</strong>: Dùng <code>StandardScaler</code> để chuẩn hóa các đặc trưng trong tập <code>X_known</code> và <code>X_unknown</code>.</p>
</li>
<li>
<p><strong>Huấn luyện và chọn mô hình tốt nhất</strong>:</p>
<ul>
<li>Huấn luyện tất cả các mô hình trên tập huấn luyện.</li>
<li>Dự đoán trên tập kiểm tra và tính toán Mean Squared Error (MSE):<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>MSE</mtext><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>−</mo><msub><mover accent="true"><mi>y</mi><mo>^</mo></mover><mi>i</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\text{MSE} = \frac{1}{n} \sum_{i=1}^{n} (y_i - \hat{y}_i)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">MSE</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></li>
<li>Lựa chọn mô hình có MSE nhỏ nhất làm mô hình tốt nhất.</li>
</ul>
</li>
<li>
<p><strong>Điền giá trị thiếu</strong>:</p>
<ul>
<li>Huấn luyện mô hình tốt nhất trên toàn bộ <code>X_known</code> và <code>y_known</code>.</li>
<li>Dự đoán giá trị cho <code>X_unknown</code> (dòng có giá trị thiếu).</li>
<li>Điền các giá trị dự đoán vào cột tương ứng trong DataFrame ban đầu.</li>
</ul>
</li>
<li>
<p>Phương thức trả về DataFrame với các giá trị bị thiếu trong <code>cols_to_impute</code> đã được điền khuyết bằng các giá trị dự đoán từ mô hình tốt nhất.</p>
</li>
</ol>
</li>
<li>
<p><strong>Tại sao sử dụng cách này?</strong></p>
<ol>
<li>
<p><strong>Ưu điểm so với các phương pháp truyền thống</strong>:</p>
<ul>
<li>Các giá trị bị thiếu được điền dựa trên mối quan hệ giữa các đặc trưng khác, không phải chỉ dùng các giá trị trung bình hoặc mode.</li>
<li>Phương pháp này đặc biệt hữu ích với dữ liệu phức tạp hoặc dữ liệu có mối quan hệ phi tuyến tính giữa các đặc trưng.</li>
</ul>
</li>
<li>
<p><strong>Tính linh hoạt</strong>: Có thể sử dụng nhiều loại mô hình khác nhau (KNN, Random Forest, Gradient Boosting, v.v.) để phù hợp với bản chất dữ liệu.</p>
</li>
<li>
<p><strong>Tự động chọn mô hình tốt nhất</strong> bằng cách tính toán MSE trên tập kiểm tra, phương thức đảm bảo rằng mô hình được sử dụng có hiệu suất tốt nhất cho dữ liệu hiện tại.</p>
</li>
</ol>
</li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>    <span class="token keyword keyword-def">def</span> <span class="token function">handle_missing_values_by_using_models</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> input_cols<span class="token punctuation">:</span> <span class="token builtin">list</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cols_to_impute<span class="token punctuation">:</span> <span class="token builtin">list</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Impute missing values in specified columns using predictive models (KNN, Linear Regression, etc.).

        Parameters:
        - df: pd.DataFrame. The dataset.
        - input_cols: list of str. The input columns for building predictive models.
        - cols_to_impute: list of str. Columns to impute missing values.

        Returns:
        - pd.DataFrame. The dataset with missing values imputed.
        """</span>
        <span class="token keyword keyword-def">def</span> <span class="token function">myWeight</span><span class="token punctuation">(</span>distances<span class="token punctuation">:</span> np<span class="token punctuation">.</span>array<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> np<span class="token punctuation">.</span>array<span class="token punctuation">:</span>
            <span class="token triple-quoted-string string">"""
            Custom weight function for KNN model.
            
            Parameters:
            - distances: np.array. The distances between points.

            Returns:
            - np.array. The weights for the distances.
            """</span>
            sigma2 <span class="token operator">=</span> <span class="token number">.4</span>
            weights <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span>distances<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">/</span> sigma2<span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>weights <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">,</span> weights<span class="token punctuation">)</span>  <span class="token comment"># Ensure no zero weights</span>

        models <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'knn'</span><span class="token punctuation">:</span> KNeighborsClassifier<span class="token punctuation">(</span>n_neighbors<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> weights<span class="token operator">=</span>myWeight<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'linear_reg'</span><span class="token punctuation">:</span> LinearRegression<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'decision_tree'</span><span class="token punctuation">:</span> DecisionTreeRegressor<span class="token punctuation">(</span>max_depth<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'random_forest'</span><span class="token punctuation">:</span> RandomForestRegressor<span class="token punctuation">(</span>n_estimators<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> max_depth<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'gradient_boosting'</span><span class="token punctuation">:</span> GradientBoostingRegressor<span class="token punctuation">(</span>n_estimators<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> max_depth<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-for">for</span> col <span class="token keyword keyword-in">in</span> cols_to_impute<span class="token punctuation">:</span>
            <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Imputing for column: </span><span class="token interpolation"><span class="token punctuation">{</span>col<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            df_impute <span class="token operator">=</span> df<span class="token punctuation">[</span>input_cols<span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            df_impute<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span>

            df_known <span class="token operator">=</span> df_impute<span class="token punctuation">.</span>dropna<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span>
            df_unknown <span class="token operator">=</span> df_impute<span class="token punctuation">[</span>df_impute<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

            <span class="token keyword keyword-if">if</span> df_unknown<span class="token punctuation">.</span>empty<span class="token punctuation">:</span>
                <span class="token keyword keyword-continue">continue</span>

            X_known <span class="token operator">=</span> df_known<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span>
            y_known <span class="token operator">=</span> df_known<span class="token punctuation">[</span>col<span class="token punctuation">]</span>

            X_train<span class="token punctuation">,</span> X_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_test <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>X_known<span class="token punctuation">,</span> y_known<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>

            scaler <span class="token operator">=</span> StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
            X_train_scaled <span class="token operator">=</span> scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>X_train<span class="token punctuation">)</span>
            X_test_scaled <span class="token operator">=</span> scaler<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span>

            best_model <span class="token operator">=</span> <span class="token boolean">None</span>
            lowest_error <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'inf'</span><span class="token punctuation">)</span>

            <span class="token keyword keyword-for">for</span> model_name<span class="token punctuation">,</span> model <span class="token keyword keyword-in">in</span> models<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train_scaled<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
                y_pred <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_test_scaled<span class="token punctuation">)</span>
                error <span class="token operator">=</span> mean_squared_error<span class="token punctuation">(</span>y_test<span class="token punctuation">,</span> y_pred<span class="token punctuation">)</span>

                <span class="token keyword keyword-if">if</span> error <span class="token operator">&lt;</span> lowest_error<span class="token punctuation">:</span>
                    best_model <span class="token operator">=</span> model
                    lowest_error <span class="token operator">=</span> error

                <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>model_name<span class="token punctuation">}</span></span><span class="token string"> MSE for </span><span class="token interpolation"><span class="token punctuation">{</span>col<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>error<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

            <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Best model for </span><span class="token interpolation"><span class="token punctuation">{</span>col<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>best_model<span class="token punctuation">}</span></span><span class="token string"> with MSE: </span><span class="token interpolation"><span class="token punctuation">{</span>lowest_error<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"-----------------------------------"</span><span class="token punctuation">)</span>

            best_model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>X_known<span class="token punctuation">)</span><span class="token punctuation">,</span> y_known<span class="token punctuation">)</span>
            X_unknown_scaled <span class="token operator">=</span> scaler<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>df_unknown<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            y_unknown_pred <span class="token operator">=</span> best_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_unknown_scaled<span class="token punctuation">)</span>

            df<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> col<span class="token punctuation">]</span> <span class="token operator">=</span> y_unknown_pred

        <span class="token keyword keyword-return">return</span> df
</code></pre></li>
<li>
<p><code>apply_log_transformation(self, df: pd.DataFrame, columns: list)</code>: Phương thức này thực hiện việc biến đổi log lên các cột có phân phối lệch (skewed). Mục đích chính của việc này là giảm mức độ ảnh hưởng của các outliers và làm cho phân phối dữ liệu trở nên “near normal” hơn, giúp các mô hình học máy hoặc các phân tích thống kê hoạt động hiệu quả hơn. Quy trình xử lý bao gồm:</p>
<ol>
<li>
<p><strong>Xác định độ lệch (skewness)</strong>:</p>
<ul>
<li>Bên trong phương thức có một hàm nội bộ <code>find_skewness</code> dùng để tính toán độ lệch của một cột thông qua phương thức <code>skew()</code> của <code>pandas</code>.</li>
<li>Skewness đo lường độ bất đối xứng của phân phối dữ liệu.
<ul>
<li>Giá trị <code>skewness &gt; 0</code>: Phân phối lệch phải (right-skewed).</li>
<li>Giá trị <code>skewness &lt; 0</code>: Phân phối lệch trái (left-skewed).</li>
<li>Giá trị tuyệt đối càng lớn, dữ liệu càng lệch mạnh so với phân phối chuẩn.</li>
</ul>
</li>
<li>Một ngưỡng điển hình là <code>skewness &gt; 0.75</code> được coi là lệch cao và cần được điều chỉnh.</li>
</ul>
</li>
<li>
<p><strong>Áp dụng biến đổi log</strong>:</p>
<ul>
<li>Nếu độ lệch của một cột vượt quá 0.75, phương thức sẽ áp dụng hàm <code>np.log1p</code> lên cột đó.</li>
<li><code>np.log1p(x)</code> tương đương với <code>log(x+1)</code>, điều này giúp tránh lỗi khi dữ liệu có giá trị bằng 0 (log(0) không xác định được).</li>
<li>Sau biến đổi log, phân phối dữ liệu thường trở nên cân bằng hơn, giảm độ lệch, và hạn chế ảnh hưởng của ngoại lai.</li>
</ul>
</li>
<li>
<p><strong>Hạn chế áp dụng lên kiểu dữ liệu không phù hợp</strong>:</p>
<ul>
<li>Phương thức chỉ áp dụng log transform với các cột dạng số (<code>int64</code> hoặc <code>float64</code>).</li>
<li>Điều này đảm bảo không thực hiện biến đổi không phù hợp với dữ liệu dạng chuỗi, danh mục, hoặc kiểu boolean.</li>
</ul>
</li>
</ol>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/c/cc/Relationship_between_mean_and_median_under_different_skewness.png" alt="Log transform"><br>
<em>Hình 2: Minh họa sự thay đổi giữa trung bình và trung vị khi dữ liệu lệch phải và sau khi áp dụng log transform</em></p>
<p>Lợi ích chính của việc làm này là giảm độ lệch giúp nâng cao hiệu suất mô hình hồi quy hoặc mô hình tuyến tính, vốn thường giả định dữ liệu gần với phân phối chuẩn. Ngoài ra, log transform còn giúp tăng tính ổn định và độ tin cậy của các phép thống kê, đặc biệt trong phân tích dữ liệu định lượng.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>    <span class="token keyword keyword-def">def</span> <span class="token function">apply_log_transformation</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> columns<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Apply log transformation to skewed columns to reduce the effect of outliers.

        Parameters:
        - df: pd.DataFrame. The dataset.
        - columns: list of str. The columns to apply log transformation.

        Returns:
        - pd.DataFrame. The dataset with log transformation applied to skewed columns.
        """</span>
        <span class="token keyword keyword-def">def</span> <span class="token function">find_skewness</span><span class="token punctuation">(</span>col<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
            <span class="token triple-quoted-string string">"""
            Calculate the skewness of a column.

            Parameters:
            - col: pd.Series. The column to calculate skewness.

            Returns:
            - float. The skewness of the column.
            """</span>
            <span class="token keyword keyword-return">return</span> col<span class="token punctuation">.</span>skew<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Skewness &gt; 0.75 is considered highly skewed</span>

        <span class="token keyword keyword-for">for</span> col <span class="token keyword keyword-in">in</span> columns<span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>dtype <span class="token operator">==</span> <span class="token string">'int64'</span> <span class="token keyword keyword-or">or</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>dtype <span class="token operator">==</span> <span class="token string">'float64'</span><span class="token punctuation">:</span>
                skewness <span class="token operator">=</span> find_skewness<span class="token punctuation">(</span>df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-if">if</span> skewness <span class="token operator">&gt;</span> <span class="token number">0.75</span><span class="token punctuation">:</span>
                    df<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>log1p<span class="token punctuation">(</span>df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> df
</code></pre></li>
<li>
<p><code>clean_data(self, df: pd.DataFrame, ...)</code>: Phương thức <code>clean_data</code> trong lớp <code>DataCleaner</code> đóng vai trò là hàm xử lý tổng thể (pipeline) cho quá trình làm sạch và chuẩn hóa dữ liệu. Phương thức này gói gọn nhiều bước xử lý quan trọng thành một quy trình liên tục, giúp người dùng dễ dàng tiền xử lý dữ liệu mà không phải lặp lại nhiều bước thủ công.</p>
<p>Cụ thể, khi gọi đến <code>clean_data</code>, người dùng cung cấp một DataFrame cùng với một số thông tin và tham số liên quan (cột mục tiêu <code>target_col</code>, danh sách cột cần xóa nếu thiếu dữ liệu <code>drop_na_cols</code>, cột dùng cho việc điền giá trị thiếu <code>input_cols</code>, và các cột cần điền khuyết <code>cols_to_impute</code>). Quy trình xử lý dữ liệu sẽ được thực hiện theo các bước sau:</p>
<ol>
<li><strong>Loại bỏ ngoại lai</strong>: Áp dụng quy tắc dựa trên IQR để loại trừ các điểm dữ liệu nằm quá xa phân vị thứ nhất và thứ ba.</li>
<li><strong>Xử lý địa chỉ</strong>: Ghép các trường thông tin (như <code>street</code> và <code>district</code>) để tạo thành địa chỉ đầy đủ, sau đó chuyển đổi địa chỉ này thành tọa độ vĩ độ và kinh độ thông qua API geocoding.</li>
<li><strong>Xử lý dữ liệu trùng lặp và thiếu</strong>:
<ul>
<li>Loại bỏ các dòng trùng lặp.</li>
<li>Loại bỏ các dòng thiếu dữ liệu ở những cột quan trọng.</li>
<li>Chuyển đổi dữ liệu Boolean thành dạng số.</li>
<li>Sử dụng các mô hình học máy để dự đoán và điền giá trị thiếu cho những cột cần thiết.</li>
</ul>
</li>
<li><strong>Tiếp tục loại bỏ ngoại lai</strong>: Sau khi dữ liệu được bổ sung, tiến hành loại bỏ ngoại lai một lần nữa để dữ liệu trở nên sạch hơn.</li>
<li><strong>Biểu diễn dữ liệu</strong>: Tạo biểu đồ histogram để quan sát sự phân bố dữ liệu, giúp xác định xem có cột nào cần áp dụng log transform để giảm độ skew hay không.</li>
<li><strong>Xử lý cột phân phối lệch (skewed)</strong>: Nếu người dùng xác nhận sự tồn tại của các cột lệch, tiến hành log transform để làm giảm ảnh hưởng của ngoại lai và cải thiện phân phối dữ liệu.</li>
</ol>
<p>Tóm lại, <code>clean_data</code> là nơi “điều phối” hầu hết các bước tiền xử lý dữ liệu, từ lọc nhiễu, xử lý thiếu dữ liệu, đến biến đổi đặc trưng, giúp dữ liệu trở nên “sẵn sàng” hơn cho giai đoạn phân tích, mô hình hóa tiếp theo.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>    <span class="token keyword keyword-def">def</span> <span class="token function">clean_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> target_col<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> drop_na_cols<span class="token punctuation">:</span> <span class="token builtin">list</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> input_cols<span class="token punctuation">:</span> <span class="token builtin">list</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cols_to_impute<span class="token punctuation">:</span> <span class="token builtin">list</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Clean the dataset by removing outliers, imputing missing values, 
        and processing addresses into coordinates.

        Parameters:
        - df: pd.DataFrame. The dataset to clean.
        - target_col: str. The target column used for outlier detection.
        - input_cols: list of str. Columns used as input for imputing missing values.
        - cols_to_impute: list of str. Columns where missing values will be imputed.

        Returns:
        - pd.DataFrame. The cleaned dataset.
        """</span>
        df <span class="token operator">=</span> self<span class="token punctuation">.</span>drop_outliers<span class="token punctuation">(</span>df<span class="token punctuation">,</span> <span class="token punctuation">[</span>target_col<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># Merge 'street' and 'district' columns, handling NaN values</span>
        df<span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'street'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">', '</span> <span class="token operator">+</span> df<span class="token punctuation">[</span><span class="token string">'district'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
        df<span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'^, |, $'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> regex<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        df <span class="token operator">=</span> self<span class="token punctuation">.</span>process_addresses_into_coordinations<span class="token punctuation">(</span>df<span class="token punctuation">)</span>
        df <span class="token operator">=</span> df<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span><span class="token punctuation">)</span>

        drop_na_cols<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"latitude"</span><span class="token punctuation">,</span> <span class="token string">"longitude"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        df <span class="token operator">=</span> df<span class="token punctuation">.</span>dropna<span class="token punctuation">(</span>subset<span class="token operator">=</span>drop_na_cols<span class="token punctuation">)</span>

        df <span class="token operator">=</span> self<span class="token punctuation">.</span>convert_boolean_to_numeric<span class="token punctuation">(</span>df<span class="token punctuation">)</span>
        input_cols<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"latitude"</span><span class="token punctuation">,</span> <span class="token string">"longitude"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        df <span class="token operator">=</span> self<span class="token punctuation">.</span>handle_missing_values_by_using_models<span class="token punctuation">(</span>df<span class="token punctuation">,</span> input_cols<span class="token punctuation">,</span> cols_to_impute<span class="token punctuation">)</span>
        df <span class="token operator">=</span> self<span class="token punctuation">.</span>drop_outliers<span class="token punctuation">(</span>df<span class="token punctuation">,</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>

        df<span class="token punctuation">.</span>hist<span class="token punctuation">(</span>bins<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

        answer_for_skewed_cols <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"Are there any skewed columns that need log transformation? (y/n): "</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> answer_for_skewed_cols<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'y'</span><span class="token punctuation">:</span>
            skewed_cols <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"Enter the names of the skewed columns separated by commas: "</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
            skewed_cols <span class="token operator">=</span> <span class="token punctuation">[</span>col<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> col <span class="token keyword keyword-in">in</span> skewed_cols<span class="token punctuation">]</span>  <span class="token comment"># Remove leading/trailing whitespaces</span>
            
            df <span class="token operator">=</span> self<span class="token punctuation">.</span>apply_log_transformation<span class="token punctuation">(</span>df<span class="token punctuation">,</span> skewed_cols<span class="token punctuation">)</span>

            <span class="token keyword keyword-for">for</span> col <span class="token keyword keyword-in">in</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
                <span class="token keyword keyword-if">if</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>dtype <span class="token operator">==</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
                    df<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>inf<span class="token punctuation">,</span> <span class="token operator">-</span>np<span class="token punctuation">.</span>inf<span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>nan<span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> df
</code></pre></li>
</ul>
<h3 id="33-các-hàm-khác">3.3. Các hàm khác </h3>
<ul>
<li>
<p><code>del_col(df: pd.DataFrame, columns: list)</code>: Hàm <code>del_col</code> là một hàm dùng để xóa một số cột ra khỏi DataFrame. Việc loại bỏ cột thường cần thiết khi chúng ta muốn tinh gọn dữ liệu, loại bỏ dữ liệu không liên quan, hoặc chuẩn bị dữ liệu (tùy ý) cho các bước phân tích tiếp theo. Quy trình xử lý bao gồm:</p>
<ol>
<li>
<p><strong>Xóa các cột dạng object (chuỗi, ký tự, v.v.)</strong>: Đầu tiên, hàm sẽ duyệt qua tất cả các cột trong DataFrame.</p>
<ul>
<li>Nếu phát hiện cột có kiểu dữ liệu là <code>object</code> (thường là dạng chuỗi, văn bản), hàm sẽ xóa cột đó ngay lập tức.</li>
<li>Mục đích: Trong nhiều trường hợp, dữ liệu dạng object có thể không cần thiết cho quá trình phân tích hoặc mô hình hoá, hoặc có thể cần được xử lý riêng (như mã hoá thành số) trước khi sử dụng.</li>
</ul>
</li>
<li>
<p><strong>Xóa các cột trong danh sách truyền vào</strong>: Sau khi loại bỏ các cột dạng object, hàm tiếp tục xóa những cột được chỉ định trong tham số <code>columns</code>.</p>
<ul>
<li>Người dùng có thể truyền vào danh sách tên các cột muốn xóa.</li>
<li>Hàm sẽ xóa từng cột trong danh sách đó, nếu chúng tồn tại trong DataFrame.</li>
</ul>
</li>
<li>
<p>Cuối cùng, hàm trả về DataFrame sau khi đã loại bỏ các cột object và các cột do người dùng yêu cầu.</p>
</li>
</ol>
<p>Tóm lại, <code>del_col</code> hỗ trợ bạn nhanh chóng loại bỏ các cột không mong muốn, giúp tập dữ liệu trở nên dễ quản lý hơn và phù hợp với mục đích phân tích, tiền xử lý hoặc mô hình hoá tiếp theo.</p>
</li>
</ul>
<h3 id="34-chạy-chương-trình">3.4. Chạy chương trình </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-from">from</span> data_cleaner <span class="token keyword keyword-import">import</span> DataCleaner<span class="token punctuation">,</span> del_col
</code></pre><ol>
<li>
<p>Đầu tiên, ta cần thực hiện lấy API Key từ OpenCage để sử dụng dịch vụ geocoding. Đăng ký tài khoản và lấy API Key tại <a href="https://opencagedata.com/">OpenCage API</a>.</p>
</li>
<li>
<p>Tiếp theo, truyền API Key vào lớp <code>DataCleaner</code> và khởi tạo một đối tượng từ lớp này.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>data_cleaner <span class="token operator">=</span> DataCleaner<span class="token punctuation">(</span>api_key<span class="token operator">=</span><span class="token string">"cfb14e7f5ab043e99707a032f1a968bb"</span><span class="token punctuation">)</span>
</code></pre></li>
<li>
<p>Gọi phương thức <code>clean_data</code> để xử lý dữ liệu.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>df_cleaned <span class="token operator">=</span> data_cleaner<span class="token punctuation">.</span>clean_data<span class="token punctuation">(</span>
    df<span class="token operator">=</span>df<span class="token punctuation">,</span>
    target_col<span class="token operator">=</span><span class="token string">'price'</span><span class="token punctuation">,</span>
    drop_na_cols<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"price"</span><span class="token punctuation">,</span> <span class="token string">"area"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    input_cols<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">,</span> <span class="token string">'area'</span><span class="token punctuation">,</span> <span class="token string">'car_place'</span><span class="token punctuation">,</span> <span class="token string">'facade'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    cols_to_impute<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'bedrooms'</span><span class="token punctuation">,</span> <span class="token string">'wc'</span><span class="token punctuation">,</span> <span class="token string">'n_floors'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre><p>Trong trường hợp này, tôi truyền vào các tham số như sau:</p>
<ul>
<li><code>df</code>: DataFrame chứa dữ liệu cần xử lý.</li>
<li><code>target_col</code>: Cột mục tiêu dùng để xác định ngoại lai. Ở đây, tôi chọn cột <code>price</code> làm cột mục tiêu.</li>
<li><code>drop_na_cols</code>: Danh sách các cột cần kiểm tra và loại bỏ dòng thiếu dữ liệu. Ở đây, tôi chọn <code>price</code> và <code>area</code> làm cột không được thiếu dữ liệu.</li>
<li><code>input_cols</code>: Danh sách các cột dùng để xây dựng mô hình dự báo giá trị thiếu. Ở đây, tôi chọn các cột <code>price</code>, <code>area</code>, <code>car_place</code>, và <code>facade</code>.</li>
<li><code>cols_to_impute</code>: Danh sách các cột cần điền giá trị thiếu. Ở đây, tôi chọn các cột <code>bedrooms</code>, <code>wc</code>, và <code>n_floors</code>.</li>
</ul>
</li>
<li>
<p>Kết quả trả về sẽ là đánh giá cho các models được sử dụng để điền giá trị thiếu, và DataFrame đã được xử lý:</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Imputing for column: bedrooms
knn MSE for bedrooms: 2.4667
linear_reg MSE for bedrooms: 2.1670
decision_tree MSE for bedrooms: 2.7457
random_forest MSE for bedrooms: 2.4779
gradient_boosting MSE for bedrooms: 2.4261
Best model for bedrooms: LinearRegression() with MSE: 2.1670
-----------------------------------
Imputing for column: wc
knn MSE for wc: 2.9732
linear_reg MSE for wc: 1.9929
decision_tree MSE for wc: 2.2317
random_forest MSE for wc: 1.8329
gradient_boosting MSE for wc: 2.0864
Best model for wc: RandomForestRegressor(max_depth=10, n_jobs=-1, random_state=42) with MSE: 1.8329
-----------------------------------
Imputing for column: n_floors
knn MSE for n_floors: 4.9824
linear_reg MSE for n_floors: 9.5099
decision_tree MSE for n_floors: 16.0299
random_forest MSE for n_floors: 39.8623
gradient_boosting MSE for n_floors: 7.6524
Best model for n_floors: KNeighborsClassifier(n_neighbors=12,
                    weights=&lt;function DataCleaner.handle_missing_values_by_using_models.&lt;locals&gt;.myWeight at 0x13d3f8540&gt;) with MSE: 4.9824
-----------------------------------
</code></pre><p>Kết quả này cho thấy mô hình Linear Regression tốt cho cột <code>bedrooms</code>, Random Forest tốt cho cột <code>wc</code>, và KNN tốt cho cột <code>n_floors</code>.<br>
<br>
Sau đó, chúng ta sẽ được yêu cầu "Are there any skewed columns that need log transformation? (y/n):". Nếu ta muốn áp dụng log transform cho một số cột, trong trường hợp này tôi trả lời là "n". Tuy nhiên, nếu bạn muốn áp dụng log transform, hãy trả lời "y" và nhập tên các cột cần áp dụng log transform, cách nhau bởi dấu phẩy. Ví dụ:</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Are there any skewed columns that need log transformation? (y/n): y
Enter the names of the skewed columns separated by commas: price, area, facade
</code></pre><p><img src="./images/data_processing.png" alt="Data Processing"></p>
<p><em>Hình 3: Biểu đồ histogram của dữ liệu sau khi xử lý</em></p>
</li>
<li>
<p>Cuối cùng, tôi sẽ xóa các cột không cần thiết khỏi DataFrame bằng cách sử dụng hàm <code>del_col</code>.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>df_cleaned <span class="token operator">=</span> del_col<span class="token punctuation">(</span>df_cleaned<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'facade'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><p>Cột <code>facade</code> đã được xóa khỏi DataFrame bởi vì chứa dữ liệu không thực sự được xác thực và có khả năng gây ra nhiễu cho mô hình. Ngoài ra, các cột dạng object cũng đã được xóa khỏi DataFrame để giảm kích thước dữ liệu như đã trình bày trước đó.</p>
<p>Kết quả cuối cùng sẽ là DataFrame đã được xử lý và lưu vào thư mục <code>datasets</code> với tên file <code>housing_cleaned.csv</code>.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>df_cleaned<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'./datasets/housing_cleaned.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
data_cleaned <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'./datasets/housing_cleaned.csv'</span><span class="token punctuation">)</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>data_cleaned<span class="token punctuation">)</span>
</code></pre><p>Kết quả của DataFrame:</p>
<table>
<thead>
<tr>
<th></th>
<th>id</th>
<th>price</th>
<th>area</th>
<th>bedrooms</th>
<th>wc</th>
<th>n_floors</th>
<th>car_place</th>
<th>latitude</th>
<th>longitude</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>121356</td>
<td>0.790</td>
<td>57</td>
<td>2.000000</td>
<td>2.000000</td>
<td>1.0</td>
<td>0</td>
<td>10.713820</td>
<td>106.589326</td>
</tr>
<tr>
<td>1</td>
<td>115827</td>
<td>2.600</td>
<td>16</td>
<td>4.000000</td>
<td>3.000000</td>
<td>3.0</td>
<td>0</td>
<td>10.767127</td>
<td>106.659121</td>
</tr>
<tr>
<td>2</td>
<td>115833</td>
<td>3.000</td>
<td>32</td>
<td>4.000000</td>
<td>2.069591</td>
<td>5.0</td>
<td>1</td>
<td>10.745886</td>
<td>106.639292</td>
</tr>
<tr>
<td>3</td>
<td>115834</td>
<td>4.600</td>
<td>38</td>
<td>4.000000</td>
<td>4.000000</td>
<td>4.0</td>
<td>1</td>
<td>10.755202</td>
<td>106.637447</td>
</tr>
<tr>
<td>4</td>
<td>115837</td>
<td>3.450</td>
<td>76</td>
<td>4.000000</td>
<td>4.000000</td>
<td>1.0</td>
<td>1</td>
<td>10.867853</td>
<td>106.623154</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>5828</td>
<td>88818</td>
<td>9.500</td>
<td>46</td>
<td>4.000000</td>
<td>4.000000</td>
<td>4.0</td>
<td>1</td>
<td>10.791831</td>
<td>106.671614</td>
</tr>
<tr>
<td>5829</td>
<td>86770</td>
<td>1.950</td>
<td>48</td>
<td>2.000000</td>
<td>3.000000</td>
<td>1.0</td>
<td>0</td>
<td>10.710682</td>
<td>106.618825</td>
</tr>
<tr>
<td>5830</td>
<td>86258</td>
<td>10.200</td>
<td>56</td>
<td>3.000000</td>
<td>4.000000</td>
<td>3.0</td>
<td>1</td>
<td>10.801764</td>
<td>106.711032</td>
</tr>
<tr>
<td>5831</td>
<td>86002</td>
<td>6.200</td>
<td>47</td>
<td>4.000000</td>
<td>5.000000</td>
<td>5.0</td>
<td>1</td>
<td>10.819914</td>
<td>106.698770</td>
</tr>
<tr>
<td>5832</td>
<td>108530</td>
<td>0.001</td>
<td>30</td>
<td>1.695659</td>
<td>1.264540</td>
<td>2.0</td>
<td>0</td>
<td>10.852466</td>
<td>106.660611</td>
</tr>
</tbody>
</table>
<p>[5833 rows x 9 columns]</p>
</li>
</ol>
<h2 id="4-xử-lý-trực-quan-hóa-dữ-liệu-và-feature-engineering-với-visualizepy">4. Xử lý, trực quan hóa dữ liệu và Feature Engineering với <code>Visualize.py</code> </h2>
<h3 id="41-khai-báo-thư-viện">4.1. Khai báo thư viện </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
<span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
<span class="token keyword keyword-import">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword keyword-as">as</span> plt

<span class="token comment"># for creating a map</span>
<span class="token keyword keyword-import">import</span> folium 

 <span class="token comment"># for reading shapefiles</span>
<span class="token keyword keyword-import">import</span> fiona

<span class="token keyword keyword-from">from</span> haversine <span class="token keyword keyword-import">import</span> haversine
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>cluster <span class="token keyword keyword-import">import</span> KMeans

<span class="token comment"># for creating a color map</span>
<span class="token keyword keyword-from">from</span> branca<span class="token punctuation">.</span>colormap <span class="token keyword keyword-import">import</span> LinearColormap

<span class="token comment"># for checking if a point is within a polygon, Point is a class to represent a point, shape is a function to create a polygon from a GeoJSON object</span>
<span class="token keyword keyword-from">from</span> shapely<span class="token punctuation">.</span>geometry <span class="token keyword keyword-import">import</span> Point<span class="token punctuation">,</span> shape
<span class="token keyword keyword-from">from</span> folium<span class="token punctuation">.</span>plugins <span class="token keyword keyword-import">import</span> HeatMap
</code></pre><ul>
<li><code>folium</code>: Thư viện Python dùng để tạo bản đồ tương tác trên web.</li>
<li><code>fiona</code>: Thư viện Python dùng để đọc file shapefile.</li>
<li><code>haversine</code>: Thư viện Python dùng để tính khoảng cách giữa hai điểm trên trái đất.</li>
<li><code>KMeans</code>: Thư viện Python dùng để phân cụm dữ liệu.</li>
<li><code>LinearColormap</code>: Thư viện Python dùng để tạo bản đồ màu tuyến tính.</li>
<li><code>Point</code>, <code>shape</code>: Các hàm từ thư viện <code>shapely</code> dùng để xác định xem một điểm có nằm trong một đa giác hay không.</li>
<li><code>HeatMap</code>: Lớp từ thư viện <code>folium.plugins</code> dùng để tạo bản đồ nhiệt.</li>
</ul>
<h3 id="42-lọc-tọa-độ-theo-lãnh-thổ-việt-nam-với-hàm-check_coordinates_in_vietnam">4.2. Lọc tọa độ theo lãnh thổ Việt Nam với hàm <code>check_coordinates_in_vietnam</code> </h3>
<p>Hàm <code>check_coordinates_in_vietnam</code> có mục đích kiểm tra xem các điểm tọa độ (longitude, latitude) trong DataFrame về thông tin vị trí bất động sản có nằm trong lãnh thổ Việt Nam hay không. Kết quả trả về là một DataFrame chỉ chứa những tọa độ thuộc phạm vi lãnh thổ Việt Nam.</p>
<h4 id="421-tham-số-đầu-vào">4.2.1. Tham số đầu vào </h4>
<ul>
<li>
<p><code>shapefile_path: str</code>: Đường dẫn đến file shapefile chứa thông tin ranh giới lãnh thổ Việt Nam. Shapefile là một định dạng dữ liệu không gian (GIS) thường được sử dụng để lưu trữ các dạng hình học như đa giác, đường, điểm,... Trong trường hợp này, shapefile chứa đường biên giới quốc gia của Việt Nam.</p>
</li>
<li>
<p><code>housing_df: pd.DataFrame</code>: DataFrame chứa dữ liệu bất động sản, trong đó có các cột <code>longitude</code> (kinh độ) và <code>latitude</code> (vĩ độ).</p>
</li>
</ul>
<h4 id="422-các-bước-xử-lý-chính-trong-hàm">4.2.2. Các bước xử lý chính trong hàm </h4>
<ol>
<li>
<p><strong>Lấy danh sách tọa độ</strong>: Ở đây, hàm duyệt qua từng hàng trong <code>housing_df</code>, kết hợp <code>longitude</code> và <code>latitude</code> thành tuple <code>(longitude, latitude)</code> rồi đưa vào một danh sách <code>coordinates_list</code>.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>coordinates_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">(</span>longitude<span class="token punctuation">,</span> latitude<span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> longitude<span class="token punctuation">,</span> latitude
    <span class="token keyword keyword-in">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>housing_df<span class="token punctuation">[</span><span class="token string">'longitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> housing_df<span class="token punctuation">[</span><span class="token string">'latitude'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre></li>
<li>
<p><strong>Đọc shapefile và tạo polygon cho Việt Nam</strong>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-with">with</span> fiona<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>shapefile_path<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> shp<span class="token punctuation">:</span>
    geometries <span class="token operator">=</span> <span class="token punctuation">[</span>shape<span class="token punctuation">(</span>feature<span class="token punctuation">[</span><span class="token string">'geometry'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> feature <span class="token keyword keyword-in">in</span> shp<span class="token punctuation">]</span>
    vietnam_shape <span class="token operator">=</span> geometries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> 
</code></pre><ul>
<li><code>fiona.open(shapefile_path)</code> dùng để mở file shapefile. Fiona là một thư viện Python chuyên để thao tác với dữ liệu GIS.</li>
<li><code>shape(feature['geometry'])</code> (từ shapely) chuyển dữ liệu hình học dạng GeoJSON thành một đối tượng hình học tương ứng (ví dụ: Polygon).</li>
<li><code>geometries</code> sẽ là một danh sách các đối tượng hình học (thường một shapefile có thể chứa nhiều feature - mỗi feature là một hình học).</li>
<li>Ở đây, file shapefile chứa một vùng duy nhất đại diện cho lãnh thổ Việt Nam, do đó <code>vietnam_shape = geometries[0]</code> là polygon mô tả ranh giới Việt Nam.</li>
</ul>
<p>Tham khảo thêm tại <a href="https://www.igismap.com/vietnam-shapefile-download-country-boundaryline-polygon/">https://www.igismap.com/vietnam-shapefile-download-country-boundaryline-polygon/</a>.</p>
</li>
<li>
<p><strong>Lọc các tọa độ nằm trong lãnh thổ Việt Nam</strong>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>coordinates_in_vietnam <span class="token operator">=</span> <span class="token punctuation">[</span>
    coordinate
    <span class="token keyword keyword-for">for</span> coordinate <span class="token keyword keyword-in">in</span> coordinates_list
    <span class="token keyword keyword-if">if</span> Point<span class="token punctuation">(</span>coordinate<span class="token punctuation">)</span><span class="token punctuation">.</span>within<span class="token punctuation">(</span>vietnam_shape<span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre><ul>
<li>Tạo một đối tượng <code>Point</code> từ <code>coordinate</code>.</li>
<li>Dùng phương thức <code>within()</code> của shapely để kiểm tra xem điểm đó có nằm trong đa giác <code>vietnam_shape</code> hay không.</li>
<li>Chỉ giữ lại những tọa độ thoả mãn điều kiện nằm trong.</li>
</ul>
</li>
<li>
<p><strong>Xác định index của những điểm hợp lệ và trả về DataFrame</strong>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>indices_in_vietnam <span class="token operator">=</span> housing_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'longitude'</span><span class="token punctuation">,</span> <span class="token string">'latitude'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token builtin">tuple</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span>coordinates_in_vietnam<span class="token punctuation">)</span>
<span class="token keyword keyword-return">return</span> housing_df<span class="token punctuation">[</span>indices_in_vietnam<span class="token punctuation">]</span>
</code></pre><ul>
<li><code>housing_df[['longitude', 'latitude']].apply(tuple, axis=1)</code> chuyển từng hàng trong DataFrame thành tuple <code>(longitude, latitude)</code> tương ứng với <code>coordinates_in_vietnam</code>.</li>
<li><code>isin(coordinates_in_vietnam)</code> trả về một mảng boolean, True tại những hàng có tọa độ nằm trong lãnh thổ Việt Nam.</li>
<li><code>housing_df[indices_in_vietnam]</code> lọc DataFrame và chỉ giữ lại các hàng hợp lệ.</li>
</ul>
</li>
</ol>
<p><strong>Ý nghĩa thực tiễn</strong>:</p>
<p>Khi xử lý dữ liệu bất động sản (hoặc bất kỳ dữ liệu địa lý) trên phạm vi lớn, có thể có nhiều điểm dữ liệu bị sai lệch hoặc không hợp lệ (ví dụ: tọa độ nằm ngoài biên giới quốc gia mong muốn). Hàm <code>check_coordinates_in_vietnam</code> giúp "làm sạch" dữ liệu bằng cách lọc bỏ những điểm không thuộc khu vực cần phân tích, từ đó giúp các thao tác phân tích và trực quan hóa tiếp theo được chính xác và tập trung hơn.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">check_coordinates_in_vietnam</span><span class="token punctuation">(</span>shapefile_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> housing_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Check if the coordinates in the housing DataFrame are within Vietnam's territory.

    Parameters:
        shapefile_path (str): The path to the shapefile containing the territory of Vietnam.
        housing_df (pd.DataFrame): The DataFrame containing the housing data.

    Returns:
        pd.DataFrame: The DataFrame containing the housing data with coordinates within Vietnam's territory.
    """</span>
    <span class="token comment"># List of coordinates to check</span>
    coordinates_list <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">(</span>longitude<span class="token punctuation">,</span> latitude<span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> longitude<span class="token punctuation">,</span> latitude
        <span class="token keyword keyword-in">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>housing_df<span class="token punctuation">[</span><span class="token string">'longitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> housing_df<span class="token punctuation">[</span><span class="token string">'latitude'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>

    <span class="token comment"># Open the shapefile and get the polygon representing Vietnam's territory</span>
    <span class="token keyword keyword-with">with</span> fiona<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>shapefile_path<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> shp<span class="token punctuation">:</span>
        geometries <span class="token operator">=</span> <span class="token punctuation">[</span>shape<span class="token punctuation">(</span>feature<span class="token punctuation">[</span><span class="token string">'geometry'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> feature <span class="token keyword keyword-in">in</span> shp<span class="token punctuation">]</span>
        vietnam_shape <span class="token operator">=</span> geometries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># Vietnam shape is the first feature in the shapefile</span>

    <span class="token comment"># Filter out coordinates within Vietnam's territory</span>
    coordinates_in_vietnam <span class="token operator">=</span> <span class="token punctuation">[</span>
        coordinate
        <span class="token keyword keyword-for">for</span> coordinate <span class="token keyword keyword-in">in</span> coordinates_list
        <span class="token keyword keyword-if">if</span> Point<span class="token punctuation">(</span>coordinate<span class="token punctuation">)</span><span class="token punctuation">.</span>within<span class="token punctuation">(</span>vietnam_shape<span class="token punctuation">)</span>
    <span class="token punctuation">]</span>

    <span class="token comment"># Indices of coordinates within Vietnam's territory</span>
    indices_in_vietnam <span class="token operator">=</span> housing_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'longitude'</span><span class="token punctuation">,</span> <span class="token string">'latitude'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token builtin">tuple</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span>coordinates_in_vietnam<span class="token punctuation">)</span>

    <span class="token comment"># Return the housing data with coordinates within Vietnam's territory</span>
    <span class="token keyword keyword-return">return</span> housing_df<span class="token punctuation">[</span>indices_in_vietnam<span class="token punctuation">]</span>
</code></pre><h3 id="43-tạo-bản-đồ-phân-phối-giá-bất-động-sản-với-hàm-visualize_real_estate_price">4.3. Tạo bản đồ phân phối giá bất động sản với hàm <code>visualize_real_estate_price</code> </h3>
<h4 id="431-realestatevisualizerprice-class">4.3.1. <code>RealEstateVisualizerPrice</code> class </h4>
<p>Mục đích chính của class này là tạo ra một bản đồ tương tác thể hiện dữ liệu bất động sản, trong đó mỗi marker đại diện cho một bất động sản, màu sắc của dấu sẽ thể hiện mức giá.</p>
<ol>
<li><strong>Thuộc tính class và khởi tạo <code>__init__</code>:</strong></li>
</ol>
<ul>
<li>
<p><code>housing (pd.DataFrame)</code>: DataFrame chứa dữ liệu bất động sản. DataFrame này phải bao gồm ít nhất các cột:</p>
<ul>
<li><code>latitude</code> (vĩ độ);</li>
<li><code>longitude</code> (kinh độ);</li>
<li><code>price</code> (giá bất động sản).</li>
</ul>
</li>
<li>
<p><code>colormap (LinearColormap)</code>: Dùng để ánh xạ các giá trị <code>price</code> sang màu sắc. Ở đây, LinearColormap sẽ tạo dải màu liên tục giữa <code>vmin</code> (giá trị nhỏ nhất của price) và <code>vmax</code> (giá trị lớn nhất của price). Danh sách màu có thể tuỳ biến, ở đây dùng: <code>['green', 'blue', 'orange', 'red', 'purple', 'brown', 'black']</code>.</p>
</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> housing_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>housing <span class="token operator">=</span> housing_df
    self<span class="token punctuation">.</span>colormap <span class="token operator">=</span> LinearColormap<span class="token punctuation">(</span>
        <span class="token punctuation">[</span><span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> <span class="token string">'orange'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'purple'</span><span class="token punctuation">,</span> <span class="token string">'brown'</span><span class="token punctuation">,</span> <span class="token string">'black'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        vmin<span class="token operator">=</span>self<span class="token punctuation">.</span>housing<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        vmax<span class="token operator">=</span>self<span class="token punctuation">.</span>housing<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
</code></pre><ol start="2">
<li><strong>Phương thức <code>add_markers</code>:</strong></li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">add_markers</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> gmap<span class="token punctuation">:</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-for">for</span> _<span class="token punctuation">,</span> row <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>housing<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        marker_color <span class="token operator">=</span> self<span class="token punctuation">.</span>colormap<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        popup_content <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Giá: </span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        folium<span class="token punctuation">.</span>CircleMarker<span class="token punctuation">(</span>
            location<span class="token operator">=</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">'latitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token string">'longitude'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            radius<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
            color<span class="token operator">=</span>marker_color<span class="token punctuation">,</span>
            fill<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            fill_color<span class="token operator">=</span>marker_color<span class="token punctuation">,</span>
            popup<span class="token operator">=</span>popup_content 
        <span class="token punctuation">)</span><span class="token punctuation">.</span>add_to<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>
</code></pre><ul>
<li>Duyệt qua từng dòng của DataFrame:
<ul>
<li>Lấy giá trị <code>price</code> và ánh xạ nó qua <code>colormap</code> để lấy ra <code>marker_color</code>.</li>
<li>Tạo một <code>CircleMarker</code> trên bản đồ folium:
<ul>
<li><code>location</code>: toạ độ <code>(latitude, longitude)</code> của bất động sản.</li>
<li><code>radius</code>: kích thước vòng tròn đánh dấu, ở đây là 5.</li>
<li><code>color</code> và <code>fill_color</code>: chính là <code>marker_color</code> vừa xác định dựa trên giá.</li>
<li><code>popup</code>: nội dung hiển thị khi click vào marker, ở đây là “Giá: {price}”.</li>
</ul>
</li>
<li>Thêm marker vào bản đồ.</li>
</ul>
</li>
</ul>
<p>Kết quả: Mỗi bất động sản sẽ được biểu diễn bằng một vòng tròn màu tương ứng với giá trị của nó. Giá cao hơn có thể được tô màu sẫm hơn hoặc khác biệt (tuỳ theo dải màu).</p>
<ol start="3">
<li><strong>Phương thức <code>create_map</code>:</strong></li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">create_map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">:</span>
    gmap <span class="token operator">=</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">21.028511</span><span class="token punctuation">,</span> <span class="token number">105.804817</span><span class="token punctuation">]</span><span class="token punctuation">,</span> zoom_start<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>colormap<span class="token punctuation">.</span>add_to<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>add_markers<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> gmap
</code></pre><ul>
<li>Khởi tạo một bản đồ <code>folium.Map</code> với tâm là <code>[21.028511, 105.804817]</code> (gần Hà Nội) và mức zoom ban đầu là 6 (toàn cảnh Việt Nam).</li>
<li>Thêm <code>colormap</code> vào bản đồ để tạo chú giải màu.</li>
<li>Gọi <code>add_markers(gmap)</code> để vẽ marker tương ứng với từng bất động sản.</li>
<li>Trả về đối tượng bản đồ.</li>
</ul>
<p><strong>Ý nghĩa thực tiễn:</strong></p>
<p>Lớp <code>RealEstateVisualizerPrice</code> cho phép chúng ta nhanh chóng tạo một bản đồ tương tác, thể hiện giá bất động sản trên toàn lãnh thổ (hoặc một khu vực cụ thể). Việc này rất hữu ích cho phân tích không gian, giúp người dùng trực quan xem phân bố giá và so sánh các khu vực, phục vụ cho việc định giá, phân tích đầu tư, hay hỗ trợ các nhà hoạch định chính sách.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">RealEstateVisualizerPrice</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    A class to visualize real estate data on a map based on price.
    
    Attributes:
        housing (pd.DataFrame): The DataFrame containing the real estate data.
        colormap (LinearColormap): The color map for the real estate prices.

    Methods:
        add_markers: Add markers for each real estate with color based on price.
        create_map: Create a folium map with real estate data.
    """</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> housing_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Initialize the RealEstateVisualizer object.

        Parameters:
            housing_df (pd.DataFrame): The DataFrame containing the real estate data.
        """</span>
        self<span class="token punctuation">.</span>housing <span class="token operator">=</span> housing_df
        self<span class="token punctuation">.</span>colormap <span class="token operator">=</span> LinearColormap<span class="token punctuation">(</span>
            <span class="token punctuation">[</span><span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> <span class="token string">'orange'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'purple'</span><span class="token punctuation">,</span> <span class="token string">'brown'</span><span class="token punctuation">,</span> <span class="token string">'black'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            vmin<span class="token operator">=</span>self<span class="token punctuation">.</span>housing<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            vmax<span class="token operator">=</span>self<span class="token punctuation">.</span>housing<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">add_markers</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> gmap<span class="token punctuation">:</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Add markers for each real estate with color based on price.

        Parameters:
            gmap (folium.Map): The folium map object.
        """</span>
        <span class="token keyword keyword-for">for</span> _<span class="token punctuation">,</span> row <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>housing<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            marker_color <span class="token operator">=</span> self<span class="token punctuation">.</span>colormap<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            popup_content <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Giá: </span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
            folium<span class="token punctuation">.</span>CircleMarker<span class="token punctuation">(</span>
                location<span class="token operator">=</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">'latitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token string">'longitude'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                radius<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
                color<span class="token operator">=</span>marker_color<span class="token punctuation">,</span>
                fill<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                fill_color<span class="token operator">=</span>marker_color<span class="token punctuation">,</span>
                popup<span class="token operator">=</span>popup_content 
            <span class="token punctuation">)</span><span class="token punctuation">.</span>add_to<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">create_map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Create a folium map with real estate data.

        Returns:
            folium.Map: The generated folium map.
        """</span>
        gmap <span class="token operator">=</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">21.028511</span><span class="token punctuation">,</span> <span class="token number">105.804817</span><span class="token punctuation">]</span><span class="token punctuation">,</span> zoom_start<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>colormap<span class="token punctuation">.</span>add_to<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>add_markers<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> gmap
</code></pre><h4 id="432-hàm-visualize_real_estate_price">4.3.2. Hàm <code>visualize_real_estate_price</code> </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">visualize_real_estate_price</span><span class="token punctuation">(</span>housing_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Visualize real estate data on a map based on price.

    Parameters:
        housing_df (pd.DataFrame): The DataFrame containing the real estate data.

    Returns:
        folium.Map: The generated folium map.
    """</span>
    visualizer <span class="token operator">=</span> RealEstateVisualizerPrice<span class="token punctuation">(</span>housing_df<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> visualizer<span class="token punctuation">.</span>create_map<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Create a folium map</span>
</code></pre><p>Hàm <code>visualize_real_estate_price</code> đóng gói quy trình tạo bản đồ phân phối giá bất động sản vào một hàm duy nhất. Người dùng chỉ cần truyền vào DataFrame chứa dữ liệu bất động sản, hàm sẽ trả về một bản đồ tương tác thể hiện phân phối giá trên lãnh thổ Việt Nam.</p>
<h3 id="44-tạo-bản-đồ-phân-cụm-và-feature-engineering-với-hàm-visualize_real_estate_clusters">4.4. Tạo bản đồ phân cụm và Feature Engineering với hàm <code>visualize_real_estate_clusters</code> </h3>
<h4 id="441-realestatevisualizerclusters-class">4.4.1. <code>RealEstateVisualizerClusters</code> class </h4>
<p>Class này phục vụ mục đích trực quan hóa dữ liệu bất động them cụm dựa trên vị trí địa lý của các bất động sản. Quá trình này giúp ta hiểu rõ hơn về sự phân bố không gian của dữ liệu, tìm ra các "cụm" (cluster) những bất động sản gần nhau về mặt địa lý.</p>
<ol>
<li><strong>Thuộc tính của class và khởi tạo <code>__init__</code>:</strong></li>
</ol>
<ul>
<li>
<p><code>housing (pd.DataFrame)</code>: DataFrame chứa dữ liệu bất động sản, ít nhất gồm các cột:</p>
<ul>
<li><code>latitude</code>, <code>longitude</code>: toạ độ địa lý.</li>
<li><code>price</code>: giá bất động sản.</li>
</ul>
</li>
<li>
<p><code>num_clusters (int)</code>: Số lượng cụm dùng cho mô hình K-Means.</p>
</li>
<li>
<p><code>cluster_colormap (LinearColormap)</code>:  Dải màu biểu diễn các cụm. Ở đây: <code>['green', 'blue', 'orange', 'red', 'purple', 'brown', 'black']</code> tương ứng với các cụm từ 0 đến <code>num_clusters - 1</code>.</p>
</li>
<li>
<p><code>cluster_centers (np.ndarray)</code>: Tọa độ trung tâm các cụm (sau khi mô hình K-Means được fit).</p>
</li>
<li>
<p><code>cluster_radius (List[float])</code>: Bán kính cụm, được tính là khoảng cách xa nhất từ tâm cụm đến một điểm trong cụm đó.</p>
</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> housing_df<span class="token punctuation">:</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> num_clusters<span class="token punctuation">:</span><span class="token builtin">int</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>housing <span class="token operator">=</span> housing_df
    self<span class="token punctuation">.</span>num_clusters <span class="token operator">=</span> num_clusters
    self<span class="token punctuation">.</span>cluster_colormap <span class="token operator">=</span> LinearColormap<span class="token punctuation">(</span>
        <span class="token punctuation">[</span><span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> <span class="token string">'orange'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'purple'</span><span class="token punctuation">,</span> <span class="token string">'brown'</span><span class="token punctuation">,</span> <span class="token string">'black'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        vmax<span class="token operator">=</span>num_clusters <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>cluster_centers <span class="token operator">=</span> <span class="token boolean">None</span>
    self<span class="token punctuation">.</span>cluster_radius <span class="token operator">=</span> <span class="token boolean">None</span>
</code></pre><ol start="2">
<li><strong>Phương thức <code>elbow_method</code>:</strong></li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">elbow_method</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> clustering_features<span class="token punctuation">:</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">:</span>
    distortions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    K <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> k <span class="token keyword keyword-in">in</span> K<span class="token punctuation">:</span>
        kmeans <span class="token operator">=</span> KMeans<span class="token punctuation">(</span>n_clusters<span class="token operator">=</span>k<span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>clustering_features<span class="token punctuation">)</span>
        distortions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>kmeans<span class="token punctuation">.</span>inertia_<span class="token punctuation">)</span>
    
    <span class="token comment"># Vẽ biểu đồ elbow</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>K<span class="token punctuation">,</span> distortions<span class="token punctuation">,</span> <span class="token string">'bx-'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'k'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Distortion'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'The Elbow Method showing the optimal k'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

    diff <span class="token operator">=</span> np<span class="token punctuation">.</span>diff<span class="token punctuation">(</span>distortions<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>diff<span class="token punctuation">)</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span>
</code></pre><ul>
<li>Chạy K-Means cho k từ 1 đến 10, tính toán <code>inertia_</code> (độ méo - distortion).</li>
<li>Hiển thị biểu đồ elbow để tìm <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> tối ưu.</li>
<li>Sử dụng điểm "gãy" (argmax của độ giảm) để chọn k. Cách làm đơn giản: <code>abs(diff).argmax() + 2</code>.</li>
<li>Trả về k tối ưu.</li>
</ul>
<ol start="3">
<li><strong>Phương thức <code>distance_to_center</code>:</strong></li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">distance_to_center</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> housing<span class="token punctuation">:</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-for">for</span> idx<span class="token punctuation">,</span> center <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cluster_centers<span class="token punctuation">)</span><span class="token punctuation">:</span>
        housing<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'Distance to center </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> housing<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>
            <span class="token keyword keyword-lambda">lambda</span> row<span class="token punctuation">:</span> haversine<span class="token punctuation">(</span>center<span class="token punctuation">,</span> <span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">'latitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token string">'longitude'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            axis<span class="token operator">=</span><span class="token number">1</span>
        <span class="token punctuation">)</span>
</code></pre><ul>
<li>Với mỗi cụm, tính khoảng cách từ mỗi bất động sản đến tâm cụm.</li>
<li><code>haversine</code> tính khoảng cách trên bề mặt trái đất giữa hai điểm (latitude, longitude) bằng đường chim bay.</li>
<li>Thêm cột <code>Distance to center {idx}</code> vào DataFrame.</li>
</ul>
<ol start="4">
<li><strong>Phương thức <code>calculate_cluster_radius</code>:</strong></li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">calculate_cluster_radius</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>cluster_radius <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token builtin">max</span><span class="token punctuation">(</span>
            haversine<span class="token punctuation">(</span>center<span class="token punctuation">,</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span>latitude<span class="token punctuation">,</span> point<span class="token punctuation">.</span>longitude<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-for">for</span> point <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>housing<span class="token punctuation">[</span>self<span class="token punctuation">.</span>housing<span class="token punctuation">[</span><span class="token string">'Cluster'</span><span class="token punctuation">]</span> <span class="token operator">==</span> idx<span class="token punctuation">]</span><span class="token punctuation">.</span>itertuples<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> idx<span class="token punctuation">,</span> center <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cluster_centers<span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
</code></pre><ul>
<li>Tính bán kính mỗi cụm bằng khoảng cách lớn nhất từ tâm cụm đến một điểm trong cụm.</li>
<li><code>itertuples()</code> lặp qua DataFrame theo dạng tuple, truy cập <code>point.latitude</code>, <code>point.longitude</code>.</li>
</ul>
<ol start="5">
<li><strong>Phương thức <code>fit_kmeans</code>:</strong></li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">fit_kmeans</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    clustering_features <span class="token operator">=</span> self<span class="token punctuation">.</span>housing<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'latitude'</span><span class="token punctuation">,</span> <span class="token string">'longitude'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    self<span class="token punctuation">.</span>num_clusters <span class="token operator">=</span> self<span class="token punctuation">.</span>elbow_method<span class="token punctuation">(</span>clustering_features<span class="token punctuation">)</span>  <span class="token comment"># Find the optimal number of clusters</span>
    
    kmeans <span class="token operator">=</span> KMeans<span class="token punctuation">(</span>n_clusters<span class="token operator">=</span>self<span class="token punctuation">.</span>num_clusters<span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>clustering_features<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>cluster_centers <span class="token operator">=</span> kmeans<span class="token punctuation">.</span>cluster_centers_
    self<span class="token punctuation">.</span>housing<span class="token punctuation">[</span><span class="token string">'Cluster'</span><span class="token punctuation">]</span> <span class="token operator">=</span> kmeans<span class="token punctuation">.</span>labels_
    
    self<span class="token punctuation">.</span>distance_to_center<span class="token punctuation">(</span>self<span class="token punctuation">.</span>housing<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>calculate_cluster_radius<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><ul>
<li>Lấy <code>latitude</code> và <code>longitude</code> làm đặc trưng phân cụm.</li>
<li>Gọi <code>elbow_method</code> để tìm số cụm tốt nhất (tự động điều chỉnh <code>self.num_clusters</code>).</li>
<li>Chạy K-Means với số cụm đã xác định, thu được:
<ul>
<li><code>self.cluster_centers</code>: tâm cụm.</li>
<li><code>self.housing['Cluster']</code>: mỗi bất động sản được gán vào một cụm.</li>
</ul>
</li>
<li>Tính khoảng cách từ mỗi điểm đến tâm cụm (<code>distance_to_center</code>) và bán kính cụm (<code>calculate_cluster_radius</code>).</li>
</ul>
<ol start="6">
<li><strong>Phương thức <code>add_markers</code>:</strong></li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">add_markers</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> gmap<span class="token punctuation">:</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-for">for</span> _<span class="token punctuation">,</span> row <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>housing<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        cluster_label <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token string">'Cluster'</span><span class="token punctuation">]</span>
        marker_color <span class="token operator">=</span> self<span class="token punctuation">.</span>cluster_colormap<span class="token punctuation">(</span>cluster_label<span class="token punctuation">)</span>
        popup_content <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Giá: </span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">, Cụm: </span><span class="token interpolation"><span class="token punctuation">{</span>cluster_label<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        folium<span class="token punctuation">.</span>CircleMarker<span class="token punctuation">(</span>
            location<span class="token operator">=</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">'latitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token string">'longitude'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            radius<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
            color<span class="token operator">=</span>marker_color<span class="token punctuation">,</span>
            fill<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            fill_color<span class="token operator">=</span>marker_color<span class="token punctuation">,</span>
            popup<span class="token operator">=</span>popup_content 
        <span class="token punctuation">)</span><span class="token punctuation">.</span>add_to<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>
</code></pre><ul>
<li>Vẽ các điểm bất động sản lên bản đồ, màu sắc theo cụm.</li>
<li>Popup hiển thị giá và cụm của bất động sản.</li>
</ul>
<ol start="7">
<li><strong>Phương thức <code>create_map</code>:</strong></li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">create_map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">:</span>
    gmap <span class="token operator">=</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">21.028511</span><span class="token punctuation">,</span> <span class="token number">105.804817</span><span class="token punctuation">]</span><span class="token punctuation">,</span> zoom_start<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>cluster_colormap<span class="token punctuation">.</span>add_to<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>add_markers<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> gmap
</code></pre><ul>
<li>Tạo bản đồ folium, thêm bảng màu cụm, thêm marker từng bất động sản.</li>
<li>Trả về bản đồ.</li>
</ul>
<p><strong>Ý nghĩa thực tiễn:</strong></p>
<p>Lớp <code>RealEstateVisualizerCluster</code> giúp phân tích không gian dữ liệu bất động sản, tìm ra các cụm bất động sản gần nhau về mặt địa lý. Việc này giúp người dùng hiểu rõ hơn về phân bố không gian của dữ liệu, tìm ra các khu vực có giá trị đặc biệt, hay phát hiện ra các cụm bất động sản có giá trị cao hoặc thấp.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">RealEstateVisualizerCluster</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    A class to visualize real estate data on a map.

    Attributes:
        housing (pd.DataFrame): The DataFrame containing the real estate data.
        num_clusters (int): The number of clusters for KMeans clustering.
        colormap (LinearColormap): The color map for the real estate prices.
        cluster_centers (np.ndarray): The coordinates of the cluster centers.
        cluster_radius (List[float]): The radius of the clusters.

    Methods:
        fit_kmeans: Fit a KMeans model to the real estate data and add cluster labels to the DataFrame.
        calculate_cluster_radius: Calculate the radius of the clusters.
        add_cluster_visualization: Add cluster visualization to the map.
        add_markers: Add markers for each real estate with color based on price.
        create_map: Create a folium map with real estate data and cluster visualization.
    """</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> housing_df<span class="token punctuation">:</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> num_clusters<span class="token punctuation">:</span><span class="token builtin">int</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Initialize the RealEstateVisualizer object.

        Parameters:
            housing_df (pd.DataFrame): The DataFrame containing the real estate data.
            num_clusters (int): The number of clusters for KMeans clustering, default is 5.

        Returns:
            RealEstateVisualizer: The RealEstateVisualizer object.
        """</span>
        self<span class="token punctuation">.</span>housing <span class="token operator">=</span> housing_df
        self<span class="token punctuation">.</span>num_clusters <span class="token operator">=</span> num_clusters
        self<span class="token punctuation">.</span>cluster_colormap <span class="token operator">=</span> LinearColormap<span class="token punctuation">(</span>
            <span class="token punctuation">[</span><span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> <span class="token string">'orange'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'purple'</span><span class="token punctuation">,</span> <span class="token string">'brown'</span><span class="token punctuation">,</span> <span class="token string">'black'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
            vmax<span class="token operator">=</span>num_clusters <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cluster_centers <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>cluster_radius <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">fit_kmeans</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Fit a KMeans model to the real estate data and add cluster labels to the DataFrame.
        """</span>
        clustering_features <span class="token operator">=</span> self<span class="token punctuation">.</span>housing<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'latitude'</span><span class="token punctuation">,</span> <span class="token string">'longitude'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment"># Choose the clustering features</span>
        self<span class="token punctuation">.</span>num_clusters <span class="token operator">=</span> self<span class="token punctuation">.</span>elbow_method<span class="token punctuation">(</span>clustering_features<span class="token punctuation">)</span>
        kmeans <span class="token operator">=</span> KMeans<span class="token punctuation">(</span>n_clusters<span class="token operator">=</span>self<span class="token punctuation">.</span>num_clusters<span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>clustering_features<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cluster_centers <span class="token operator">=</span> kmeans<span class="token punctuation">.</span>cluster_centers_ <span class="token comment"># Get the cluster centers</span>
        self<span class="token punctuation">.</span>housing<span class="token punctuation">[</span><span class="token string">'Cluster'</span><span class="token punctuation">]</span> <span class="token operator">=</span> kmeans<span class="token punctuation">.</span>labels_ <span class="token comment"># Add the cluster labels to the housing DataFrame</span>
        self<span class="token punctuation">.</span>distance_to_center<span class="token punctuation">(</span>self<span class="token punctuation">.</span>housing<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>calculate_cluster_radius<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">elbow_method</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> clustering_features<span class="token punctuation">:</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Find the optimal number of clusters using the elbow method.

        Parameters:
            clustering_features (pd.DataFrame): The features used for clustering.

        Returns:
            np.ndarray: The coordinates of the cluster centers.
        """</span>
        distortions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        K <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> k <span class="token keyword keyword-in">in</span> K<span class="token punctuation">:</span>
            kmeans <span class="token operator">=</span> KMeans<span class="token punctuation">(</span>n_clusters<span class="token operator">=</span>k<span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>clustering_features<span class="token punctuation">)</span>
            distortions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>kmeans<span class="token punctuation">.</span>inertia_<span class="token punctuation">)</span>
            
        <span class="token comment"># plt.figure(figsize=(16,8))</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>K<span class="token punctuation">,</span> distortions<span class="token punctuation">,</span> <span class="token string">'bx-'</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'k'</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Distortion'</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'The Elbow Method showing the optimal $k$'</span></span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

        diff <span class="token operator">=</span> np<span class="token punctuation">.</span>diff<span class="token punctuation">(</span>distortions<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>diff<span class="token punctuation">)</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">distance_to_center</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> housing<span class="token punctuation">:</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Calculate the distance of each real estate to the cluster center.

        Parameters:
            housing (pd.DataFrame): The DataFrame containing the real estate data.
        """</span>
        <span class="token keyword keyword-for">for</span> idx<span class="token punctuation">,</span> center <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cluster_centers<span class="token punctuation">)</span><span class="token punctuation">:</span>
            housing<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'Distance to center </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> housing<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>
                <span class="token keyword keyword-lambda">lambda</span> row<span class="token punctuation">:</span> haversine<span class="token punctuation">(</span>center<span class="token punctuation">,</span> <span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">'latitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token string">'longitude'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                axis<span class="token operator">=</span><span class="token number">1</span>
            <span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">calculate_cluster_radius</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Calculate the radius of the clusters, which is the distance from the cluster center to the farthest point in the cluster.
        """</span>
        self<span class="token punctuation">.</span>cluster_radius <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token builtin">max</span><span class="token punctuation">(</span>
                haversine<span class="token punctuation">(</span>center<span class="token punctuation">,</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span>latitude<span class="token punctuation">,</span> point<span class="token punctuation">.</span>longitude<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-for">for</span> point <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>housing<span class="token punctuation">[</span>self<span class="token punctuation">.</span>housing<span class="token punctuation">[</span><span class="token string">'Cluster'</span><span class="token punctuation">]</span> <span class="token operator">==</span> idx<span class="token punctuation">]</span><span class="token punctuation">.</span>itertuples<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># itertuples is a function to iterate through the DataFrame as tuples</span>
            <span class="token punctuation">)</span>
            <span class="token keyword keyword-for">for</span> idx<span class="token punctuation">,</span> center <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cluster_centers<span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">add_markers</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> gmap<span class="token punctuation">:</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Add markers for each real estate with color based on price.

        Parameters:
            gmap (folium.Map): The folium map object.
        """</span>
        <span class="token keyword keyword-for">for</span> _<span class="token punctuation">,</span> row <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>housing<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            cluster_label <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token string">'Cluster'</span><span class="token punctuation">]</span>
            marker_color <span class="token operator">=</span> self<span class="token punctuation">.</span>cluster_colormap<span class="token punctuation">(</span>cluster_label<span class="token punctuation">)</span>
            popup_content <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Giá: </span><span class="token interpolation"><span class="token punctuation">{</span>row<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">, Cụm: </span><span class="token interpolation"><span class="token punctuation">{</span>cluster_label<span class="token punctuation">}</span></span><span class="token string">"</span></span>
            folium<span class="token punctuation">.</span>CircleMarker<span class="token punctuation">(</span>
                location<span class="token operator">=</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">'latitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token string">'longitude'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                radius<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
                color<span class="token operator">=</span>marker_color<span class="token punctuation">,</span>
                fill<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                fill_color<span class="token operator">=</span>marker_color<span class="token punctuation">,</span>
                <span class="token comment"># popup is the text that appears when you click on the marker</span>
                popup<span class="token operator">=</span>popup_content 
            <span class="token punctuation">)</span><span class="token punctuation">.</span>add_to<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">create_map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">:</span>
        gmap <span class="token operator">=</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">21.028511</span><span class="token punctuation">,</span> <span class="token number">105.804817</span><span class="token punctuation">]</span><span class="token punctuation">,</span> zoom_start<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cluster_colormap<span class="token punctuation">.</span>add_to<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>add_markers<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> gmap
</code></pre><h4 id="442-hàm-visualize_real_estate_clusters">4.4.2. Hàm <code>visualize_real_estate_clusters</code> </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">visualize_real_estate_clusters</span><span class="token punctuation">(</span>housing_df<span class="token punctuation">:</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> num_clusters<span class="token punctuation">:</span><span class="token builtin">int</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">:</span>
    visualizer <span class="token operator">=</span> RealEstateVisualizerCluster<span class="token punctuation">(</span>housing_df<span class="token punctuation">,</span> num_clusters<span class="token punctuation">)</span> 
    visualizer<span class="token punctuation">.</span>fit_kmeans<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># Fit KMeans model and add cluster labels to the dataframe</span>
    <span class="token keyword keyword-return">return</span> visualizer<span class="token punctuation">.</span>create_map<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># Create a folium map</span>
</code></pre><p>Hàm <code>visualize_real_estate_clusters</code> đóng gói quy trình tạo bản đồ phân cụm dữ liệu bất động sản vào một hàm duy nhất. Người dùng chỉ cần truyền vào DataFrame chứa dữ liệu bất động sản, hàm sẽ trả về một bản đồ tương tác thể hiện phân cụm dữ liệu.</p>
<h3 id="45-tạo-bản-đồ-heatmap-dựa-trên-giá-bất-động-sản-với-hàm-visualize_real_estate_price_heatmap">4.5. Tạo bản đồ Heatmap dựa trên giá bất động sản với hàm <code>visualize_real_estate_price_heatmap</code> </h3>
<h4 id="451-realestatevisualizerheatmap-class">4.5.1. <code>RealEstateVisualizerHeatmap</code> class </h4>
<p>Mục đích chính của class này là tạo một bản đồ nhiệt từ dữ liệu bất động sản, trong đó cường độ màu thể hiện mức giá bất động sản trong khu vực.</p>
<ol>
<li><strong>Thuộc tính của class và khởi tạo <code>__init__</code>:</strong></li>
</ol>
<ul>
<li><code>housing (pd.DataFrame)</code>: DataFrame chứa dữ liệu bất động sản. DataFrame này phải bao gồm ít nhất các cột:
<ul>
<li><code>latitude</code>: Vĩ độ.</li>
<li><code>longitude</code>: Kinh độ.</li>
<li><code>price</code>: Giá bất động sản.</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> housing_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>housing <span class="token operator">=</span> housing_df
</code></pre><ol start="2">
<li><strong>Phương thức <code>add_heatmap</code></strong></li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">add_heatmap</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> gmap<span class="token punctuation">:</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        heat_data <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token punctuation">[</span>row<span class="token punctuation">[</span><span class="token string">'latitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token string">'longitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> _<span class="token punctuation">,</span> row <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>housing<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
        HeatMap<span class="token punctuation">(</span>
            heat_data<span class="token punctuation">,</span> 
            min_opacity<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>  
            max_val<span class="token operator">=</span>self<span class="token punctuation">.</span>housing<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            radius<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>  
            blur<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span>add_to<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>
</code></pre><ul>
<li>Chuẩn bị danh sách <code>heat_data</code> gồm [<code>latitude</code>, <code>longitude</code>, <code>price</code>] cho từng dòng trong DataFrame.</li>
<li>Tạo một <code>Heatmap</code> trên bản đồ folium:
<ul>
<li><code>heat_data</code>: Danh sách gồm [<code>latitude</code>, <code>longitude</code>, <code>price</code>].</li>
<li><code>min_opacity</code>: Đặt độ mờ tối thiểu cho vùng nhiệt.</li>
<li><code>max_val</code>: Giá trị lớn nhất của <code>price</code>, được dùng để chuẩn hóa màu sắc theo giá.</li>
<li><code>radius</code>: Bán kính vùng nhiệt cho mỗi điểm dữ liệu.</li>
<li><code>blur</code>: Mức độ làm mờ của các điểm nhiệt.</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>Phương thức <code>create_map</code></strong></li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">create_map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">:</span>
        gmap <span class="token operator">=</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">21.028511</span><span class="token punctuation">,</span> <span class="token number">105.804817</span><span class="token punctuation">]</span><span class="token punctuation">,</span> zoom_start<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>add_heatmap<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> gmap
</code></pre><ul>
<li>Khởi tạo một bản đồ <code>folium.Map</code> với tâm là <code>[21.028511, 105.804817]</code> (gần Hà Nội) và mức zoom ban đầu là 6 (toàn cảnh Việt Nam).</li>
<li>Gọi <code>add_heatmap(gmap)</code> để thêm lớp nhiệt lên bản đồ.</li>
<li>Trả về đối tượng bản đồ.</li>
</ul>
<p><strong>Ý nghĩa thực tiễn:</strong></p>
<p>Lớp <code>RealEstateVisualizerHeatmap</code> hỗ trợ trực quan hóa dữ liệu bất động sản dưới dạng bản đồ nhiệt, giúp xác định khu vực có giá trị cao/thấp, hiểu rõ hơn sự phân bố giá theo khu vực và cung cấp thông tin hữu ích cho các nhà đầu tư, quy hoạch, và nhà phát triển dự án.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">RealEstateVisualizerHeatmap</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    A class to visualize real estate data on a heatmap based on price.
    
    Attributes:
        housing (pd.DataFrame): The DataFrame containing the real estate data.

    Methods:
        add_heatmap: Add heatmap for the real estate data.
        create_map: Create a folium map with real estate data.
    """</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> housing_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Initialize the RealEstateVisualizerHeatmap object.

        Parameters:
            housing_df (pd.DataFrame): The DataFrame containing the real estate data.
        """</span>
        self<span class="token punctuation">.</span>housing <span class="token operator">=</span> housing_df

    <span class="token keyword keyword-def">def</span> <span class="token function">add_heatmap</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> gmap<span class="token punctuation">:</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Add a heatmap layer for the real estate data.

        Parameters:
            gmap (folium.Map): The folium map object.
        """</span>
        <span class="token comment"># Prepare the data for the heatmap (latitude, longitude, price)</span>
        heat_data <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token punctuation">[</span>row<span class="token punctuation">[</span><span class="token string">'latitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token string">'longitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> _<span class="token punctuation">,</span> row <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>housing<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
        HeatMap<span class="token punctuation">(</span>
            heat_data<span class="token punctuation">,</span> 
            min_opacity<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>  
            max_val<span class="token operator">=</span>self<span class="token punctuation">.</span>housing<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            radius<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>  
            blur<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span>add_to<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">create_map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Create a folium map with real estate data.

        Returns:
            folium.Map: The generated folium map with heatmap.
        """</span>
        gmap <span class="token operator">=</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">21.028511</span><span class="token punctuation">,</span> <span class="token number">105.804817</span><span class="token punctuation">]</span><span class="token punctuation">,</span> zoom_start<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>add_heatmap<span class="token punctuation">(</span>gmap<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> gmap
</code></pre><h4 id="452-hàm-visualize_real_estate_price_heatmap">4.5.2. Hàm <code>visualize_real_estate_price_heatmap</code> </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">visualize_real_estate_price_heatmap</span><span class="token punctuation">(</span>housing_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> folium<span class="token punctuation">.</span>Map<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Visualize real estate data on a heatmap based on price.

    Parameters:
        housing_df (pd.DataFrame): The DataFrame containing the real estate data.

    Returns:
        folium.Map: The generated folium map with heatmap.
    """</span>
    visualizer <span class="token operator">=</span> RealEstateVisualizerHeatmap<span class="token punctuation">(</span>housing_df<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> visualizer<span class="token punctuation">.</span>create_map<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p>Hàm <code>visualize_real_estate_price_heatmap</code> đóng gói quy trình tạo bản đồ nhiệt thành một hàm duy nhất, dễ sử dụng, cho phép người dùng chỉ cần truyền vào DataFrame chứa dữ liệu bất động sản và nhận về một đối tượng bản đồ folium với Heatmap.</p>
<h3 id="46-chạy-chương-trình">4.6. Chạy chương trình </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-from">from</span> Visualize <span class="token keyword keyword-import">import</span> check_coordinates_in_vietnam<span class="token punctuation">,</span> 
                    visualize_real_estate_price<span class="token punctuation">,</span> 
                    visualize_real_estate_clusters<span class="token punctuation">,</span> 
                    visualize_real_estate_price_heatmap
</code></pre><ol>
<li>
<p>Đầu tiên, chúng ta cần lọc dữ liệu bất động sản theo lãnh thổ Việt Nam:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>housing_cleaned_coordinations <span class="token operator">=</span> check_coordinates_in_vietnam<span class="token punctuation">(</span>shapefile_path<span class="token operator">=</span><span class="token string">'./vietnam_Vietnam_Country_Boundary/extracted_files/vietnam_Vietnam_Country_Boundary.shp'</span><span class="token punctuation">,</span> housing_df<span class="token operator">=</span>data_cleaned<span class="token punctuation">)</span>
</code></pre><p>Trong đó, <code>shapefile_path</code> là đường dẫn đến file shapefile chứa thông tin lãnh thổ Việt Nam, <code>data_cleaned</code> là DataFrame chứa dữ liệu bất động sản.</p>
</li>
<li>
<p>Tiếp theo, chúng ta sẽ tạo bản đồ phân phối giá bất động sản:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>gmap_1 <span class="token operator">=</span> visualize_real_estate_price<span class="token punctuation">(</span>housing_cleaned_coordinations<span class="token punctuation">)</span>
gmap_1<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"foliumVisualizationPrice.html"</span><span class="token punctuation">)</span>
webbrowser<span class="token punctuation">.</span>open_new_tab<span class="token punctuation">(</span><span class="token string">'foliumVisualizationPrice.html'</span><span class="token punctuation">)</span>
</code></pre><p>Trong phần này, <code>gmap_1</code> là bản đồ phân phối giá bất động sản, được lưu vào file <code>foliumVisualizationPrice.html</code> và mở trên trình duyệt <code>webbrowser</code>.<br>
<br>
<img src="./images/price_viz.png" alt="Price Viz"></p>
<p><em>Hình 4: Bản đồ phân phối giá bất động sản trên lãnh thổ thành phố Hồ Chí Minh</em><br>
<br>
<strong>Nhận xét:</strong></p>
<ol>
<li>
<p><strong>Đặc trưng không gian của giá:</strong> Nhìn tổng quan, các màu sắc phân bố có vẻ khá đa dạng, không tập trung một màu duy nhất ở một khu vực. Điều này có thể hàm ý rằng giá bất động sản tại khu vực trung tâm TPHCM khá phân tán, không đồng đều.</p>
</li>
<li>
<p><strong>Mức độ tập trung:</strong> Có thể quan sát thấy số lượng bất động sản tập trung đông hơn ở các quận trung tâm, quanh sân bay hoặc các trục đường lớn. Đây là điều hợp lý vì các khu vực trung tâm thường có mật độ bất động sản cao. Vùng rìa, ngoại thành hoặc các khu vực ít phát triển hơn có ít điểm hơn.</p>
</li>
<li>
<p><strong>Ứng dụng trực quan:</strong> Việc biểu diễn dữ liệu bất động sản trên bản đồ giúp người xem nhanh chóng nhận ra phân bố và so sánh giá giữa các khu vực. Điều này hữu ích cho cả nhà phân tích thị trường, môi giới và người mua bán bất động sản trong việc đưa ra quyết định và đánh giá chung về thị trường.</p>
</li>
</ol>
</li>
<li>
<p>Tiếp theo, chúng ta sẽ tạo bản đồ phân cụm dữ liệu bất động sản:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>gmap_2 <span class="token operator">=</span> visualize_real_estate_clusters<span class="token punctuation">(</span>housing_cleaned_coordinations<span class="token punctuation">)</span>
gmap_2<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"foliumVisualizationCluster.html"</span><span class="token punctuation">)</span>
webbrowser<span class="token punctuation">.</span>open_new_tab<span class="token punctuation">(</span><span class="token string">'foliumVisualizationCluster.html'</span><span class="token punctuation">)</span>
</code></pre><p>Tương tự như cách làm ở <code>gmap_1</code>, nhưng ở đây chúng ta sẽ thu được thêm elbow plot để xác định số cụm tối ưu cũng như các đặc trưng khác được sinh ra từ việc phân cụm dữ liệu:</p>
<p><img src="./images/elbow.png" alt="Elbow Plot"></p>
<p><em>Hình 6: Biểu đồ Elbow để xác định số cụm tối ưu</em><br>
<br>
Trong trường hợp này, số cụm tối ưu được xác định là 2 và ta được bản đồ phân cụm như sau:</p>
<p><img src="./images/cluster_viz.png" alt="Cluster Viz"></p>
<p><em>Hình 5: Bản đồ phân cụm bất động sản trên lãnh thổ thành phố Hồ Chí Minh</em><br>
<br>
<strong>Nhận xét:</strong></p>
<ol>
<li>
<p><strong>Phân cụm không gian:</strong> Ta thấy rõ ràng có hai cụm chính được hình thành, thể hiện qua hai màu khác nhau (ví dụ: cụm màu xanh lá ở phía tây – trung tâm, và cụm màu xanh dương tập trung nhiều hơn ở phía đông nam).</p>
</li>
<li>
<p><strong>Khu vực và phân bố:</strong></p>
<ul>
<li>Cụm màu xanh lá: Tập trung rất dày ở khu vực nội thành hoặc các vùng giáp ranh trung tâm Thành phố Hồ Chí Minh. Sự tập trung này có thể phản ánh một thị trường bất động sản sôi động, nhiều lựa chọn hoặc giá trị tài sản tương đối đồng đều.</li>
<li>Cụm màu xanh dương: Phân bố về phía đông, có vẻ thưa hơn so với cụm xanh lá. Khu vực này có thể là quận 2, Quận 9, Thủ Đức (nay thuộc TP. Thủ Đức), hoặc các vùng lân cận. Việc tách biệt địa lý này có thể do rào cản tự nhiên (như sông Sài Gòn) hoặc do các đặc điểm thị trường, quy hoạch đô thị khác nhau.</li>
</ul>
</li>
<li>
<p><strong>Ý nghĩa phân tích:</strong></p>
<ul>
<li>Phân cụm giúp nhận diện ranh giới hoặc đặc trưng từng khu vực địa lý. Mỗi cụm có thể mang những đặc điểm chung về giá cả, loại hình bất động sản, mức độ phát triển hạ tầng, tiện ích, giao thông, v.v.</li>
<li>Việc có 2 cụm lớn, màu sắc khác biệt, gợi ý rằng thị trường bất động sản ở TPHCM có thể chia thành ít nhất hai khu vực khá khác biệt về vị trí và có lẽ cả về mức giá, mật độ và loại hình.</li>
</ul>
</li>
</ol>
<p>Ta cũng sẽ thu được DataFrame mới sau khi phân cụm với các features được thêm vào như: <code>Cluster</code>, <code>Distance to center 0</code>, <code>Distance to center 1</code>.</p>
<table>
<thead>
<tr>
<th>id</th>
<th>price</th>
<th>area</th>
<th>bedrooms</th>
<th>wc</th>
<th>n_floors</th>
<th>car_place</th>
<th>latitude</th>
<th>longitude</th>
<th>Cluster</th>
<th>Distance to center 0</th>
<th>Distance to center 1</th>
</tr>
</thead>
<tbody>
<tr>
<td>121356</td>
<td>0.79</td>
<td>57</td>
<td>2.000000</td>
<td>2.000000</td>
<td>1.0</td>
<td>0</td>
<td>10.713820</td>
<td>106.589326</td>
<td>1</td>
<td>19.349504</td>
<td>10.874742</td>
</tr>
<tr>
<td>115827</td>
<td>2.60</td>
<td>16</td>
<td>4.000000</td>
<td>3.000000</td>
<td>3.0</td>
<td>0</td>
<td>10.767127</td>
<td>106.659121</td>
<td>1</td>
<td>9.791375</td>
<td>3.401934</td>
</tr>
<tr>
<td>115833</td>
<td>3.00</td>
<td>32</td>
<td>4.000000</td>
<td>2.069591</td>
<td>5.0</td>
<td>1</td>
<td>10.745886</td>
<td>106.639292</td>
<td>1</td>
<td>12.831323</td>
<td>5.458846</td>
</tr>
<tr>
<td>115834</td>
<td>4.60</td>
<td>38</td>
<td>3.000000</td>
<td>4.000000</td>
<td>3.0</td>
<td>1</td>
<td>10.755020</td>
<td>106.637447</td>
<td>1</td>
<td>12.511259</td>
<td>4.487381</td>
</tr>
<tr>
<td>115837</td>
<td>3.45</td>
<td>76</td>
<td>4.000000</td>
<td>4.000000</td>
<td>4.0</td>
<td>1</td>
<td>10.867853</td>
<td>106.623154</td>
<td>1</td>
<td>14.447282</td>
<td>8.500217</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>88818</td>
<td>9.50</td>
<td>46</td>
<td>4.000000</td>
<td>4.000000</td>
<td>4.0</td>
<td>1</td>
<td>10.791831</td>
<td>106.671614</td>
<td>1</td>
<td>7.584297</td>
<td>2.876457</td>
</tr>
<tr>
<td>86770</td>
<td>1.95</td>
<td>48</td>
<td>2.000000</td>
<td>2.000000</td>
<td>1.0</td>
<td>0</td>
<td>10.710682</td>
<td>106.618825</td>
<td>1</td>
<td>16.921170</td>
<td>9.774195</td>
</tr>
<tr>
<td>86258</td>
<td>10.20</td>
<td>56</td>
<td>3.000000</td>
<td>4.000000</td>
<td>3.0</td>
<td>1</td>
<td>10.801764</td>
<td>106.711032</td>
<td>0</td>
<td>3.148295</td>
<td>7.209409</td>
</tr>
<tr>
<td>86002</td>
<td>6.20</td>
<td>47</td>
<td>4.000000</td>
<td>5.000000</td>
<td>5.0</td>
<td>1</td>
<td>10.819914</td>
<td>106.698770</td>
<td>0</td>
<td>4.710059</td>
<td>6.469803</td>
</tr>
<tr>
<td>108530</td>
<td>0.001</td>
<td>30</td>
<td>1.695659</td>
<td>1.264540</td>
<td>2.0</td>
<td>0</td>
<td>10.852466</td>
<td>106.660611</td>
<td>1</td>
<td>10.044947</td>
<td>6.643871</td>
</tr>
</tbody>
</table>
<p>[5833 rows × 12 columns]</p>
</li>
<li>
<p>Tiếp theo, chúng ta sẽ tạo bản đồ nhiệt bất động sản:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>gmap_3 <span class="token operator">=</span> visualize_real_estate_price_heatmap<span class="token punctuation">(</span>housing_cleaned_coordinations<span class="token punctuation">)</span>
gmap_3<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"foliumVisualizationHeatmap.html"</span><span class="token punctuation">)</span>
webbrowser<span class="token punctuation">.</span>open_new_tab<span class="token punctuation">(</span><span class="token string">'foliumVisualizationHeatmap.html'</span><span class="token punctuation">)</span>
</code></pre><p>Trong phần này, <code>gmap_3</code> là bản đồ phân phối giá bất động sản  dưới dạng <strong>Heatmap</strong>, được lưu vào file <code>foliumVisualizationHeatmap.html</code> và mở trên trình duyệt <code>webbrowser</code>.</p>
<p><img src="./images/heatmap_viz.png" alt="Heatmap Viz"></p>
<p><em>Hình 6: Bản đồ nhiệt bất động sản trên lãnh thổ thành phố Hồ Chí Minh</em><br>
<br>
<strong>Nhận xét:</strong></p>
<ol>
<li>
<p><strong>Đặc điểm không gian của giá trị:</strong></p>
<ul>
<li>Sự phân bố màu sắc trên bản đồ cho thấy sự khác biệt rõ rệt về mật độ hoặc giá trị giữa các khu vực. Những khu vực trung tâm với màu đỏ nổi bật biểu thị hoạt động sôi động hoặc giá trị cao (như giá bất động sản hoặc khối lượng giao dịch). Trong khi đó, các vùng ngoại ô có màu xanh dương thể hiện mật độ thấp hơn hoặc ít sôi động hơn.</li>
<li>Sự phân hóa này cho thấy tầm quan trọng của các khu vực trung tâm như một trung tâm kinh tế và hoạt động đô thị.</li>
</ul>
</li>
<li>
<p><strong>Quan sát về cụm và mật độ:</strong></p>
<ul>
<li><strong>Cụm trung tâm:</strong> Các vùng màu đỏ ở khu vực trung tâm Thành phố Hồ Chí Minh (như Quận 1, Quận 3 hoặc khu vực sân bay) đại diện cho các điểm nóng, nơi có mật độ kinh tế hoặc giao dịch bất động sản cao.</li>
<li><strong>Cụm ngoại vi:</strong> Các vùng màu xanh lá và xanh dương ở rìa bản đồ (ví dụ: Bình Chánh, Hóc Môn) cho thấy mật độ thấp hơn, có thể là các khu vực đang phát triển hoặc khu dân cư với giá trị thị trường thấp hơn.</li>
</ul>
</li>
<li>
<p><strong>Ý nghĩa thị trường:</strong></p>
<ul>
<li>Hình ảnh bản đồ nhiệt là công cụ hiệu quả để nhận diện các khu vực có giá trị cao và tìm cơ hội đầu tư hoặc phát triển. Đồng thời, nó cũng giúp xác định các vùng có tiềm năng phát triển trong tương lai, đặc biệt là dọc theo các dự án giao thông hoặc hạ tầng mới.</li>
<li>Các cụm trung tâm phản ánh những khu vực có sức hút đầu tư cao, trong khi những vùng ít mật độ hơn có thể phù hợp để phát triển thêm.</li>
</ul>
</li>
</ol>
</li>
</ol>
<h2 id="5-feature-selection-với-featureselectionpy">5. Feature Selection với <code>FeatureSelection.py</code> </h2>
<h3 id="51-khai-báo-thư-viện">5.1. Khai báo thư viện </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
<span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
<span class="token keyword keyword-from">from</span> collections <span class="token keyword keyword-import">import</span> Counter
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>feature_selection <span class="token keyword keyword-import">import</span> VarianceThreshold<span class="token punctuation">,</span> SelectKBest<span class="token punctuation">,</span> mutual_info_regression
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword keyword-import">import</span> RandomForestRegressor
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword keyword-import">import</span> LinearRegression
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>pipeline <span class="token keyword keyword-import">import</span> make_pipeline
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>feature_selection <span class="token keyword keyword-import">import</span> SelectFromModel
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword keyword-import">import</span> StandardScaler
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword keyword-import">import</span> GridSearchCV<span class="token punctuation">,</span> RandomizedSearchCV
<span class="token keyword keyword-from">from</span> typing <span class="token keyword keyword-import">import</span> List<span class="token punctuation">,</span> Set
</code></pre><p>Trong module này, chúng ta sẽ sử dụng các thư viện sau:</p>
<ul>
<li><code>Counter</code> để đếm số lần xuất hiện của các phần tử trong một list.</li>
<li><code>VarianceThreshold</code> để loại bỏ các đặc trưng có độ biến thiên thấp.</li>
<li><code>SelectKBest</code> để chọn ra <code>k</code> đặc trưng tốt nhất dựa trên một hàm score.</li>
<li><code>mutual_info_regression</code> để tính toán mutual information giữa các đặc trưng và biến mục tiêu.</li>
<li><code>RandomForestRegressor</code> và <code>LinearRegression</code> là hai mô hình hồi quy sẽ được sử dụng để chọn ra các đặc trưng quan trọng.</li>
<li><code>make_pipeline</code> để tạo một pipeline cho việc chọn lọc đặc trưng.</li>
<li><code>SelectFromModel</code> để chọn ra các đặc trưng quan trọng từ mô hình.</li>
<li><code>GridSearchCV</code> và <code>RandomizedSearchCV</code> để tìm ra siêu tham số tốt nhất cho mô hình.</li>
<li><code>List</code> và <code>Set</code> để định nghĩa kiểu dữ liệu cho các biến.</li>
</ul>
<h3 id="52-featureselector-class">5.2. <code>FeatureSelector</code> class </h3>
<ul>
<li>
<p>Lớp <code>FeatureSelector</code> được thiết kế để thực hiện quá trình <strong>chọn lọc đặc trưng</strong> (Feature Selection) một cách toàn diện và linh hoạt, dựa trên nhiều phương pháp khác nhau. Mục tiêu của lớp này là giảm số chiều của dữ liệu đầu vào, loại bỏ các đặc trưng không quan trọng hoặc gây nhiễu, từ đó cải thiện hiệu suất và độ chính xác của mô hình học máy. <code>FeatureSelector</code> bao gồm các phương pháp chọn lọc đặc trưng như sau:</p>
<ol>
<li>
<p><strong>Variance Threshold</strong> ứng với phương thức <a href="#53-ph%C6%B0%C6%A1ng-ph%C3%A1p-variance-threshold"><code>variance_threshold_selection</code></a>.</p>
</li>
<li>
<p><strong>SelectKBest</strong> ứng với phương thức <a href="#54-ph%C6%B0%C6%A1ng-ph%C3%A1p-select-k-best"><code>select_k_best</code></a>.</p>
</li>
<li>
<p><strong>Mutual Information</strong> ứng với phương thức <a href="#55-ph%C6%B0%C6%A1ng-ph%C3%A1p-mutual-information"><code>mutual_information_selection</code></a>.</p>
</li>
<li>
<p><strong>GridSearchCV</strong> ứng với phương thức <a href="#56-ph%C6%B0%C6%A1ng-ph%C3%A1p-gridsearchcv"><code>grid_search_feature_selection</code></a>.</p>
</li>
<li>
<p><strong>RandomizedSearchCV</strong> ứng với phương thức <a href="#57-ph%C6%B0%C6%A1ng-ph%C3%A1p-randomizedsearchcv"><code>randomized_search_feature_selection</code></a>.</p>
</li>
<li>
<p><strong>Phương thức <code>combine_selected_features</code>:</strong> Phương thức này sẽ kết hợp các đặc trưng được chọn từ các phương pháp khác nhau và chọn ra các đặc trưng xuất hiện trong ít nhất hai phương pháp.</p>
</li>
<li>
<p><strong>Phương thức <code>fit</code>:</strong> Phương thức <strong><code>fit</code></strong> là trung tâm của lớp <code>FeatureSelector</code>, chịu trách nhiệm thực hiện toàn bộ quy trình Feature Selection. Khi được gọi, nó lần lượt:</p>
<ol>
<li>
<p><strong>Chạy tất cả các phương pháp Feature Selection:</strong> Gọi từng phương pháp nêu trên để chọn ra các tập hợp đặc trưng riêng lẻ.</p>
</li>
<li>
<p><strong>Kết hợp kết quả:</strong> Sử dụng phương pháp <code>combine_selected_features</code> để hợp nhất các đặc trưng đã chọn từ các phương pháp khác nhau và chọn ra các đặc trưng xuất hiện trong ít nhất hai phương pháp.</p>
</li>
<li>
<p><strong>Trả về kết quả:</strong> Trả về danh sách các đặc trưng cuối cùng được chọn, đảm bảo đây là những đặc trưng quan trọng và có giá trị nhất cho mô hình.</p>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p>Khởi tạo <code>__init__</code> của lớp <code>FeatureSelector</code> như sau:</p>
<ul>
<li><code>X</code> và <code>y</code> là feature matrix và target variable.</li>
<li><code>variance_threshold</code>, <code>k_best</code>, <code>top_k_f_mi</code> là các siêu tham số cho các phương pháp chọn lọc đặc trưng.</li>
<li><code>features_selected</code> là danh sách chứa các tập hợp đặc trưng đã chọn từ các phương pháp.</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">FeatureSelector</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> y<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">,</span> variance_threshold<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">,</span> k_best<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> top_k_mi<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Initialize the feature selector with the dataset and feature selection parameters.
        
        :param X: The feature matrix (pd.DataFrame).
        :param y: The target variable (pd.Series).
        :param variance_threshold: Threshold for VarianceThreshold method to remove low variance features.
        :param k_best: Number of top features to select using SelectKBest (based on Mutual Information).
        :param top_k_mi: Number of top features to select based on Mutual Information.
        """</span>
        self<span class="token punctuation">.</span>X <span class="token operator">=</span> X
        self<span class="token punctuation">.</span>y <span class="token operator">=</span> y
        self<span class="token punctuation">.</span>variance_threshold <span class="token operator">=</span> variance_threshold
        self<span class="token punctuation">.</span>k_best <span class="token operator">=</span> k_best
        self<span class="token punctuation">.</span>top_k_mi <span class="token operator">=</span> top_k_mi
        self<span class="token punctuation">.</span>features_selected<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Set<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">variance_threshold_selection</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Set<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Apply VarianceThreshold to remove features with low variance.
        
        :return: A set of selected feature names.
        """</span>

        <span class="token comment"># ... (code here) ...</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">select_k_best</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Set<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Apply SelectKBest with Mutual Information to select the top k features.
        
        :return: A set of selected feature names.
        """</span>
        
        <span class="token comment"># ... (code here) ...</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">mutual_information_selection</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Set<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Compute Mutual Information scores and select the top features based on the scores.
        
        :return: A set of selected feature names.
        """</span>
        
        <span class="token comment"># ... (code here) ...</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">grid_search_feature_selection</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Set<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Use GridSearchCV to optimize hyperparameters of a RandomForestRegressor, and select features based on feature importance.
        
        :return: A set of selected feature names.
        """</span>
        
        <span class="token comment"># ... (code here) ...</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">randomized_search_feature_selection</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Set<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Use RandomizedSearchCV to optimize hyperparameters of a RandomForestRegressor, and select features based on feature importance.
        
        :return: A set of selected feature names.
        """</span>
        
        <span class="token comment"># ... (code here) ...</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">combine_selected_features</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Combine selected features from all methods and count the frequency of occurrence.
        
        :return: A list of final selected features that appeared in two or more methods.
        """</span>
        feature_counter <span class="token operator">=</span> Counter<span class="token punctuation">(</span><span class="token punctuation">[</span>feature <span class="token keyword keyword-for">for</span> feature_set <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>features_selected <span class="token keyword keyword-for">for</span> feature <span class="token keyword keyword-in">in</span> feature_set<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># Get the features that appeared the most across methods</span>
        final_selected_features <span class="token operator">=</span> <span class="token punctuation">[</span>feature <span class="token keyword keyword-for">for</span> feature<span class="token punctuation">,</span> count <span class="token keyword keyword-in">in</span> feature_counter<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> count <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># Appears in 2 or more methods</span>
        <span class="token keyword keyword-return">return</span> final_selected_features

    <span class="token keyword keyword-def">def</span> <span class="token function">fit</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Run the entire feature selection process and return the final selected features.
        
        :return: A list of final selected feature names.
        """</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Running VarianceThreshold..."</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>variance_threshold_selection<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Running SelectKBest..."</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>select_k_best<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Running Mutual Information..."</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>mutual_information_selection<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Running GridSearchCV..."</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>grid_search_feature_selection<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Running RandomizedSearchCV..."</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>randomized_search_feature_selection<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Combining selected features..."</span><span class="token punctuation">)</span>
        final_features <span class="token operator">=</span> self<span class="token punctuation">.</span>combine_selected_features<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> final_features
</code></pre><h3 id="53-phương-pháp-variance-threshold">5.3. Phương pháp Variance Threshold </h3>
<p><strong>Variance Threshold</strong> là một phương pháp đơn giản nhưng hiệu quả trong việc chọn lọc đặc trưng (<strong>Feature Selection</strong>) dựa trên độ biến thiên (<strong>variance</strong>) của từng đặc trưng trong tập dữ liệu. Ý tưởng chính của phương pháp này là loại bỏ các đặc trưng có độ biến thiên thấp vì chúng thường không mang lại nhiều thông tin hữu ích cho mô hình Machine Learning.</p>
<p>Phương pháp này hoạt động theo quy trình sau:</p>
<ol>
<li>
<p><strong>Tính toán phương sai (Variance):</strong> Đối với một tập dữ liệu <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> với <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> mẫu và <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> đặc trưng, phương sai của một đặc trưng <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">x_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> được tính bằng công thức:<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Var</mtext><mo stretchy="false">(</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msup><mrow><mo fence="true">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>−</mo><msub><mi>μ</mi><mi>j</mi></msub><mo fence="true">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\text{Var}(x_j) = \frac{1}{n} \sum_{i=1}^{n} \left( x_{ij} - \mu_j \right)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">Var</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.954em;"><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><br>
trong đó:</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">x_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> là giá trị của đặc trưng <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> ở mẫu <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>,</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>j</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mu_j = \frac{1}{n} \sum_{i=1}^{n} x_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> là giá trị trung bình của đặc trưng <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">x_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>.</li>
</ul>
<p>Phương sai đo lường mức độ phân tán của các giá trị trong một đặc trưng. Nếu phương sai gần bằng 0, các giá trị của đặc trưng đó gần như không thay đổi.</p>
</li>
<li>
<p><strong>Lựa chọn ngưỡng (Threshold):</strong> Chúng ta có thể đặt một ngưỡng <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> (thường mặc định là <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">t = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>). Phương pháp sẽ giữ lại các đặc trưng <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">x_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> thỏa mãn:<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Var</mtext><mo stretchy="false">(</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mo>&gt;</mo><mi>t</mi></mrow><annotation encoding="application/x-tex">\text{Var}(x_j) &gt; t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">Var</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span></span></p>
<p>Sau khi tính toán, những đặc trưng có độ biến thiên nhỏ hơn hoặc bằng ngưỡng <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> được coi là không hữu ích và sẽ bị loại khỏi tập dữ liệu.</p>
</li>
</ol>
<p>Cài đặt chương trình:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>    <span class="token keyword keyword-def">def</span> <span class="token function">variance_threshold_selection</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Set<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Apply VarianceThreshold to remove features with low variance.
        
        :return: A set of selected feature names.
        """</span>
        selector <span class="token operator">=</span> VarianceThreshold<span class="token punctuation">(</span>threshold<span class="token operator">=</span>self<span class="token punctuation">.</span>variance_threshold<span class="token punctuation">)</span>
        selector<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>self<span class="token punctuation">.</span>X<span class="token punctuation">)</span>
        selected_features <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>X<span class="token punctuation">.</span>columns<span class="token punctuation">[</span>selector<span class="token punctuation">.</span>get_support<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>features_selected<span class="token punctuation">.</span>append<span class="token punctuation">(</span>selected_features<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> selected_features
</code></pre><h3 id="54-phương-pháp-select-k-best">5.4. Phương pháp Select K Best </h3>
<p><strong>Select K Best</strong> là một kỹ thuật lựa chọn đặc trưng (feature selection) phổ biến trong học máy, giúp chọn ra các đặc trưng quan trọng nhất trong tập dữ liệu dựa trên một hàm thống kê hoặc tiêu chí nhất định. Cách tiếp cận này giúp cải thiện hiệu suất của mô hình, giảm độ phức tạp và ngăn chặn overfitting.</p>
<p>Cách hoạt động:</p>
<ol>
<li>
<p><strong>Chọn tiêu chí đánh giá</strong>: <strong>Select K Best</strong> sử dụng một hàm đánh giá thống kê để tính điểm cho từng đặc trưng so với nhãn mục tiêu. Bài toán này đang dùng hàm:</p>
<ul>
<li><code>mutual_info_regression</code>:  <strong>Mutual Information (MI)</strong> là một phương pháp đo lường mức độ phụ thuộc giữa hai biến ngẫu nhiên. Trong Feature Selection, Mutual Information được sử dụng để đánh giá mức độ tương quan giữa một đặc trưng và biến mục tiêu. Phương pháp này không chỉ phát hiện mối quan hệ tuyến tính mà còn đo lường các mối quan hệ phi tuyến phức tạp.<br>
Ngoài ra, MI là một thước đo trong lý thuyết thông tin, cho biết lượng thông tin mà một đặc trưng <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">X_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> chia sẻ với biến mục tiêu <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>.</li>
</ul>
<ol>
<li>
<p>Với một đặc trưng <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">X_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> và biến mục tiêu <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>, MI được tính:<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>M</mi><mi>I</mi><mo stretchy="false">(</mo><msub><mi>X</mi><mi>j</mi></msub><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mo>∬</mo><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>log</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>p</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></mrow></mfrac><mo fence="true">)</mo></mrow><mi>d</mi><mi>x</mi><mtext> </mtext><mi>d</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">MI(X_j, y) = \iint p(x, y) \cdot \log \left( \frac{p(x, y)}{p(x) \cdot p(y)} \right) dx \, dy</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.222em;vertical-align:-0.862em;"></span><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.001em;">∬</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span><br>
Trong đó:</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(x, y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span>: Phân phối xác suất chung của <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">X_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> và <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>.</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span>: Phân phối xác suất biên của <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">X_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span>: Phân phối xác suất biên của <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>.</li>
</ul>
</li>
<li>
<p>Ý nghĩa:</p>
<ul>
<li>Nếu <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">X_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> và <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> độc lập, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>p</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(x, y) = p(x) \cdot p(y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span>, do đó <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>I</mi><mo stretchy="false">(</mo><msub><mi>X</mi><mi>j</mi></msub><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">MI(X_j, y) = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>.</li>
<li>Nếu <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">X_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> và <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> phụ thuộc mạnh, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>I</mi><mo stretchy="false">(</mo><msub><mi>X</mi><mi>j</mi></msub><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">MI(X_j, y) &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>, với giá trị càng cao cho thấy <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">X_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> chứa nhiều thông tin về <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>.</li>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>Tính điểm cho mỗi đặc trưng</strong>: Hàm đánh giá sẽ gán một điểm số cho từng đặc trưng trong tập dữ liệu.</p>
</li>
<li>
<p><strong>Chọn ra <code>k</code> đặc trưng tốt nhấ</strong>t: Dựa trên điểm số, <strong>Select K Best</strong> sẽ giữ lại <code>k</code> đặc trưng có điểm cao nhất.</p>
</li>
</ol>
<p>Cài đặt chương trình:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">select_k_best</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Set<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Apply SelectKBest with Mutual Information to select the top k features.
        
        :return: A set of selected feature names.
        """</span>
        selector <span class="token operator">=</span> SelectKBest<span class="token punctuation">(</span>mutual_info_regression<span class="token punctuation">,</span> k<span class="token operator">=</span>self<span class="token punctuation">.</span>k_best<span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>X<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
        selected_features <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>X<span class="token punctuation">.</span>columns<span class="token punctuation">[</span>selector<span class="token punctuation">.</span>get_support<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>features_selected<span class="token punctuation">.</span>append<span class="token punctuation">(</span>selected_features<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> selected_features
</code></pre><h3 id="55-phương-pháp-gridsearchcv">5.5. Phương pháp GridSearchCV </h3>
<p><strong>GridSearchCV</strong> là một công cụ mạnh mẽ trong thư viện Scikit-learn để tìm kiếm tổ hợp siêu tham số (hyperparameter) tốt nhất cho một mô hình học máy. Phương pháp này sử dụng <strong>tìm kiếm lưới (grid search)</strong> kết hợp với <strong>cross-validation (CV)</strong> để đảm bảo hiệu suất của mô hình được tối ưu hóa trên dữ liệu chưa thấy trước.</p>
<p>Cách hoạt động:</p>
<ol>
<li>
<p><strong>Định nghĩa tập siêu tham số (hyperparameter grid):</strong></p>
<ul>
<li>Cần xác định các siêu tham số cần tối ưu và giá trị mà mỗi tham số có thể nhận.</li>
<li>Ví dụ: số lượng cây trong rừng ngẫu nhiên (<code>n_estimators</code>), độ sâu của cây (<code>max_depth</code>), v.v.</li>
</ul>
</li>
<li>
<p><strong>Tìm kiếm tổ hợp tham số:</strong></p>
<ul>
<li><strong>GridSearchCV</strong> thử tất cả các tổ hợp có thể của các giá trị trong lưới tham số.</li>
</ul>
</li>
<li>
<p><strong>Cross-validation:</strong></p>
<ul>
<li>Với mỗi tổ hợp tham số, <strong>GridSearchCV</strong> sử dụng kỹ thuật <strong>cross-validation</strong> (thường là k-fold) để đánh giá hiệu suất. Điều này giúp giảm nguy cơ overfitting và đảm bảo kết quả tổng quát.</li>
</ul>
</li>
<li>
<p><strong>Lựa chọn mô hình tốt nhất:</strong></p>
<ul>
<li>Tổ hợp tham số có hiệu suất tốt nhất trên tập cross-validation sẽ được chọn làm mô hình tối ưu.</li>
</ul>
</li>
</ol>
<p>Cài đặt chương trình:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>    <span class="token keyword keyword-def">def</span> <span class="token function">grid_search_feature_selection</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Set<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Use GridSearchCV to optimize hyperparameters of a RandomForestRegressor, and select features based on feature importance.
        
        :return: A set of selected feature names.
        """</span>
        param_grid <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'n_estimators'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'max_depth'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'min_samples_split'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'min_samples_leaf'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>

        rf <span class="token operator">=</span> RandomForestRegressor<span class="token punctuation">(</span>random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>

        grid_search <span class="token operator">=</span> GridSearchCV<span class="token punctuation">(</span>estimator<span class="token operator">=</span>rf<span class="token punctuation">,</span> param_grid<span class="token operator">=</span>param_grid<span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> scoring<span class="token operator">=</span><span class="token string">'neg_mean_squared_error'</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        grid_search<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>X<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

        best_model_grid <span class="token operator">=</span> grid_search<span class="token punctuation">.</span>best_estimator_

        pipe <span class="token operator">=</span> make_pipeline<span class="token punctuation">(</span>StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SelectFromModel<span class="token punctuation">(</span>estimator<span class="token operator">=</span>best_model_grid<span class="token punctuation">)</span><span class="token punctuation">,</span> LinearRegression<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pipe<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>X<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
        selected_features <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>X<span class="token punctuation">.</span>columns<span class="token punctuation">[</span>pipe<span class="token punctuation">.</span>named_steps<span class="token punctuation">[</span><span class="token string">'selectfrommodel'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get_support<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>features_selected<span class="token punctuation">.</span>append<span class="token punctuation">(</span>selected_features<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> selected_features
</code></pre><h3 id="56-phương-pháp-randomizedsearchcv">5.6. Phương pháp RandomizedSearchCV </h3>
<p><strong>RandomizedSearchCV</strong> là một kỹ thuật tối ưu hóa siêu tham số (hyperparameter optimization) được sử dụng trong học máy. Khác với <strong>GridSearchCV</strong>, <strong>RandomizedSearchCV</strong> không thử tất cả các tổ hợp tham số có thể, mà chọn ngẫu nhiên một số tổ hợp nhất định từ tập tham số đã chỉ định. Điều này giúp giảm thời gian tính toán trong khi vẫn có khả năng tìm ra tổ hợp tham số tốt nhất.</p>
<p>Cách hoạt động:</p>
<ol>
<li>
<p><strong>Định nghĩa tập tham số:</strong></p>
<ul>
<li>Thay vì sử dụng một danh sách cố định các giá trị tham số (như trong <strong>GridSearchCV</strong>), ta sẽ định nghĩa phạm vi giá trị hoặc phân phối của các tham số.</li>
</ul>
</li>
<li>
<p><strong>Lựa chọn ngẫu nhiên:</strong></p>
<ul>
<li><strong>RandomizedSearchCV</strong> lấy một số tổ hợp ngẫu nhiên (theo phân phối chỉ định hoặc từ phạm vi giá trị) để thử nghiệm.</li>
<li>Số tổ hợp cần thử được xác định bởi tham số <code>n_iter</code>.</li>
</ul>
</li>
<li>
<p><strong>Cross-validation:</strong></p>
<ul>
<li>Giống <strong>GridSearchCV</strong>, <strong>RandomizedSearchCV</strong> sử dụng <strong>cross-validation (CV)</strong> để đánh giá hiệu suất cho từng tổ hợp tham số.</li>
</ul>
</li>
<li>
<p><strong>Lựa chọn mô hình tốt nhất:</strong></p>
<ul>
<li>Sau khi thử một số tổ hợp, tổ hợp tham số có hiệu suất tốt nhất (theo tiêu chí đánh giá) sẽ được chọn.</li>
</ul>
</li>
</ol>
<p>Cài đặt chương trình:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">randomized_search_feature_selection</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Set<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Use RandomizedSearchCV to optimize hyperparameters of a RandomForestRegressor, and select features based on feature importance.
        
        :return: A set of selected feature names.
        """</span>
        param_dist <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'n_estimators'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">201</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'max_depth'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'min_samples_split'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'min_samples_leaf'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        rf <span class="token operator">=</span> RandomForestRegressor<span class="token punctuation">(</span>random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>

        random_search <span class="token operator">=</span> RandomizedSearchCV<span class="token punctuation">(</span>estimator<span class="token operator">=</span>rf<span class="token punctuation">,</span> param_distributions<span class="token operator">=</span>param_dist<span class="token punctuation">,</span> n_iter<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> scoring<span class="token operator">=</span><span class="token string">'neg_mean_squared_error'</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        random_search<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>X<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

        best_model_random <span class="token operator">=</span> random_search<span class="token punctuation">.</span>best_estimator_

        pipe <span class="token operator">=</span> make_pipeline<span class="token punctuation">(</span>StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SelectFromModel<span class="token punctuation">(</span>estimator<span class="token operator">=</span>best_model_random<span class="token punctuation">)</span><span class="token punctuation">,</span> LinearRegression<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pipe<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>X<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
        selected_features <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>X<span class="token punctuation">.</span>columns<span class="token punctuation">[</span>pipe<span class="token punctuation">.</span>named_steps<span class="token punctuation">[</span><span class="token string">'selectfrommodel'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get_support<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>features_selected<span class="token punctuation">.</span>append<span class="token punctuation">(</span>selected_features<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> selected_features
</code></pre><h3 id="57-chạy-chương-trình">5.7. Chạy chương trình </h3>
<p>Việc chạy chương trình cho phần Feature Selection sẽ được tích hợp và trình bày ở phần <a href="#7-x%C3%A2y-d%E1%BB%B1ng-pipeline-v%E1%BB%9Bi-housingpipelinepy">7. Xây dựng pipeline với <code>HousingPipeline.py</code></a> bên dưới. Tại đây, chương trình sẽ chạy toàn bộ quy trình Feature Selection và trả về danh sách các đặc trưng quan trọng nhất cho mô hình thông qua hàm <code>combine_selected_features</code>.</p>
<p>Vì vậy, để trực quan hơn cho quy trình Feature Selection, tôi sẽ tách riêng từng hàm và in ra kết quả của từng phương pháp chọn lọc đặc trưng để kiểm tra.</p>
<p>Các thư viện sẽ được khai báo tương tự như ở phần <a href="#51-khai-b%C3%A1o-th%C6%B0-vi%E1%BB%87n">5.1. Khai báo thư viện</a>.</p>
<h4 id="571-variance-threshold">5.7.1. Variance Threshold </h4>
<pre data-role="codeBlock" data-info="pythonX, y = housing_cleaned_coordinations.drop('price', axis=1), housing_cleaned_coordinations['price']" class="language-pythonx, pythonX,"><code># Threshold = 0.1 (removes features with less than 10% variance)
selector = VarianceThreshold(threshold=0.1)
X_kvar = selector.fit_transform(X)
selected_columns = X.columns[selector.get_support()]  # Get columns with variance greater than threshold
print(selected_columns)
</code></pre><pre data-role="codeBlock" data-info="md" class="language-gfm md"><code>Index(['id', 'area', 'bedrooms', 'wc', 'n_floors', 'car_place', 'Cluster',
       'Distance to center 0', 'Distance to center 1'],
      dtype='object')
</code></pre><p>Đối với phương pháp <strong>Variance Threshold</strong>, sau khi áp dụng, chúng ta giữ lại 9 đặc trưng quan trọng nhất với ngưỡng phương sai là <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.1</mn></mrow><annotation encoding="application/x-tex">0.1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.1</span></span></span></span>.</p>
<h4 id="572-select-k-best">5.7.2. Select K Best </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Use f_regression for regression problems</span>
X_kbest <span class="token operator">=</span> SelectKBest<span class="token punctuation">(</span>f_regression<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>

<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">'Selected columns after applying SelectKBest:'</span><span class="token punctuation">,</span> X<span class="token punctuation">.</span>columns<span class="token punctuation">[</span>SelectKBest<span class="token punctuation">(</span>f_regression<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">.</span>get_support<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><pre data-role="codeBlock" data-info="md" class="language-gfm md"><code>Selected columns after applying SelectKBest: Index(['bedrooms', 'wc', 'n_floors', 'car_place', 'Distance to center 0'], dtype='object')
</code></pre><p>Phương pháp <strong>Select K Best</strong> ở trên chọn ra 5 đặc trưng quan trọng nhất dựa trên hàm score <code>f_regression</code>. Để chọn ra số lượng đặc trưng tùy ý, chỉ cần thay đổi giá trị của <code>k</code>.</p>
<h4 id="573-gridsearchcv">5.7.3. GridSearchCV </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Define the parameter grid to search for the best parameters</span>
param_grid <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'n_estimators'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'max_depth'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'min_samples_split'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'min_samples_leaf'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment"># Initialize the RandomForest model</span>
rf <span class="token operator">=</span> RandomForestRegressor<span class="token punctuation">(</span>random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>

<span class="token comment"># Perform grid search with cross-validation</span>
grid_search <span class="token operator">=</span> GridSearchCV<span class="token punctuation">(</span>estimator<span class="token operator">=</span>rf<span class="token punctuation">,</span> param_grid<span class="token operator">=</span>param_grid<span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> scoring<span class="token operator">=</span><span class="token string">'neg_mean_squared_error'</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># Fit the model</span>
grid_search<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>

<span class="token comment"># Output the best parameters and score</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Best parameters found: "</span><span class="token punctuation">,</span> grid_search<span class="token punctuation">.</span>best_params_<span class="token punctuation">)</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Best score (negative MSE): "</span><span class="token punctuation">,</span> <span class="token operator">-</span>grid_search<span class="token punctuation">.</span>best_score_<span class="token punctuation">)</span>

<span class="token comment"># Use the best estimator</span>
best_model <span class="token operator">=</span> grid_search<span class="token punctuation">.</span>best_estimator_

<span class="token comment"># Evaluate using cross-validation on the best model</span>
mse_best <span class="token operator">=</span> cross_val_score<span class="token punctuation">(</span>best_model<span class="token punctuation">,</span> X<span class="token punctuation">,</span> y<span class="token punctuation">,</span> scoring<span class="token operator">=</span><span class="token string">'neg_mean_squared_error'</span><span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">'MSE with best model:'</span><span class="token punctuation">,</span> <span class="token operator">-</span>mse_best<span class="token punctuation">)</span>
</code></pre><pre data-role="codeBlock" data-info="md" class="language-gfm md"><code>Best parameters found:  {'max_depth': None, 'min_samples_leaf': 2, 'min_samples_split': 2, 'n_estimators': 200}
Best score (negative MSE):  2.8125462355474498
MSE with best model: 2.8125462355474498
</code></pre><p>Phương pháp <strong>GridSearchCV</strong> tìm ra mô hình tốt nhất với các siêu tham số tối ưu và MSE tương ứng. Đồng thời, chúng ta cũng chọn ra các đặc trưng quan trọng từ mô hình dựa vào feature importance.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-for">for</span> col <span class="token keyword keyword-in">in</span> X<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>col<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>best_model<span class="token punctuation">.</span>feature_importances_<span class="token punctuation">[</span>X<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>get_loc<span class="token punctuation">(</span>col<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre><pre data-role="codeBlock" data-info="md" class="language-gfm md"><code>id: 0.0929387363740693
area: 0.16166346047574368
bedrooms: 0.09137136922181854
wc: 0.36146322967438793
n_floors: 0.03905496700552482
car_place: 0.020482281172774886
latitude: 0.055485304951903375
longitude: 0.0425910603688488
Cluster: 0.0009709008765686273
Distance to center 0: 0.05543350423025281
Distance to center 1: 0.07854518564810725
</code></pre><p>Các đặc trưng quan trọng được chọn từ mô hình Random Forest. Ta có thể chọn ra <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> đặc trưng quan trọng nhất từ mô hình tùy ý dựa vào thứ tự giảm dần của feature importance.</p>
<h4 id="574-randomizedsearchcv">5.7.4. RandomizedSearchCV </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Define the parameter distribution</span>
param_dist <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'n_estimators'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">201</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'max_depth'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'min_samples_split'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'min_samples_leaf'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment"># Initialize the RandomForest model</span>
rf <span class="token operator">=</span> RandomForestRegressor<span class="token punctuation">(</span>random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>

<span class="token comment"># Use RandomizedSearchCV to search over the parameter space</span>
random_search <span class="token operator">=</span> RandomizedSearchCV<span class="token punctuation">(</span>estimator<span class="token operator">=</span>rf<span class="token punctuation">,</span> param_distributions<span class="token operator">=</span>param_dist<span class="token punctuation">,</span> 
                                   n_iter<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> scoring<span class="token operator">=</span><span class="token string">'neg_mean_squared_error'</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># Fit the model</span>
random_search<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>

<span class="token comment"># Output the best parameters and score</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Best parameters found: "</span><span class="token punctuation">,</span> random_search<span class="token punctuation">.</span>best_params_<span class="token punctuation">)</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Best score (negative MSE): "</span><span class="token punctuation">,</span> <span class="token operator">-</span>random_search<span class="token punctuation">.</span>best_score_<span class="token punctuation">)</span>

<span class="token comment"># Use the best model from random search</span>
best_model_random <span class="token operator">=</span> random_search<span class="token punctuation">.</span>best_estimator_

<span class="token comment"># Evaluate the best model using cross-validation</span>
mse_best_random <span class="token operator">=</span> cross_val_score<span class="token punctuation">(</span>best_model_random<span class="token punctuation">,</span> X<span class="token punctuation">,</span> y<span class="token punctuation">,</span> scoring<span class="token operator">=</span><span class="token string">'neg_mean_squared_error'</span><span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">'MSE with best random search model:'</span><span class="token punctuation">,</span> <span class="token operator">-</span>mse_best_random<span class="token punctuation">)</span>
</code></pre><pre data-role="codeBlock" data-info="md" class="language-gfm md"><code>Best parameters found:  {'n_estimators': np.int64(150), 'min_samples_split': np.int64(2), 'min_samples_leaf': np.int64(2), 'max_depth': 30}
Best score (negative MSE):  2.8203427815496713
MSE with best random search model: 2.8203427815496713
</code></pre><p>Phương pháp <strong>RandomizedSearchCV</strong> tìm ra mô hình tốt nhất với các siêu tham số tối ưu và MSE tương ứng. Đồng thời, chúng ta cũng chọn ra các đặc trưng quan trọng từ mô hình dựa vào feature importance.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Feature Importances:"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-for">for</span> col <span class="token keyword keyword-in">in</span> X<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>col<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>best_model_random<span class="token punctuation">.</span>feature_importances_<span class="token punctuation">[</span>X<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>get_loc<span class="token punctuation">(</span>col<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre><pre data-role="codeBlock" data-info="md" class="language-gfm md"><code>Feature Importances:
id: 0.09261421743625706
area: 0.1618757465102772
bedrooms: 0.09250090389161265
wc: 0.3615603667027046
n_floors: 0.038810754688151865
car_place: 0.020080871180090477
latitude: 0.05578972070743495
longitude: 0.04318122714050373
Cluster: 0.0008897133300754471
Distance to center 0: 0.05459280828699985
Distance to center 1: 0.07810367012589219
</code></pre><p>Các đặc trưng quan trọng được chọn từ mô hình Random Forest. Ta có thể chọn ra <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> đặc trưng quan trọng nhất từ mô hình tùy ý dựa vào thứ tự giảm dần của feature importance.</p>
<h3 id="58-kết-quả-chọn-lọc-đặc-trưng">5.8. Kết quả chọn lọc đặc trưng </h3>
<p>Bảng dữ liệu sau khi chọn lọc đặc trưng dựa trên phương thức <code>combine_selected_features</code> sau khi chạy toàn bộ quy trình Feature Selection:</p>
<table>
<thead>
<tr>
<th>Cluster</th>
<th>n_floors</th>
<th>area</th>
<th>id</th>
<th>car_place</th>
<th>wc</th>
<th>bedrooms</th>
<th>Distance to center 1</th>
<th>price</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1.0</td>
<td>57</td>
<td>121356</td>
<td>0</td>
<td>2.0000</td>
<td>2.0000</td>
<td>10.874742</td>
<td>0.790</td>
</tr>
<tr>
<td>1</td>
<td>3.0</td>
<td>16</td>
<td>115827</td>
<td>0</td>
<td>3.0000</td>
<td>4.0000</td>
<td>3.401934</td>
<td>2.600</td>
</tr>
<tr>
<td>2</td>
<td>5.0</td>
<td>32</td>
<td>115833</td>
<td>1</td>
<td>2.0696</td>
<td>4.0000</td>
<td>5.458846</td>
<td>3.000</td>
</tr>
<tr>
<td>3</td>
<td>3.0</td>
<td>38</td>
<td>115834</td>
<td>1</td>
<td>4.0000</td>
<td>3.0000</td>
<td>4.487381</td>
<td>4.600</td>
</tr>
<tr>
<td>4</td>
<td>4.0</td>
<td>76</td>
<td>115837</td>
<td>1</td>
<td>4.0000</td>
<td>4.0000</td>
<td>8.500217</td>
<td>3.450</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>5828</td>
<td>4.0</td>
<td>46</td>
<td>88818</td>
<td>1</td>
<td>4.0000</td>
<td>4.0000</td>
<td>2.876457</td>
<td>9.500</td>
</tr>
<tr>
<td>5829</td>
<td>1.0</td>
<td>48</td>
<td>86770</td>
<td>0</td>
<td>2.0000</td>
<td>2.0000</td>
<td>9.774195</td>
<td>1.950</td>
</tr>
<tr>
<td>5830</td>
<td>3.0</td>
<td>56</td>
<td>86258</td>
<td>1</td>
<td>4.0000</td>
<td>3.0000</td>
<td>7.209409</td>
<td>10.200</td>
</tr>
<tr>
<td>5831</td>
<td>5.0</td>
<td>47</td>
<td>86002</td>
<td>1</td>
<td>5.0000</td>
<td>4.0000</td>
<td>6.469803</td>
<td>6.200</td>
</tr>
<tr>
<td>5832</td>
<td>2.0</td>
<td>30</td>
<td>108530</td>
<td>0</td>
<td>1.2645</td>
<td>1.6957</td>
<td>6.643871</td>
<td>0.001</td>
</tr>
</tbody>
</table>
<p>[5833 rows × 9 columns]</p>
<h2 id="6-tách-tập-dữ-liệu">6. Tách tập dữ liệu </h2>
<p>Trong phần này, chúng ta sẽ tiến hành xây dựng tập dữ liệu huấn luyện (train set) và kiểm tra (test set) từ bộ dữ liệu đã được xử lý trước đó. Mục đích là tìm ra biến có tương quan cao với giá (price) và phân tích cách biến đó phân bố. Sau đó, chia dữ liệu ra 2 tập train và test theo tỷ lệ phù hợp.</p>
<p>Đầu tiên, chúng ta sẽ xem xét mức độ tương quan giữa giá (price) và các biến khác trong bộ dữ liệu:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>housing_final <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'./datasets/housing_final_features_with_price.csv'</span><span class="token punctuation">)</span>

corr_matrix <span class="token operator">=</span> housing_final<span class="token punctuation">.</span>corr<span class="token punctuation">(</span>numeric_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
important_corr <span class="token operator">=</span> corr_matrix<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>corr_matrix<span class="token punctuation">,</span> annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'coolwarm'</span><span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">".2f"</span><span class="token punctuation">)</span>
</code></pre><p><img src="./images/corr_matrix.png" alt="Corr Matrix"><br>
<em>Hình 1: Biểu đồ ma trận tương quan giữa price và các biến khác</em></p>
<p>Biểu đồ ma trận tương quan cho thấy mức độ tương quan giữa giá (price) và các biến khác trong bộ dữ liệu. Biến có tương quan cao nhất với price là wc và bedrooms.</p>
<p>Tiếp theo, chúng ta sẽ xem xét cách phân bố dữ liệu của biến bedrooms với <code>q=4</code> để chia thành 4 danh mục:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>important_feature <span class="token operator">=</span> <span class="token string">'bedrooms'</span>  <span class="token comment"># Biến quan trọng nhất sau phân tích tương quan</span>
housing_final<span class="token punctuation">[</span><span class="token string">"bedrooms_category"</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>qcut<span class="token punctuation">(</span>housing_final<span class="token punctuation">[</span>important_feature<span class="token punctuation">]</span><span class="token punctuation">,</span> q<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> labels<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

housing_final<span class="token punctuation">[</span><span class="token string">"bedrooms_category"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort_index<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>plot<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>rot<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> grid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Distribution of bedrooms"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"Bedroom Category"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"Count"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><img src="./images/bedrooms_category.png" alt="Bedroom Category"></p>
<p><em>Hình 2: Biểu đồ phân bố dữ liệu của biến bedrooms</em></p>
<p>Biến "bedrooms" được phân chia thành 4 danh mục dựa trên phân vị tứ tư. Biểu đồ thanh minh hoạ cho tần suất của từng danh mục, đảm bảo việc chia tập huấn luyện và kiểm tra được đồng đều dựa theo biến này. Cùng xem bảng dữ liệu với biến "bedrooms_category" được tích hợp (biến này sẽ được loại bỏ sau khi chia tập dữ liệu):</p>
<table>
<thead>
<tr>
<th>Cluster</th>
<th>n_floors</th>
<th>area</th>
<th>id</th>
<th>car_place</th>
<th>wc</th>
<th>bedrooms</th>
<th>Distance to center 1</th>
<th>price</th>
<th>bedrooms_category</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1.0</td>
<td>57</td>
<td>121356</td>
<td>0</td>
<td>2.0000</td>
<td>2.0000</td>
<td>10.874742</td>
<td>0.790</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>3.0</td>
<td>16</td>
<td>115827</td>
<td>0</td>
<td>3.0000</td>
<td>4.0000</td>
<td>3.401934</td>
<td>2.600</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>5.0</td>
<td>32</td>
<td>115833</td>
<td>1</td>
<td>2.0696</td>
<td>4.0000</td>
<td>5.458846</td>
<td>3.000</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>3.0</td>
<td>38</td>
<td>115834</td>
<td>1</td>
<td>4.0000</td>
<td>3.0000</td>
<td>4.487381</td>
<td>4.600</td>
<td>1</td>
</tr>
<tr>
<td>4</td>
<td>4.0</td>
<td>76</td>
<td>115837</td>
<td>1</td>
<td>4.0000</td>
<td>4.0000</td>
<td>8.500217</td>
<td>3.450</td>
<td>2</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>5828</td>
<td>4.0</td>
<td>46</td>
<td>88818</td>
<td>1</td>
<td>4.0000</td>
<td>4.0000</td>
<td>2.876457</td>
<td>9.500</td>
<td>2</td>
</tr>
<tr>
<td>5829</td>
<td>1.0</td>
<td>48</td>
<td>86770</td>
<td>0</td>
<td>2.0000</td>
<td>2.0000</td>
<td>9.774195</td>
<td>1.950</td>
<td>0</td>
</tr>
<tr>
<td>5830</td>
<td>3.0</td>
<td>56</td>
<td>86258</td>
<td>1</td>
<td>4.0000</td>
<td>3.0000</td>
<td>7.209409</td>
<td>10.200</td>
<td>1</td>
</tr>
<tr>
<td>5831</td>
<td>5.0</td>
<td>47</td>
<td>86002</td>
<td>1</td>
<td>5.0000</td>
<td>4.0000</td>
<td>6.469803</td>
<td>6.200</td>
<td>2</td>
</tr>
<tr>
<td>5832</td>
<td>2.0</td>
<td>30</td>
<td>108530</td>
<td>0</td>
<td>1.2645</td>
<td>1.6957</td>
<td>6.643871</td>
<td>0.001</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>[5833 rows × 10 columns]</p>
<p>Cuối cùng, chúng ta sẽ chia tập dữ liệu thành tập huấn luyện và tập kiểm tra với tỷ lệ 80-20 với <code>stratify</code> theo biến "bedrooms_category", sau đó lưu dưới dạng file CSV vào thư mục <code>datasets</code>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>train_set<span class="token punctuation">,</span> test_set <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>housing_final<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> stratify<span class="token operator">=</span>housing_final<span class="token punctuation">[</span><span class="token string">"bedrooms_category"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>

<span class="token keyword keyword-for">for</span> set_ <span class="token keyword keyword-in">in</span> <span class="token punctuation">[</span>train_set<span class="token punctuation">,</span> test_set<span class="token punctuation">]</span><span class="token punctuation">:</span>
    set_<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"bedrooms_category"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

train_set<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'datasets/housing_train.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
test_set<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'datasets/housing_test.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre><h2 id="7-xây-dựng-pipeline-với-housingpipelinepy">7. Xây dựng pipeline với <code>HousingPipeline.py</code> </h2>
<p><code>HousingPipeline</code> xây dựng một quy trình có cấu trúc rõ ràng các bước từ đầu đến cuối, chỉ cần truyền dataframe vào thì <code>HousingPipeline</code> sẽ xử lý tất cả các bước:</p>
<ul>
<li>Xử lý và làm sạch dữ liệu.</li>
<li>Trực quan hoá dữ liệu và Feature Engineering.</li>
<li>Feature Selection.</li>
<li>Tách tập dữ liệu thành <strong>Train set</strong> và <strong>Test set</strong>.</li>
</ul>
<p>Cuối cùng, chúng ta sẽ nhận được 2 tập <strong>Train set</strong> và <strong>Test set</strong> để chuẩn bị cho bước huấn luyện mô hình.</p>
<p>Ngoài ra, <code>HousingPipeline</code> có thể tái sử dụng cho việc chuẩn bị dữ liệu, giúp tự động hoá quy trình:</p>
<ul>
<li>Giảm thiểu các bước thủ công khi xử lý dữ liệu.</li>
<li>Tạo ra các bước liên tục để phân tích và xử lý dữ liệu từ thô đến sạch.</li>
</ul>
<p><strong>Lợi ích của <code>HousingPipeline</code>:</strong></p>
<ul>
<li>Tính hiệu quả: Giảm thời gian và lỗi khi xử lý dữ liệu thủ công.</li>
<li>Tính tái sử dụng: Pipeline được dùng lại dễ dàng, đặc biệt với các tập dữ liệu lớn hoặc dự án phức tạp.</li>
<li>Tính đồng nhất: Đảm bảo tất cả dữ liệu được xử lý theo cùng một cách.</li>
</ul>
<p>Cài đặt <code>HousingPipeline</code></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
<span class="token keyword keyword-import">import</span> folium
<span class="token keyword keyword-from">from</span> typing <span class="token keyword keyword-import">import</span> List
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword keyword-import">import</span> StandardScaler
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword keyword-import">import</span> train_test_split
<span class="token keyword keyword-from">from</span> DataProcessing <span class="token keyword keyword-import">import</span> DataCleaner<span class="token punctuation">,</span> del_col
<span class="token keyword keyword-from">from</span> Visualize <span class="token keyword keyword-import">import</span> check_coordinates_in_vietnam<span class="token punctuation">,</span> RealEstateVisualizerCluster
<span class="token keyword keyword-from">from</span> FeatureSelection <span class="token keyword keyword-import">import</span> FeatureSelector

<span class="token keyword keyword-def">def</span> <span class="token function">process_data</span><span class="token punctuation">(</span>api_key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> target_col<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> drop_na_cols<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span> input_cols<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span> cols_to_impute<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span> unnecessary_columns<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Function to process data using DataCleaner and del_col from the DataProcessing module.

    Parameters:
    - api_key (str): API key used to create an instance of DataCleaner.
    - df (pd.DataFrame): The DataFrame containing the data to be processed.
    - target_col (str): The name of the target column for outlier processing.
    - drop_na_cols (list): A list of columns to remove rows with NA values. 
    - input_cols (list): A list of columns to be used for imputing missing values.
    - cols_to_impute (list): A list of columns to impute missing values.

    Returns:
    - pd.DataFrame: The cleaned and processed DataFrame.
    """</span>
    <span class="token comment"># Create an instance of DataCleaner</span>
    data_cleaner <span class="token operator">=</span> DataCleaner<span class="token punctuation">(</span>api_key<span class="token punctuation">)</span>

    <span class="token comment"># Clean the data: handle outliers, drop rows with NA, and impute missing values</span>
    cleaned_df <span class="token operator">=</span> data_cleaner<span class="token punctuation">.</span>clean_data<span class="token punctuation">(</span>
        df<span class="token operator">=</span>df<span class="token punctuation">,</span>
        target_col<span class="token operator">=</span>target_col<span class="token punctuation">,</span>
        drop_na_cols<span class="token operator">=</span>drop_na_cols<span class="token punctuation">,</span>
        input_cols<span class="token operator">=</span>input_cols<span class="token punctuation">,</span>
        cols_to_impute<span class="token operator">=</span>cols_to_impute
    <span class="token punctuation">)</span>

    <span class="token comment"># Remove unnecessary columns</span>
    processed_df <span class="token operator">=</span> del_col<span class="token punctuation">(</span>cleaned_df<span class="token punctuation">,</span> unnecessary_columns<span class="token punctuation">)</span>

    <span class="token comment"># Return the cleaned DataFrame</span>
    <span class="token keyword keyword-return">return</span> processed_df

<span class="token keyword keyword-def">def</span> <span class="token function">process_and_visualize_real_estate</span><span class="token punctuation">(</span>shapefile_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> housing_df<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> num_clusters<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span>folium<span class="token punctuation">.</span>Map<span class="token punctuation">,</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Process and visualize real estate data.

    Parameters:
        shapefile_path (str): Path to the shapefile containing Vietnam's territorial boundaries.
        housing_df (pd.DataFrame): Real estate data in the form of a DataFrame.
        num_clusters (int): Number of clusters for data grouping, default is 5.

    Returns:
        folium.Map: A folium map with visualized clusters.
    """</span>
    <span class="token comment"># Check coordinates within Vietnam's boundaries</span>
    valid_housing_df <span class="token operator">=</span> check_coordinates_in_vietnam<span class="token punctuation">(</span>shapefile_path<span class="token punctuation">,</span> housing_df<span class="token punctuation">)</span>

    <span class="token comment"># Initialize RealEstateVisualizerCluster</span>
    visualizer <span class="token operator">=</span> RealEstateVisualizerCluster<span class="token punctuation">(</span>housing_df<span class="token operator">=</span>valid_housing_df<span class="token punctuation">,</span> num_clusters<span class="token operator">=</span>num_clusters<span class="token punctuation">)</span>

    <span class="token comment"># Perform clustering and prepare data for visualization</span>
    visualizer<span class="token punctuation">.</span>fit_kmeans<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Create and return a folium map with clusters</span>
    real_estate_map <span class="token operator">=</span> visualizer<span class="token punctuation">.</span>create_map<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Get the processed DataFrame with cluster information</span>
    processed_df <span class="token operator">=</span> visualizer<span class="token punctuation">.</span>housing

    <span class="token keyword keyword-return">return</span> real_estate_map<span class="token punctuation">,</span> processed_df

<span class="token keyword keyword-def">def</span> <span class="token function">select_important_features</span><span class="token punctuation">(</span>X<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> y<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">,</span> variance_threshold<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">,</span> k_best<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> top_k_f_test<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Use FeatureSelector to select important features.

    Parameters:
        X (pd.DataFrame): Feature matrix.
        y (pd.Series): Target variable.
        variance_threshold (float): Threshold for feature selection using the VarianceThreshold method.
        k_best (int): Number of top features to select using SelectKBest (F-regression).
        top_k_f_test (int): Number of top features to select based on F-test and Mutual Information.

    Returns:
        List[str]: List of important selected features.
    """</span>
    <span class="token comment"># Create an instance of FeatureSelector</span>
    feature_selector <span class="token operator">=</span> FeatureSelector<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">,</span> variance_threshold<span class="token punctuation">,</span> k_best<span class="token punctuation">,</span> top_k_f_test<span class="token punctuation">)</span>
    
    <span class="token comment"># Run the feature selection process</span>
    selected_features <span class="token operator">=</span> feature_selector<span class="token punctuation">.</span>fit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-return">return</span> selected_features

<span class="token keyword keyword-def">def</span> <span class="token function">split_data</span><span class="token punctuation">(</span>X<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> target_column<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Split the data into training and test sets.

    Parameters:
        X (pandas.DataFrame): The input DataFrame.
        target_column (str): The target column to split the data.

    Returns:
        tuple[pandas.DataFrame, pd.DataFrame, pd.DataFrame]: 
        - The full DataFrame after processing.
        - The training set.
        - The test set.
    """</span>
    <span class="token comment"># Calculate correlations and find the highest correlated column to the target</span>
    corr <span class="token operator">=</span> X<span class="token punctuation">.</span>corr<span class="token punctuation">(</span><span class="token punctuation">)</span>
    target_corr <span class="token operator">=</span> corr<span class="token punctuation">[</span>target_column<span class="token punctuation">]</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    highest_corr_column <span class="token operator">=</span> target_corr<span class="token punctuation">.</span>index<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># The second most correlated column (excluding the target itself)</span>

    <span class="token comment"># Create a new column with quantile-based categories</span>
    X<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>highest_corr_column<span class="token punctuation">}</span></span><span class="token string"> Category'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>qcut<span class="token punctuation">(</span>
        X<span class="token punctuation">[</span>highest_corr_column<span class="token punctuation">]</span><span class="token punctuation">,</span> q<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> labels<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> duplicates<span class="token operator">=</span><span class="token string">'drop'</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># Split the data using stratification on the new category column</span>
    X_train<span class="token punctuation">,</span> X_test <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>
        X<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> stratify<span class="token operator">=</span>X<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>highest_corr_column<span class="token punctuation">}</span></span><span class="token string"> Category'</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># Remove the temporary category column from all sets</span>
    <span class="token keyword keyword-for">for</span> subset <span class="token keyword keyword-in">in</span> <span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> X_test<span class="token punctuation">)</span><span class="token punctuation">:</span>
        subset<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>highest_corr_column<span class="token punctuation">}</span></span><span class="token string"> Category'</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    X<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>highest_corr_column<span class="token punctuation">}</span></span><span class="token string"> Category'</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> X<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span> X_test


<span class="token keyword keyword-if">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># Read dataset</span>
    housing <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'datasets/housing.csv'</span><span class="token punctuation">,</span> sep <span class="token operator">=</span> <span class="token string">'\t'</span><span class="token punctuation">)</span>

    api_key <span class="token operator">=</span> <span class="token string">"ccc01759bd474d50b77b337c740ed0b7"</span> <span class="token comment"># api_key to get 'latitude' and 'longitude'</span>
    shapefile_path <span class="token operator">=</span> <span class="token string">'vietnam_Vietnam_Country_Boundary/extracted_files/vietnam_Vietnam_Country_Boundary.shp'</span> <span class="token comment"># Path to the shapefile containing the boundary of Vietnam</span>
    
    <span class="token comment"># Processing data</span>
    processed_df <span class="token operator">=</span> process_data<span class="token punctuation">(</span>
        api_key<span class="token operator">=</span>api_key<span class="token punctuation">,</span>
        df<span class="token operator">=</span>housing<span class="token punctuation">,</span>
        target_col<span class="token operator">=</span><span class="token string">'price'</span><span class="token punctuation">,</span> 
        drop_na_cols<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">,</span> <span class="token string">'area'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        input_cols<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">,</span> <span class="token string">'area'</span><span class="token punctuation">,</span> <span class="token string">'car_place'</span><span class="token punctuation">,</span> <span class="token string">'facade'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        cols_to_impute<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'bedrooms'</span><span class="token punctuation">,</span> <span class="token string">'wc'</span><span class="token punctuation">,</span> <span class="token string">'n_floors'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        unnecessary_columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'facade'</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># Process and visualize real estate</span>
    cluster_map<span class="token punctuation">,</span> processed_df <span class="token operator">=</span> process_and_visualize_real_estate<span class="token punctuation">(</span>
        shapefile_path<span class="token operator">=</span>shapefile_path<span class="token punctuation">,</span>
        housing_df<span class="token operator">=</span>processed_df<span class="token punctuation">,</span>
        num_clusters<span class="token operator">=</span><span class="token number">5</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># Display the cluster map</span>
    cluster_map<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"foliumVisualizationCluster.html"</span><span class="token punctuation">)</span>

    <span class="token comment"># Select important features based on 'price'</span>
    features <span class="token operator">=</span> processed_df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token string">'price'</span><span class="token punctuation">)</span>
    target <span class="token operator">=</span> processed_df<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span>
    selected_features <span class="token operator">=</span> select_important_features<span class="token punctuation">(</span>features<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
    X_filtered <span class="token operator">=</span> processed_df<span class="token punctuation">[</span>selected_features<span class="token punctuation">]</span>

    <span class="token comment"># Combine the standardized features with the target column 'price'</span>
    X_final_with_price <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>X_filtered<span class="token punctuation">,</span> target<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># Split the data into train set, test set and save to CSV files</span>
    df_processed<span class="token punctuation">,</span> df_train<span class="token punctuation">,</span> df_test <span class="token operator">=</span> split_data<span class="token punctuation">(</span>X_final_with_price<span class="token punctuation">,</span> target_column<span class="token operator">=</span><span class="token string">'price'</span><span class="token punctuation">)</span>
    df_train<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'datasets/housing_train.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    df_test<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'datasets/housing_test.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre><hr>
<h1 id="iii-model-training">III. Model Training </h1>
<p>Các tham số cố định, như tên cột, địa chỉ file in/out, được đưa vào file <code>constants.py</code>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-import">import</span> os

DATA_DIRPATH <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">)</span>
TRAIN_PATH <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>DATA_DIRPATH<span class="token punctuation">,</span> <span class="token string">"housing_train.csv"</span><span class="token punctuation">)</span>
TEST_PATH <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>DATA_DIRPATH<span class="token punctuation">,</span> <span class="token string">"housing_test.csv"</span><span class="token punctuation">)</span>
BENCHMARK_DIRPATH <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"benchmark"</span><span class="token punctuation">)</span>

TARGET_COLUMN <span class="token operator">=</span> <span class="token string">"price"</span>
</code></pre><p>Vì có những phần xử lý cần được thực hiện chung với mô hình vì ta cần lưu phần tiền xử lý đó để cùng áp dụng khi đánh giá mô hình, như StandardScaler, nên ta cần tiền xử lý mô hình trước bằng hàm <code>preprocess_data()</code>. Sau đó, đưa data đã tiền xử lý này vào từng nhóm mô hình để huấn luyện.</p>
<p>Phần huấn luyện mô hình có thể có thể hiểu đơn giản là 1 struct có interface như sau:</p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token keyword keyword-type">type</span> ModelTraining <span class="token keyword keyword-interface">interface</span> <span class="token punctuation">{</span>
  data<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span>
  train_parameters<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><p>Vì vậy nên ta có thể gom chung vào 1 file <code>utils.py</code> 2 hàm <code>train_default_models()</code> và <code>fine_tune_models()</code>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-from">from</span> pathlib <span class="token keyword keyword-import">import</span> Path
<span class="token keyword keyword-import">import</span> time
<span class="token keyword keyword-from">from</span> typing <span class="token keyword keyword-import">import</span> Any
<span class="token keyword keyword-from">from</span> joblib <span class="token keyword keyword-import">import</span> dump

<span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
<span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np

<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword keyword-import">import</span> GridSearchCV
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
    root_mean_squared_error<span class="token punctuation">,</span>
    r2_score<span class="token punctuation">,</span>
    mean_absolute_percentage_error<span class="token punctuation">,</span>
    mean_absolute_error<span class="token punctuation">,</span>
    explained_variance_score<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword keyword-import">import</span> StandardScaler


<span class="token keyword keyword-def">def</span> <span class="token function">train_default_models</span><span class="token punctuation">(</span>
    X<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> y<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">,</span> model_dict<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">,</span> benchmark_path<span class="token punctuation">:</span> <span class="token builtin">str</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Train multiple models with default parameters and benchmark their performance.

    Parameters:
    ----------
    - X (pd.DataFrame): The input features for training the models.
    - y (pd.Series): The target variable for training the models.
    - model_dict (dict[str, Any]): A dictionary where keys are model names and values are model instances.
    - benchmark_path (str): The file path to save the benchmark results.

    Returns:
    --------
    None
    """</span>
    <span class="token keyword keyword-for">for</span> model_name<span class="token punctuation">,</span> model <span class="token keyword keyword-in">in</span> model_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
        end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        benchmark_model<span class="token punctuation">(</span>
            y_true<span class="token operator">=</span>y<span class="token punctuation">,</span>
            y_pred<span class="token operator">=</span>model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">,</span>
            num_features<span class="token operator">=</span>X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            train_time<span class="token operator">=</span>end_time <span class="token operator">-</span> start_time<span class="token punctuation">,</span>
            model_name<span class="token operator">=</span>model_name<span class="token punctuation">,</span>
            benchmark_path<span class="token operator">=</span>benchmark_path<span class="token punctuation">,</span>
            note<span class="token operator">=</span><span class="token string">"Using default parameters"</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>


<span class="token keyword keyword-def">def</span> <span class="token function">fine_tune_models</span><span class="token punctuation">(</span>
    X<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">,</span>
    finetune_dict<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">[</span>Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    model_dict<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">,</span>
    benchmark_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Fine-tune multiple models and benchmark their performance.

    Parameters:
    ----------
    - X (pd.DataFrame): The input features for training the models.
    - y (pd.Series): The target variable for training the models.
    - finetune_dict (dict[str, dict[str, list[Any]]]): A dictionary where keys are model names and values are parameter grids for GridSearchCV.
    - model_dict (dict[str, Any]): A dictionary where keys are model names and values are model instances.
    - benchmark_path (str): The file path to save the benchmark results.

    Returns:
    --------
    None
    """</span>
    <span class="token keyword keyword-for">for</span> model_name<span class="token punctuation">,</span> param_dict <span class="token keyword keyword-in">in</span> finetune_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        grid_search <span class="token operator">=</span> GridSearchCV<span class="token punctuation">(</span>model_dict<span class="token punctuation">[</span>model_name<span class="token punctuation">]</span><span class="token punctuation">,</span> param_dict<span class="token punctuation">)</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        grid_search<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
        end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        best_params <span class="token operator">=</span> grid_search<span class="token punctuation">.</span>best_params_
        best_model <span class="token operator">=</span> grid_search<span class="token punctuation">.</span>best_estimator_
        benchmark_model<span class="token punctuation">(</span>
            y_true<span class="token operator">=</span>y<span class="token punctuation">,</span>
            y_pred<span class="token operator">=</span>best_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">,</span>
            num_features<span class="token operator">=</span>X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            train_time<span class="token operator">=</span>end_time <span class="token operator">-</span> start_time<span class="token punctuation">,</span>
            model_name<span class="token operator">=</span>model_name<span class="token punctuation">,</span>
            benchmark_path<span class="token operator">=</span>benchmark_path<span class="token punctuation">,</span>
            note<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"Fine tune, best params is </span><span class="token interpolation"><span class="token punctuation">{</span>best_params<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>


<span class="token keyword keyword-def">def</span> <span class="token function">benchmark_model</span><span class="token punctuation">(</span>
    y_true<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">,</span>
    y_pred<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">,</span>
    num_features<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    train_time<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
    model_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    benchmark_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    note<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Evaluate and save model performance metrics.

    This function calculates various performance metrics for a regression model,
    including RMSE, R-squared, AIC, BIC, adjusted R-squared, MAPE, MAE, and explained variance.
    It then saves these metrics along with the training time, model name, and an optional note
    to a CSV file specified by `benchmark_path`.

    Parameters:
    ----------
    - y_true (pd.Series): True target values.
    - y_pred (np.ndarray): Predicted target values.
    - num_features (int): Number of features used in the model, required to calculate AIC and BIC.
    - train_time (float): Time taken to train the model in seconds.
    - model_name (str): Name of the model.
    - benchmark_path (str): Path to the CSV file where benchmark results will be saved.
    - note (str, optional): Additional note to be saved with the benchmark results. Defaults to "".

    Returns:
    --------
    None
    """</span>
    rmse <span class="token operator">=</span> root_mean_squared_error<span class="token punctuation">(</span>y_true<span class="token punctuation">,</span> y_pred<span class="token punctuation">)</span>
    r2 <span class="token operator">=</span> r2_score<span class="token punctuation">(</span>y_true<span class="token punctuation">,</span> y_pred<span class="token punctuation">)</span>

    n <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>y_true<span class="token punctuation">)</span>
    k <span class="token operator">=</span> num_features <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment"># number of features + intercept</span>
    rss <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y_true <span class="token operator">-</span> y_pred<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>

    aic <span class="token operator">=</span> n <span class="token operator">*</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>rss <span class="token operator">/</span> n<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> k
    bic <span class="token operator">=</span> n <span class="token operator">*</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>rss <span class="token operator">/</span> n<span class="token punctuation">)</span> <span class="token operator">+</span> k <span class="token operator">*</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    adjusted_r2 <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> r2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    mape <span class="token operator">=</span> mean_absolute_percentage_error<span class="token punctuation">(</span>y_true<span class="token punctuation">,</span> y_pred<span class="token punctuation">)</span>
    mae <span class="token operator">=</span> mean_absolute_error<span class="token punctuation">(</span>y_true<span class="token punctuation">,</span> y_pred<span class="token punctuation">)</span>
    explained_variance <span class="token operator">=</span> explained_variance_score<span class="token punctuation">(</span>y_true<span class="token punctuation">,</span> y_pred<span class="token punctuation">)</span>

    benchmark_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
            <span class="token string">"rmse"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>rmse<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"r2"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>r2<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"aic"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>aic<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"bic"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>bic<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"adjusted_r2"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>adjusted_r2<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"mape"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>mape<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"mae"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>mae<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"explained_variance"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>explained_variance<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"train_time(second)"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>train_time<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"model_name"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>model_name<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"note"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>note<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    Path<span class="token punctuation">(</span>benchmark_path<span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        exist_benchmark <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>benchmark_path<span class="token punctuation">)</span>
    <span class="token keyword keyword-except">except</span> pd<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>EmptyDataError<span class="token punctuation">:</span>
        exist_benchmark <span class="token operator">=</span> <span class="token boolean">None</span>
    benchmark_df <span class="token operator">=</span> <span class="token punctuation">(</span>
        benchmark_df
        <span class="token keyword keyword-if">if</span> exist_benchmark <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span>
        <span class="token keyword keyword-else">else</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>exist_benchmark<span class="token punctuation">,</span> benchmark_df<span class="token punctuation">]</span><span class="token punctuation">,</span> ignore_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    benchmark_df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>benchmark_path<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>


<span class="token keyword keyword-def">def</span> <span class="token function">preprocess_data</span><span class="token punctuation">(</span>
    data<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> standard_scale<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> columns_to_drop<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Preprocesses the input data by optionally dropping specified columns and applying standard scaling.

    Parameters:
    ----------
    - data (pd.DataFrame): The input data to preprocess.
    - standard_scale (bool): Whether to apply standard scaling to the data. Default is True.
    - columns_to_drop (list[str]): List of column names to drop from the data. Default is ["id"].

    Returns:
    --------
    pd.DataFrame: The preprocessed data.

    Note:
    -----
    If you apply standard scaling, the fitted scaler will be saved in a .joblib file.
    """</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> columns_to_drop <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span>columns_to_drop<span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> standard_scale<span class="token punctuation">:</span>
        std_scaler <span class="token operator">=</span> StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>
            std_scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> columns<span class="token operator">=</span>data<span class="token punctuation">.</span>columns<span class="token punctuation">,</span> index<span class="token operator">=</span>data<span class="token punctuation">.</span>index
        <span class="token punctuation">)</span>
        dump<span class="token punctuation">(</span>std_scaler<span class="token punctuation">,</span> <span class="token string">"standard_scaler.joblib"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> data
</code></pre><p>2 hàm trợ giúp <code>train_default_models</code> và <code>fine_tune_models</code> có tác dụng nhận vào các tham số của model family và thực hiện train. Vì việc ta cần thực hiện như nhau, dữ liệu sử dụng cũng như nhau, chỉ khác tham số truyền vào, nên ta có thể tách riêng ra từng family model và viết các tham số cần thiết ở đầu file đó. Điều này giúp ta có thể sửa 1 chỗ cần sửa duy nhất, khi các tham số cần thiết thay đổi. Trong 2 hàm này có sử dụng hàm <code>benchmark_model()</code> để đánh giá mô hình và lưu kết quả vào 1 file csv.</p>
<p>Đây là ví dụ của cách viết của mô hình Linear:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-import">import</span> os
<span class="token keyword keyword-from">from</span> typing <span class="token keyword keyword-import">import</span> Any

<span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd

<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword keyword-import">import</span> LinearRegression<span class="token punctuation">,</span> Ridge<span class="token punctuation">,</span> Lasso<span class="token punctuation">,</span> ElasticNet
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>linear_model<span class="token punctuation">.</span>_base <span class="token keyword keyword-import">import</span> LinearModel

<span class="token keyword keyword-from">from</span> constants <span class="token keyword keyword-import">import</span> TRAIN_PATH<span class="token punctuation">,</span> TARGET_COLUMN<span class="token punctuation">,</span> BENCHMARK_DIRPATH
<span class="token keyword keyword-from">from</span> utils <span class="token keyword keyword-import">import</span> train_default_models<span class="token punctuation">,</span> fine_tune_models<span class="token punctuation">,</span> preprocess_data

BENCHMARK_PATH <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BENCHMARK_DIRPATH<span class="token punctuation">,</span> <span class="token string">"linear_benchmark.csv"</span><span class="token punctuation">)</span>
MODEL_DICT<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> LinearModel<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"Linear Regression"</span><span class="token punctuation">:</span> LinearRegression<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"Lasso"</span><span class="token punctuation">:</span> Lasso<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"Ridge"</span><span class="token punctuation">:</span> Ridge<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"Elastic Net"</span><span class="token punctuation">:</span> ElasticNet<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
FINE_TUNE_DICT<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">[</span>Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"Lasso"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"alpha"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"Ridge"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"alpha"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"Elastic Net"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"alpha"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"l1_ratio"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>


<span class="token keyword keyword-def">def</span> <span class="token function">train_linear_models</span><span class="token punctuation">(</span>
    X<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> y<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">,</span> default<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> fine_tune<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-if">if</span> default <span class="token keyword keyword-or">or</span> fine_tune<span class="token punctuation">:</span>
        Path<span class="token punctuation">(</span>BENCHMARK_PATH<span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token comment"># Clear all content in the benchmark file</span>
        <span class="token keyword keyword-with">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>BENCHMARK_PATH<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-pass">pass</span>
    <span class="token keyword keyword-if">if</span> default<span class="token punctuation">:</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Train linear models using default parameters"</span><span class="token punctuation">)</span>
        train_default_models<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">,</span> model_dict<span class="token operator">=</span>MODEL_DICT<span class="token punctuation">,</span> benchmark_path<span class="token operator">=</span>BENCHMARK_PATH<span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> fine_tune<span class="token punctuation">:</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Fine tune linear models"</span><span class="token punctuation">)</span>
        fine_tune_models<span class="token punctuation">(</span>
            X<span class="token punctuation">,</span>
            y<span class="token punctuation">,</span>
            finetune_dict<span class="token operator">=</span>FINE_TUNE_DICT<span class="token punctuation">,</span>
            model_dict<span class="token operator">=</span>MODEL_DICT<span class="token punctuation">,</span>
            benchmark_path<span class="token operator">=</span>BENCHMARK_PATH<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"See the benchmark of linear models at </span><span class="token interpolation"><span class="token punctuation">{</span>BENCHMARK_PATH<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


<span class="token keyword keyword-if">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>TRAIN_PATH<span class="token punctuation">)</span>
    data <span class="token operator">=</span> preprocess_data<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    X <span class="token operator">=</span> data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>TARGET_COLUMN<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    y <span class="token operator">=</span> data<span class="token punctuation">[</span>TARGET_COLUMN<span class="token punctuation">]</span>
    train_linear_models<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>

</code></pre><p>Ở đây, chúng em sử dụng 4 lớp mô hình: Linear, Tree-based, SVM, Ensemble. Mỗi lớp được đưa vào file riêng. Ở đây, em cố tình viết riêng hàm train cho từng model family, tuy chúng vẫn có cùng interface:</p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token keyword keyword-type">type</span> TrainingInterface <span class="token keyword keyword-interface">interface</span> <span class="token punctuation">{</span>
  X<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span>
  y<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">,</span>
  <span class="token keyword keyword-default">default</span><span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> True<span class="token punctuation">,</span>
  fine_tune<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> True
<span class="token punctuation">}</span>
</code></pre><p>Điều này là vì tuy interface giống nhau, và có thể sử dụng chung các hàm trợ giúp, bản chất chức năng các hàm này có thể thay đổi, và vì thế chúng ta không nên tạo thêm 1 hàm utility mới, mà nên viết riêng ra từ đầu.</p>
<hr>
<h1 id="iv-model-evalution">IV. Model Evalution </h1>
<p>Quá trình fine tune, vì mô hình svm và ensemble có thời gian train quá lâu, nhóm chỉ có thể sử dụng tham số mặc định, tuy vậy, việc sử dụng tham số đã fine tune đã được giải thích ở trong thư mục <a href="./train/">train/</a><br>
Sau khi thực hiện fine tune, chạy script <a href="./train/evaluate.py">evaluate.py</a> sẽ tự động lưu đánh giá và lưu các mô hình đã fine tune lại:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-import">import</span> os
<span class="token keyword keyword-from">from</span> pathlib <span class="token keyword keyword-import">import</span> Path
<span class="token keyword keyword-from">from</span> typing <span class="token keyword keyword-import">import</span> Any

<span class="token keyword keyword-import">import</span> joblib
<span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd

<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>svm <span class="token keyword keyword-import">import</span> SVR
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword keyword-import">import</span> Ridge
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>tree <span class="token keyword keyword-import">import</span> DecisionTreeRegressor
<span class="token keyword keyword-from">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword keyword-import">import</span> ExtraTreesRegressor

<span class="token keyword keyword-from">from</span> constants <span class="token keyword keyword-import">import</span> TEST_PATH<span class="token punctuation">,</span> TARGET_COLUMN<span class="token punctuation">,</span> BENCHMARK_DIRPATH
<span class="token keyword keyword-from">from</span> utils <span class="token keyword keyword-import">import</span> train_default_models

MODEL_DICT<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"Ridge"</span><span class="token punctuation">:</span> Ridge<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"Tree"</span><span class="token punctuation">:</span> DecisionTreeRegressor<span class="token punctuation">(</span>
        criterion<span class="token operator">=</span><span class="token string">'poisson'</span><span class="token punctuation">,</span>
        max_depth<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
        max_features<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        max_leaf_nodes<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
        min_impurity_decrease<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span>
        min_samples_leaf<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
        min_samples_split<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
        min_weight_fraction_leaf<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span>
        splitter<span class="token operator">=</span><span class="token string">'best'</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"Rbf"</span><span class="token punctuation">:</span> SVR<span class="token punctuation">(</span>kernel<span class="token operator">=</span><span class="token string">"rbf"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"Extra Tree"</span><span class="token punctuation">:</span> ExtraTreesRegressor<span class="token punctuation">(</span>n_jobs<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
BENCHMARK_PATH <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BENCHMARK_DIRPATH<span class="token punctuation">,</span> <span class="token string">"evaluate.csv"</span><span class="token punctuation">)</span>
MODEL_DIRPATH <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"models"</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">evaluate_models</span><span class="token punctuation">(</span>
    X<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> y<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    Path<span class="token punctuation">(</span>BENCHMARK_PATH<span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># Clear all content in the benchmark file</span>
    <span class="token keyword keyword-with">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>BENCHMARK_PATH<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-pass">pass</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Evaluate models using the fine tuned parameters."</span><span class="token punctuation">)</span>
    train_default_models<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">,</span> model_dict<span class="token operator">=</span>MODEL_DICT<span class="token punctuation">,</span> benchmark_path<span class="token operator">=</span>BENCHMARK_PATH<span class="token punctuation">)</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"See the evaluation results at </span><span class="token interpolation"><span class="token punctuation">{</span>BENCHMARK_PATH<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">save_models</span><span class="token punctuation">(</span>X<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">,</span> y<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">)</span><span class="token punctuation">:</span>
    Path<span class="token punctuation">(</span>MODEL_DIRPATH<span class="token punctuation">)</span><span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> model_name<span class="token punctuation">,</span> model <span class="token keyword keyword-in">in</span> MODEL_DICT<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
        model_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>MODEL_DIRPATH<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>model_name<span class="token punctuation">}</span></span><span class="token string">.joblib"</span></span><span class="token punctuation">)</span>
        joblib<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>model<span class="token punctuation">,</span> model_path<span class="token punctuation">)</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Models are saved at </span><span class="token interpolation"><span class="token punctuation">{</span>MODEL_DIRPATH<span class="token punctuation">}</span></span><span class="token string">."</span></span><span class="token punctuation">)</span>

<span class="token keyword keyword-if">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>TEST_PATH<span class="token punctuation">)</span>
    X <span class="token operator">=</span> data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>TARGET_COLUMN<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    y <span class="token operator">=</span> data<span class="token punctuation">[</span>TARGET_COLUMN<span class="token punctuation">]</span>
    evaluate_models<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
    save_models<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>

</code></pre><p>Trong file này, ta sử dụng cách viết y hệt như cách viết các lớp mô hình kia.</p>
<p>Tuy vậy, vì việc lựa chọn metric để đánh giá xem mô hình nào là tốt nhất đòi hỏi có sự đánh giá của con người, ta cần phải nhập lại tham số của mô hình mà ta cho là tốt nhất trong từng lớp mô hình vào file này để chạy lại. Để có thông tin các tham số này, ta cần chạy file <a href="./train/train.py">train.py</a>, và đọc kết quả đã lưu lại trong thư mục <a href="./train/benchmark/">bennchmark</a>, sau đó nhập thông tin của mô hình dưới dạng dictionary của Python.</p>
<h2 id="giải-thích-các-metric">Giải thích các metric </h2>
<ol>
<li>
<p><strong>Root Mean Squared Error (RMSE)</strong>:</p>
<ul>
<li><strong>Định nghĩa</strong>: RMSE là căn bậc hai của trung bình bình phương sai số giữa giá trị dự đoán và giá trị thực tế.</li>
<li><strong>Công thức</strong>:<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>RMSE</mtext><mo>=</mo><msqrt><mrow><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>−</mo><msub><mover accent="true"><mi>y</mi><mo>^</mo></mover><mi>i</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">\text{RMSE} = \sqrt{\frac{1}{n} \sum_{i=1}^{n} (y_i - \hat{y}_i)^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">RMSE</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.1568em;vertical-align:-1.2777em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8791em;"><span class="svg-align" style="top:-5.1168em;"><span class="pstrut" style="height:5.1168em;"></span><span class="mord" style="padding-left:1.056em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.8391em;"><span class="pstrut" style="height:5.1168em;"></span><span class="hide-tail" style="min-width:0.742em;height:3.1968em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="3.1968em" viewBox="0 0 400000 3196" preserveAspectRatio="xMinYMin slice"><path d="M702 80H40000040
H742v3062l-4 4-4 4c-.667.7 -2 1.5-4 2.5s-4.167 1.833-6.5 2.5-5.5 1-9.5 1
h-12l-28-84c-16.667-52-96.667 -294.333-240-727l-212 -643 -85 170
c-4-3.333-8.333-7.667-13 -13l-13-13l77-155 77-156c66 199.333 139 419.667
219 661 l218 661zM702 80H400000v40H742z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span></span></span></span></span></li>
<li><strong>Diễn giải</strong>: RMSE càng thấp thì mô hình càng tốt. RMSE nhạy cảm với các giá trị ngoại lai.</li>
</ul>
</li>
<li>
<p><strong>R-squared (R²)</strong>:</p>
<ul>
<li><strong>Định nghĩa</strong>: R² đo lường tỷ lệ phương sai của biến phụ thuộc có thể được giải thích bởi các biến độc lập.</li>
<li><strong>Công thức</strong>:<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>R</mi><mn>2</mn></msup><mo>=</mo><mn>1</mn><mo>−</mo><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>−</mo><msub><mover accent="true"><mi>y</mi><mo>^</mo></mover><mi>i</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>−</mo><mover accent="true"><mi>y</mi><mo>ˉ</mo></mover><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">R^2 = 1 - \frac{\sum_{i=1}^{n} (y_i - \hat{y}_i)^2}{\sum_{i=1}^{n} (y_i - \bar{y})^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.4978em;vertical-align:-0.994em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5038em;"><span style="top:-2.3057em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.6897em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.994em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></li>
<li><strong>Diễn giải</strong>: R² dao động từ 0 đến 1. Giá trị R² càng cao thì mô hình càng tốt.</li>
</ul>
</li>
<li>
<p><strong>Akaike Information Criterion (AIC)</strong>:</p>
<ul>
<li><strong>Định nghĩa</strong>: AIC ước tính chất lượng của mỗi mô hình so với các mô hình khác.</li>
<li><strong>Công thức</strong>:<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>AIC</mtext><mo>=</mo><mi>n</mi><mo>⋅</mo><mi>ln</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mtext>RSS</mtext><mi>n</mi></mfrac><mo fence="true">)</mo></mrow><mo>+</mo><mn>2</mn><mi>k</mi></mrow><annotation encoding="application/x-tex">\text{AIC} = n \cdot \ln\left(\frac{\text{RSS}}{n}\right) + 2k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">AIC</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mop">ln</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">RSS</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span></li>
<li><strong>Diễn giải</strong>: Giá trị AIC càng thấp thì mô hình càng tốt. AIC phạt các mô hình có nhiều tham số hơn.</li>
</ul>
</li>
<li>
<p><strong>Bayesian Information Criterion (BIC)</strong>:</p>
<ul>
<li><strong>Định nghĩa</strong>: BIC tương tự như AIC nhưng với mức phạt mạnh hơn cho các mô hình có nhiều tham số.</li>
<li><strong>Công thức</strong>:<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>BIC</mtext><mo>=</mo><mi>n</mi><mo>⋅</mo><mi>ln</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mtext>RSS</mtext><mi>n</mi></mfrac><mo fence="true">)</mo></mrow><mo>+</mo><mi>k</mi><mo>⋅</mo><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{BIC} = n \cdot \ln\left(\frac{\text{RSS}}{n}\right) + k \cdot \ln(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">BIC</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mop">ln</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">RSS</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span></li>
<li><strong>Diễn giải</strong>: Giá trị BIC càng thấp thì mô hình càng tốt.</li>
</ul>
</li>
<li>
<p><strong>Adjusted R-squared</strong>:</p>
<ul>
<li><strong>Định nghĩa</strong>: Adjusted R² điều chỉnh giá trị R² dựa trên số lượng biến độc lập trong mô hình.</li>
<li><strong>Công thức</strong>:<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Adjusted&nbsp;</mtext><msup><mi>R</mi><mn>2</mn></msup><mo>=</mo><mn>1</mn><mo>−</mo><mrow><mo fence="true">(</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msup><mi>R</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><mrow><mi>n</mi><mo>−</mo><mi>k</mi><mo>−</mo><mn>1</mn></mrow></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\text{Adjusted } R^2 = 1 - \left( \frac{(1 - R^2)(n - 1)}{n - k - 1} \right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0585em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Adjusted&nbsp;</span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.4411em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></li>
<li><strong>Diễn giải</strong>: Giá trị Adjusted R² càng cao thì mô hình càng tốt, có tính đến số lượng biến độc lập.</li>
</ul>
</li>
<li>
<p><strong>Mean Absolute Percentage Error (MAPE)</strong>:</p>
<ul>
<li><strong>Định nghĩa</strong>: MAPE đo lường độ chính xác của mô hình dưới dạng phần trăm.</li>
<li><strong>Công thức</strong>:<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>MAPE</mtext><mo>=</mo><mfrac><mn>100</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mrow><mo fence="true">∣</mo><mfrac><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>−</mo><msub><mover accent="true"><mi>y</mi><mo>^</mo></mover><mi>i</mi></msub></mrow><msub><mi>y</mi><mi>i</mi></msub></mfrac><mo fence="true">∣</mo></mrow></mrow><annotation encoding="application/x-tex">\text{MAPE} = \frac{100}{n} \sum_{i=1}^{n} \left| \frac{y_i - \hat{y}_i}{y_i} \right|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">MAPE</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">100</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.45em;"><span class="pstrut" style="height:4.4em;"></span><span style="width:0.333em;height:2.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.333em" height="2.400em" viewBox="0 0 333 2400"><path d="M145 15 v585 v1200 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v-1200 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M188 15 H145 v585 v1200 v585 h43z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.45em;"><span class="pstrut" style="height:4.4em;"></span><span style="width:0.333em;height:2.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.333em" height="2.400em" viewBox="0 0 333 2400"><path d="M145 15 v585 v1200 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v-1200 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M188 15 H145 v585 v1200 v585 h43z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span></span></span></span></span></li>
<li><strong>Diễn giải</strong>: Giá trị MAPE càng thấp thì mô hình càng tốt.</li>
</ul>
</li>
<li>
<p><strong>Mean Absolute Error (MAE)</strong>:</p>
<ul>
<li><strong>Định nghĩa</strong>: MAE là trung bình của các sai số tuyệt đối giữa giá trị dự đoán và giá trị thực tế.</li>
<li><strong>Công thức</strong>:<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>MAE</mtext><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mrow><mo fence="true">∣</mo><msub><mi>y</mi><mi>i</mi></msub><mo>−</mo><msub><mover accent="true"><mi>y</mi><mo>^</mo></mover><mi>i</mi></msub><mo fence="true">∣</mo></mrow></mrow><annotation encoding="application/x-tex">\text{MAE} = \frac{1}{n} \sum_{i=1}^{n} \left| y_i - \hat{y}_i \right|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">MAE</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">∣</span></span></span></span></span></span></li>
<li><strong>Diễn giải</strong>: Giá trị MAE càng thấp thì mô hình càng tốt.</li>
</ul>
</li>
<li>
<p><strong>Explained Variance</strong>:</p>
<ul>
<li><strong>Định nghĩa</strong>: Explained variance đo lường tỷ lệ phương sai của biến phụ thuộc có thể được giải thích bởi các biến độc lập.</li>
<li><strong>Công thức</strong>:<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Explained&nbsp;Variance</mtext><mo>=</mo><mn>1</mn><mo>−</mo><mfrac><mrow><mtext>Var</mtext><mo stretchy="false">(</mo><mi>y</mi><mo>−</mo><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo stretchy="false">)</mo></mrow><mrow><mtext>Var</mtext><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{Explained Variance} = 1 - \frac{\text{Var}(y - \hat{y})}{\text{Var}(y)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Explained&nbsp;Variance</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">Var</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">Var</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></li>
<li><strong>Diễn giải</strong>: Giá trị Explained variance càng cao thì mô hình càng tốt.</li>
</ul>
</li>
</ol>
<h2 id="kết-quả">Kết quả </h2>
<p>Dưới đây là kết quả đánh giá trên tập test.</p>
<table>
<thead>
<tr>
<th>model_name</th>
<th>rmse</th>
<th>r2</th>
<th>aic</th>
<th>bic</th>
<th>adjusted_r2</th>
<th>mape</th>
<th>mae</th>
<th>explained_variance</th>
<th>train_time(second)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ridge</td>
<td>1.985795338722654</td>
<td>0.4538807588816463</td>
<td>1619.1695323956956</td>
<td>1664.7292570862746</td>
<td>0.4496326403249782</td>
<td>11628232236659.03</td>
<td>1.4810561416941677</td>
<td>0.4538807588816463</td>
<td>0.0014252662658691</td>
</tr>
<tr>
<td>Tree</td>
<td>1.6746113529910678</td>
<td>0.6116292027877468</td>
<td>1221.366311415272</td>
<td>1266.926036105851</td>
<td>0.6086081680644017</td>
<td>16928697828121.854</td>
<td>1.2085530462736964</td>
<td>0.6116292027877468</td>
<td>0.0038893222808837</td>
</tr>
<tr>
<td>Rbf</td>
<td>2.67829685309823</td>
<td>0.0065730757188575</td>
<td>2317.4126638969083</td>
<td>2362.972388587488</td>
<td>-0.0011545321623267</td>
<td>17394499472919.572</td>
<td>2.0950120275727344</td>
<td>0.0065734179528859</td>
<td>0.0489087104797363</td>
</tr>
<tr>
<td>Extra Tree</td>
<td>6.658766113998042e-15</td>
<td>1.0</td>
<td>-76170.39368474306</td>
<td>-76124.83396005248</td>
<td>1.0</td>
<td>9.853109095779605e-16</td>
<td>4.4529147578611235e-15</td>
<td>1.0</td>
<td>0.07291269302368164</td>
</tr>
</tbody>
</table>
<p>Phân tích kết quả các mô hình:</p>
<ul>
<li>Ridge Regression: Mô hình Ridge cho hiệu suất trung bình với R2 = 0.45, có nghĩa là nó giải thích được 45% biến thiên trong dữ liệu. RMSE là 1.99 và MAE là 1.48 cho thấy độ lệch dự đoán trung bình. Thời gian huấn luyện rất nhanh (0.001s), phù hợp cho các ứng dụng thời gian thực.</li>
<li>Decision Tree: Cây quyết định thể hiện hiệu suất khá tốt với R2 = 0.61, giải thích được 61% biến thiên. RMSE (1.67) và MAE (1.21) thấp hơn so với Ridge, cho thấy độ chính xác dự đoán tốt hơn. Thời gian huấn luyện vẫn rất nhanh (0.004s).</li>
<li>SVM với kernel RBF: Mô hình RBF cho kết quả kém nhất với R2 gần như bằng 0 (0.0066), cho thấy mô hình hầu như không học được gì từ dữ liệu. RMSE (2.68) và MAE (2.09) cao nhất trong các mô hình. Thời gian huấn luyện cũng chậm hơn (0.049s).</li>
<li>Extra Tree: Extra Tree cho kết quả hoàn hảo với R2 = 1.0 và RMSE gần như bằng 0.</li>
</ul>
<p>Xét tất cả các metric, ta nhận thấy Extra Tree Regressor là mô hình tốt nhất.</p>
<hr>
<h1 id="v-conclusion">V. Conclusion </h1>
<p>Từ project này, ta nhận thấy khả năng áp dụng của Python vào Web Scraping, Data Processing, Model Training. Quá trình phân tích và so sánh nhiều mô hình cho thấy mô hình Extra Tree Regressor có kết quả tốt nhất trên tất cả các metric. Từ đây, ta thấy sự hiệu quả của các thuật toán học máy nâng cao đối với bài toán dự đoán giá nhà. Tóm lại, Python là một ngôn ngữ mạnh mẽ, phục vụ rất tốt các tác vụ liên quan đến dự án khoa học dữ liệu.</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>